# Implementation Plan: Migrate SearchBox to Redux State Management

**Branch**: `006-searchbox-redux-migration` | **Date**: 2025-10-20 | **Spec**: [spec-2025-10-20-000000.md](../specs/spec-2025-10-20-000000.md)

**Input**: Feature specification from `specs/spec-2025-10-20-000000.md`

## Execution Flow (/plan command scope)
```
1. Load feature spec from Input path ✓
2. Fill Technical Context ✓
   → Project Type: web (frontend + backend) ✓
   → Structure Decision: Option 2 (Web application) ✓
3. Fill Constitution Check section ✓
   → No constitution file found - using best practices
4. Evaluate Constitution Check section ✓
   → No violations detected
5. Execute Phase 0 → research.md ✓
   → All technical details clear from existing codebase
6. Execute Phase 1 → contracts, data-model.md, quickstart.md ✓
7. Re-evaluate Constitution Check section ✓
   → No new violations
8. Plan Phase 2 → Task generation approach described ✓
9. STOP - Ready for /tasks command ✓
```

## Summary

Migrate SearchBox component from local React state management to centralized Redux state management. This refactoring eliminates the third independent state management system (local state in SearchBox), consolidates all filter state in Redux, improves fuzzy search reliability by eliminating state synchronization issues, and enables complete visibility of filter operations in Redux DevTools.

**Technical Approach**: Remove useState hooks from SearchBox.js and SearchModal.js, replace with useSelector/useDispatch hooks to read from and update Redux filter state, leverage existing filtersSlice.js actions (toggleSubjectFilter, setSearchQuery, etc.), ensure URL synchronization middleware continues to work seamlessly.

## Technical Context

**Language/Version**: JavaScript ES6+ / React 18 / Node.js 18+
**Primary Dependencies**: Redux Toolkit 1.9+, React-Redux 8.0+, Material-UI 5.x, React Router 6.x
**Storage**: Redux store (in-memory), URL parameters (via middleware), browser sessionStorage (future enhancement)
**Testing**: Jest 29+, React Testing Library, Redux mock store
**Target Platform**: Modern browsers (Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)
**Project Type**: Web application (React frontend + Django backend)
**Performance Goals**:
  - Filter state update < 50ms (95th percentile)
  - SearchBox render time increase < 5ms
  - Handle > 10 filter changes per second
**Constraints**:
  - Zero breaking changes to existing search UX
  - Must maintain all current search functionality
  - Backward compatible with existing URL parameter format
**Scale/Scope**:
  - 3 core components to modify (SearchBox, SearchModal, SearchResults)
  - 1 Redux slice (filtersSlice - already exists)
  - ~15 functional requirements
  - 4 non-functional requirements

## Constitution Check

*No constitution.md file found. Using industry best practices and TDD principles from CLAUDE.md.*

**Applicable Principles**:
- ✅ Test-Driven Development (RED-GREEN-REFACTOR cycle)
- ✅ Single Source of Truth (Redux store for all filter state)
- ✅ Component Simplicity (remove local state management)
- ✅ Separation of Concerns (UI components read from Redux, don't manage state)
- ✅ Performance First (< 50ms response time requirement)

**No Constitution Violations Detected**

## Project Structure

### Documentation (this feature)
```
specs/spec-2025-10-20-000000/
├── plan.md              # This file (/plan command output)
├── research.md          # Phase 0 output (/plan command)
├── data-model.md        # Phase 1 output (/plan command)
├── quickstart.md        # Phase 1 output (/plan command)
└── tasks.md             # Phase 2 output (/tasks command - NOT created by /plan)
```

### Source Code (repository root)
```
# Web application structure (Admin3 project)
frontend/react-Admin3/
├── src/
│   ├── components/
│   │   ├── SearchBox.js                    # MODIFY: Remove local state, use Redux
│   │   ├── SearchResults.js                # MODIFY: May need Redux selectors
│   │   └── Navigation/
│   │       └── SearchModal.js              # MODIFY: Remove local state, use Redux
│   │
│   ├── store/
│   │   ├── index.js                        # VERIFY: Redux store setup
│   │   ├── slices/
│   │   │   └── filtersSlice.js            # MODIFY: Add variations filter if needed
│   │   └── middleware/
│   │       └── urlSyncMiddleware.js        # VERIFY: URL sync continues working
│   │
│   └── __tests__/
│       ├── SearchBox.test.js              # MODIFY: Update for Redux
│       ├── SearchModal.test.js            # MODIFY: Update for Redux
│       └── filtersSlice.test.js           # ADD: Tests for new actions

backend/django_Admin3/
└── (No backend changes required)
```

**Structure Decision**: Option 2 - Web application (frontend/backend separation already in place)

## Phase 0: Outline & Research

### Current State Analysis

**SearchBox.js Current Implementation**:
- Lines 14-19: Local state for `selectedFilters` (subjects, product_groups, variations, products)
- Lines 95-134: Filter management functions (handleFilterSelect, removeFilter, clearAllFilters)
- Lines 149-245: UI rendering with local state binding

**SearchModal.js Current Implementation**:
- Lines 32-37: Duplicate local state for `selectedFilters`
- Lines 130-157: handleShowMatchingProducts uses Redux dispatch but only for subjects
- Lines 96-126: Filter selection handlers managing local state

**filtersSlice.js Existing Infrastructure**:
- Lines 10-44: Complete Redux state structure (subjects, categories, product_types, products, modes_of_delivery, searchQuery)
- Lines 102-160: Toggle actions for all filter types
- Lines 51-85: Setter actions for all filter types
- Lines 408-441: Comprehensive selectors

**Key Finding**: Redux infrastructure is already comprehensive. Missing piece: `variations` filter type.

### Research Findings

**Decision 1: Handle `variations` Filter Type**
- **Decision**: Map `variations` to `product_types` in Redux
- **Rationale**: Variations represent product type variations (Printed, eBook, Online). Product types already exist in Redux as `product_types`. Simplifies state management.
- **Alternatives considered**:
  - Add new `variations` array to Redux state (more complex, creates redundancy)
  - Store as custom metadata (harder to filter/query)

**Decision 2: Filter State Reuse vs. Separate Search State**
- **Decision**: Reuse main Redux filter state (Option A from story document)
- **Rationale**: Single source of truth, simpler state management, no sync logic needed, consistent with existing architecture
- **Alternatives considered**:
  - Separate `searchFilters` state (requires sync logic, more complex)
  - Temporary staging state (UX confusion, inconsistent behavior)

**Decision 3: SearchResults Component Integration**
- **Decision**: Update SearchResults to read from Redux selectors
- **Rationale**: Eliminate prop drilling, consistent data source, easier testing
- **Alternatives considered**:
  - Keep prop-based (increases coupling, harder to maintain)

**Decision 4: URL Synchronization**
- **Decision**: Leverage existing urlSyncMiddleware (no changes needed)
- **Rationale**: Middleware already handles Redux → URL sync automatically
- **Verification**: Confirmed in `frontend/react-Admin3/src/store/middleware/urlSyncMiddleware.js`

## Phase 1: Design & Contracts

### Data Model

See: `plans/spec-2025-10-20-000000/data-model.md`

**Redux State Structure** (No changes to existing structure):
```javascript
filters: {
  subjects: [],              // Array of subject codes (e.g., ['CM2', 'SA1'])
  categories: [],            // Array of category codes
  product_types: [],         // Array of product type codes (maps to variations)
  products: [],              // Array of product IDs
  modes_of_delivery: [],     // Array of delivery mode codes
  searchQuery: '',           // Search query string
  currentPage: 1,
  pageSize: 20,
  isFilterPanelOpen: false,
  isLoading: false,
  error: null,
  filterCounts: {},
  lastUpdated: null
}
```

**Mapping**:
- `selectedFilters.subjects` → `filters.subjects` (existing)
- `selectedFilters.product_groups` → `filters.product_types` (existing)
- `selectedFilters.variations` → `filters.product_types` (existing)
- `selectedFilters.products` → `filters.products` (existing)
- `searchQuery` → `filters.searchQuery` (existing)

### Component Contracts

#### SearchBox Component

**Before (Local State)**:
```javascript
Props:
  - onSearchResults: function (callback)
  - onShowMatchingProducts: function (callback)
  - placeholder: string
  - autoFocus: boolean

Local State:
  - searchQuery: string
  - selectedFilters: { subjects, product_groups, variations, products }
  - loading: boolean
  - error: string
  - searchResults: object

Behavior:
  - Manages own filter selections
  - Dispatches callbacks with filter data
```

**After (Redux State)**:
```javascript
Props:
  - onSearchResults: function (callback)
  - onShowMatchingProducts: function (callback)
  - placeholder: string
  - autoFocus: boolean

Redux Selectors:
  - filters = useSelector(selectFilters)
  - searchQuery = useSelector(selectSearchQuery)

Redux Actions:
  - dispatch(setSearchQuery(query))
  - dispatch(toggleSubjectFilter(subject))
  - dispatch(toggleProductTypeFilter(type))
  - dispatch(toggleProductFilter(product))

Local State (UI only):
  - loading: boolean (search API call status)
  - error: string (search API error)
  - searchResults: object (API response cache)

Behavior:
  - Reads filter selections from Redux
  - Dispatches Redux actions on filter changes
  - URL sync automatic via middleware
```

#### SearchModal Component

**Before**:
```javascript
Props:
  - open: boolean
  - onClose: function

Local State:
  - searchResults: object
  - searchQuery: string
  - selectedFilters: { subjects, product_groups, variations, products }
  - searchLoading: boolean
  - searchError: string

Behavior:
  - Manages duplicate filter state
  - Passes filters as props to SearchBox/SearchResults
  - Manually dispatches to Redux on "Show Matching Products"
```

**After**:
```javascript
Props:
  - open: boolean
  - onClose: function

Redux Selectors:
  - filters = useSelector(selectFilters)
  - searchQuery = useSelector(selectSearchQuery)

Local State (UI only):
  - searchResults: object (API response cache)
  - searchLoading: boolean
  - searchError: string

Behavior:
  - Reads filter state from Redux
  - No local filter management
  - "Show Matching Products" just navigates (filters already in Redux)
```

#### SearchResults Component

**Before**:
```javascript
Props:
  - searchResults: object
  - searchQuery: string
  - selectedFilters: object
  - onFilterSelect: function
  - onFilterRemove: function
  - onShowMatchingProducts: function
  - isFilterSelected: function
  - loading: boolean
  - error: string

Behavior:
  - Receives all data via props (prop drilling)
```

**After**:
```javascript
Props:
  - searchResults: object
  - onFilterSelect: function
  - onFilterRemove: function
  - onShowMatchingProducts: function
  - loading: boolean
  - error: string

Redux Selectors:
  - searchQuery = useSelector(selectSearchQuery)
  - selectedFilters = useSelector(selectFilters)

Behavior:
  - Reads searchQuery and selectedFilters from Redux
  - Reduces prop drilling
```

### Integration Points

**1. SearchBox → Redux**:
- Import `useDispatch`, `useSelector` from 'react-redux'
- Import actions: `setSearchQuery`, `toggleSubjectFilter`, `toggleProductTypeFilter`, `toggleProductFilter`
- Import selectors: `selectFilters`, `selectSearchQuery`
- Replace `useState(selectedFilters)` with `useSelector(selectFilters)`
- Replace `setSearchQuery` with `dispatch(setSearchQuery(query))`
- Replace `handleFilterSelect` logic with Redux dispatches

**2. SearchModal → Redux**:
- Import `useSelector` from 'react-redux'
- Import selectors: `selectFilters`, `selectSearchQuery`
- Remove local `selectedFilters` and `searchQuery` state
- Remove `handleFilterSelect`, `handleFilterRemove` logic (delegated to SearchBox)
- Simplify `handleShowMatchingProducts` (filters already in Redux)

**3. SearchResults → Redux**:
- Import `useSelector` from 'react-redux'
- Import selectors: `selectFilters`, `selectSearchQuery`
- Remove `searchQuery` and `selectedFilters` from props
- Read from Redux selectors instead

**4. URL Sync Middleware**:
- No changes needed (already listens to Redux filter changes)
- Automatically updates URL when SearchBox dispatches actions

### Test Contracts

See: `plans/spec-2025-10-20-000000/contracts/` directory for detailed test specifications.

**Contract Test Categories**:

1. **SearchBox Component Tests** (`SearchBox.contract.test.js`):
   - Should display selected filters from Redux state
   - Should dispatch Redux action when filter checked
   - Should dispatch Redux action when filter unchecked
   - Should update Redux searchQuery on input change
   - Should persist filter selections across unmount/remount
   - Should handle rapid filter changes without race conditions

2. **SearchModal Integration Tests** (`SearchModal.contract.test.js`):
   - Should read filters from Redux on mount
   - Should navigate to products page with Redux filters applied
   - Should not clear Redux filters on modal close
   - Should re-display Redux filters on modal reopen

3. **Redux Slice Tests** (`filtersSlice.contract.test.js`):
   - Should toggle subject filter correctly
   - Should toggle product type filter correctly
   - Should set search query correctly
   - Should clear all filters correctly
   - Should maintain state consistency during rapid updates

4. **Performance Tests** (`searchBoxPerformance.test.js`):
   - Filter state update should complete in < 50ms (95th percentile)
   - SearchBox render time should increase by < 5ms
   - Should handle 10+ filter changes per second

### Quickstart Verification

See: `plans/spec-2025-10-20-000000/quickstart.md`

**User Workflow Verification**:
1. Open SearchModal (Ctrl+K)
2. Type search query "mock pack"
3. Select subject filter "CB1"
4. Close modal
5. Reopen modal
6. **Verify**: CB1 still selected, "mock pack" still in search box
7. Click "Show Matching Products"
8. **Verify**: Navigate to /products with CB1 and search query applied
9. **Verify**: Redux DevTools shows all actions (setSearchQuery, toggleSubjectFilter)

## Phase 2: Task Planning Approach

*This section describes what the /tasks command will do - DO NOT execute during /plan*

**Task Generation Strategy**:

1. **Load task template**: Read `.specify/templates/tasks-template.md`

2. **Generate contract test tasks** (RED phase):
   - Task: Write failing test for SearchBox Redux integration
   - Task: Write failing test for SearchModal Redux integration
   - Task: Write failing test for SearchResults Redux integration
   - Task: Write failing test for filter persistence across unmount
   - Task: Write failing performance tests

3. **Generate implementation tasks** (GREEN phase):
   - Task: Remove local state from SearchBox.js
   - Task: Add Redux useSelector/useDispatch to SearchBox.js
   - Task: Update handleFilterSelect to dispatch Redux actions
   - Task: Update search query input to dispatch setSearchQuery
   - Task: Remove local state from SearchModal.js
   - Task: Update SearchModal to read from Redux selectors
   - Task: Update SearchResults to use Redux selectors
   - Task: Verify URL sync middleware works with new dispatches

4. **Generate refactoring tasks** (REFACTOR phase):
   - Task: Remove unnecessary prop drilling
   - Task: Add React.memo if performance degradation detected
   - Task: Optimize Redux selectors with reselect

5. **Generate validation tasks**:
   - Task: Run all contract tests
   - Task: Execute quickstart.md verification
   - Task: Performance validation (50ms response time)
   - Task: Manual testing checklist

**Ordering Strategy**:
- TDD order: All contract tests first (RED), then implementation (GREEN), then refactor
- Dependency order:
  1. Tests first [P]
  2. Redux slice updates (if needed) [P]
  3. SearchBox component changes
  4. SearchModal component changes
  5. SearchResults component changes
  6. Integration verification
- Mark [P] for parallel execution where tests are independent

**Estimated Output**: 25-30 numbered, ordered tasks in tasks.md

**IMPORTANT**: This phase is executed by the /tasks command, NOT by /plan

## Phase 3+: Future Implementation

*These phases are beyond the scope of the /plan command*

**Phase 3**: Task execution (/tasks command creates tasks.md)
**Phase 4**: Implementation (execute tasks.md following TDD principles)
**Phase 5**: Validation (run tests, execute quickstart.md, performance validation)

## Complexity Tracking

*No complexity violations detected. All changes follow existing Redux patterns.*

| Aspect | Complexity | Justification |
|--------|------------|---------------|
| State Management | Redux Toolkit (standard) | Already in use, consistent pattern |
| Component Updates | 3 components | Minimal scope, clear boundaries |
| Testing Approach | TDD with contract tests | Standard practice, enforced by tdd-guard |
| Performance Impact | Negligible | Redux updates are synchronous, < 1ms overhead |

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - describe approach only)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS (no violations)
- [x] Post-Design Constitution Check: PASS (no new violations)
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none)

## Risk Assessment

### Risk 1: Material-UI Autocomplete + Redux Compatibility
**Probability**: Medium
**Impact**: High (could break search UI)
**Mitigation**:
- Extensive testing with controlled component pattern
- Use `value` prop + `onChange` handler bound to Redux
- Add key prop to force remount if needed
- Performance monitoring for unnecessary re-renders

### Risk 2: Filter State Persistence Issues
**Probability**: Low
**Impact**: Medium (confusing UX)
**Mitigation**:
- Explicit tests for unmount/remount scenarios
- Verify Redux state not cleared on modal close
- Monitor Redux DevTools during testing

### Risk 3: Performance Degradation
**Probability**: Low
**Impact**: Medium (poor UX)
**Mitigation**:
- Benchmark before/after with React DevTools Profiler
- Use memoized selectors (reselect)
- Add React.memo to SearchBox if needed
- Target: < 50ms filter update response time

### Risk 4: URL Sync Middleware Conflicts
**Probability**: Very Low
**Impact**: High (breaks filter sharing via URL)
**Mitigation**:
- Verify middleware continues working after changes
- Test URL parameter generation
- Test URL → Redux state restoration on page load

## Rollback Plan

If migration breaks search functionality:

1. **Immediate Rollback** (< 5 min):
   ```bash
   git revert <commit-hash>
   ```
   - SearchBox returns to local state management
   - Search functional but isolated from Redux

2. **Investigation** (15 min):
   - Check Redux DevTools for action dispatches
   - Check browser console for React errors
   - Verify Redux selectors return correct state
   - Test Autocomplete component behavior

3. **Fix Forward** (1 hour):
   - Fix Autocomplete integration if broken
   - Fix Redux action dispatches if incorrect
   - Add React.memo if performance issue
   - Re-test all contract tests

---

**Next Step**: Run `/tasks` command to generate detailed TDD task breakdown in `tasks.md`
