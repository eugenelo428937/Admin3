# Implementation Plan: Dynamic VAT Calculation System (Rules Engine-Based)

**Created:** 2025-10-06
**Based on:** specs/spec-2025-10-06-121922.md
**Feature Branch:** `003-vat-calculation-rules-engine`
**Status:** Ready for Implementation

## Executive Summary

This plan implements a **fully Rules Engine-driven VAT calculation system** with ZERO hardcoded Python logic. All VAT calculations are performed by configurable business rules that staff can modify through Django admin without code deployments.

### Key Architectural Principles

1. **Database-Driven VAT Rates**: VAT rates stored in `utils_countrys.vat_percent` (not hardcoded)
2. **Data Separation**: `utils_countrys` for VAT (mutable) vs `country_country` for users (immutable)
3. **Rules Engine Authority**: 100% of VAT logic in Rules Engine (zero Python calculation code)
4. **Composite Rule Pattern**: Master rule → Regional rules → Product-specific rules
5. **Cart Context Reuse**: Use existing `cart.items[].product_type` and `metadata` (no product_classifier)
6. **Per-Item Calculation**: Each cart item evaluated separately, then aggregated

---

## Architecture Overview

### Technology Stack

- **Backend:** Django 5.1 + Django REST Framework + PostgreSQL
- **Frontend:** React 18 + Material-UI (for VAT display updates)
- **Rules Engine:** ActedRule infrastructure with JSONLogic
- **Database:** PostgreSQL with JSONB for audit storage
- **Decimal Precision:** Python Decimal with ROUND_HALF_UP for all monetary calculations

### Data Models Architecture

```
┌─────────────────┐
│ utils_regions   │ ← Master VAT regions (UK, IE, EU, SA, ROW)
└────────┬────────┘
         │
         │ ┌──────────────────┐
         └→│utils_country_region│ ← Country-to-region mapping with effective dates
           └─────────┬──────────┘
                     │
                     │ ┌─────────────────┐
                     └→│ utils_countrys  │ ← VAT-specific country data with vat_percent
                       └─────────────────┘

┌─────────────────┐
│ country_country │ ← User account country data (UNCHANGED - no VAT logic)
└─────────────────┘
```

### VAT Calculation Flow

```
Entry Points: add_to_cart, checkout_start, checkout_payment
       ↓
1. Build context from cart (product_type, metadata already present)
       ↓
2. Execute master rule: "calculate_vat"
       ↓
3. Lookup region from utils_country_region
       ↓
4. Route to regional rule (calculate_vat_uk, calculate_vat_eu, etc.)
       ↓
5. Regional rule iterates cart items, calls product-specific rules
       ↓
6. Update item.vat_amount, item.vat_rate, item.vat_rule_applied
       ↓
7. Aggregate results, store in cart.vat_result JSONB
       ↓
8. Persist audit trail to VATAudit model
```

---

## Implementation Phases

### Phase 1: Database Foundation (3-4 days)

**Goal:** Create VAT-specific database models with data separation

#### Tasks

**1.1 Create utils Django app**
- [ ] Run `python manage.py startapp utils`
- [ ] Add `'utils'` to INSTALLED_APPS in settings
- [ ] Create `utils/__init__.py`, `utils/admin.py`, `utils/models.py`

**1.2 Create UtilsRegion model**
- [ ] Create model in `utils/models.py`:
  ```python
  class UtilsRegion(models.Model):
      code = models.CharField(max_length=10, unique=True, primary_key=True)  # UK, IE, EU, SA, ROW
      name = models.CharField(max_length=100)
      description = models.TextField(blank=True)
      active = models.BooleanField(default=True)
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)

      class Meta:
          db_table = 'utils_regions'
          verbose_name = 'VAT Region'
          verbose_name_plural = 'VAT Regions'
  ```
- [ ] Create migration: `python manage.py makemigrations utils`
- [ ] Write tests in `utils/tests/test_models.py`

**1.3 Create UtilsCountrys model (copy of country_country structure)**
- [ ] Create model in `utils/models.py`:
  ```python
  class UtilsCountrys(models.Model):
      code = models.CharField(max_length=2, unique=True, primary_key=True)
      name = models.CharField(max_length=100)
      vat_percent = models.DecimalField(
          max_digits=5,
          decimal_places=2,
          default=Decimal('0.00'),
          help_text="VAT percentage (e.g., 20.00 for 20%)"
      )
      active = models.BooleanField(default=True)
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)

      class Meta:
          db_table = 'utils_countrys'
          verbose_name = 'VAT Country'
          verbose_name_plural = 'VAT Countries'
  ```
- [ ] Create migration: `python manage.py makemigrations utils`
- [ ] Write tests for vat_percent decimal handling

**1.4 Create UtilsCountryRegion mapping model**
- [ ] Create model in `utils/models.py`:
  ```python
  class UtilsCountryRegion(models.Model):
      country = models.ForeignKey('UtilsCountrys', on_delete=models.CASCADE)
      region = models.ForeignKey(UtilsRegion, on_delete=models.CASCADE)
      effective_from = models.DateField()
      effective_to = models.DateField(null=True, blank=True)
      created_at = models.DateTimeField(auto_now_add=True)
      updated_at = models.DateTimeField(auto_now=True)

      class Meta:
          db_table = 'utils_country_region'
          unique_together = ['country', 'effective_from']
  ```
- [ ] Create migration: `python manage.py makemigrations utils`
- [ ] Write tests for effective date tracking

**1.5 Create data migration to populate utils tables**
- [ ] Create data migration:
  ```python
  # utils/migrations/0002_populate_vat_data.py
  def populate_vat_data(apps, schema_editor):
      # Copy country_country → utils_countrys
      # Populate utils_regions: UK, IE, EU, SA, ROW
      # Populate utils_country_region mappings
  ```
- [ ] Include VAT rates: UK=20%, IE=23%, SA=15%, ROW=0%
- [ ] Map CH and GG to ROW region

**1.6 Create Django admin interfaces**
- [ ] Register UtilsRegion in `utils/admin.py`
- [ ] Register UtilsCountrys with inline vat_percent editing
- [ ] Register UtilsCountryRegion with effective date filtering
- [ ] Add search, filters, and list display

**1.7 Run migrations and verify**
- [ ] Run: `python manage.py migrate utils`
- [ ] Verify: `python manage.py dbshell` → check table structures
- [ ] Verify: Django admin shows all models correctly

**Acceptance Criteria:**
- ✅ All models created with proper fields and constraints
- ✅ Migrations run successfully without errors
- ✅ utils_countrys populated with country data and VAT rates
- ✅ utils_regions contains UK, IE, EU, SA, ROW
- ✅ utils_country_region mappings established
- ✅ Django admin interfaces functional
- ✅ All model tests passing (100% coverage)
- ✅ Data separation verified: country_country unchanged

---

### Phase 2: Rules Engine Custom Functions (2 days)

**Goal:** Create custom functions for Rules Engine VAT calculations

#### Tasks

**2.1 Create VAT calculation custom functions**
- [ ] Update `rules_engine/custom_functions.py`:
  ```python
  from decimal import Decimal, ROUND_HALF_UP
  from utils.models import UtilsCountryRegion, UtilsCountrys

  def lookup_region(country_code, effective_date=None):
      """Lookup VAT region for country"""
      # Query utils_country_region with effective date
      # Return region code (UK, IE, EU, SA, ROW)

  def lookup_vat_rate(country_code):
      """Lookup VAT rate from utils_countrys"""
      # Query utils_countrys.vat_percent
      # Return Decimal rate (e.g., Decimal('0.20'))

  def calculate_vat_amount(net_amount, vat_rate):
      """Calculate VAT amount with proper rounding"""
      # Convert to Decimal if needed
      # Calculate: net_amount * vat_rate
      # Round: ROUND_HALF_UP to 2 decimal places
      # Return Decimal

  def format_vat_rate_percent(vat_rate):
      """Format VAT rate as percentage string"""
      # Convert Decimal('0.20') → "20%"
  ```

**2.2 Register functions in FUNCTION_REGISTRY**
- [ ] Add to FUNCTION_REGISTRY:
  ```python
  FUNCTION_REGISTRY = {
      'lookup_region': lookup_region,
      'lookup_vat_rate': lookup_vat_rate,
      'calculate_vat_amount': calculate_vat_amount,
      'format_vat_rate_percent': format_vat_rate_percent,
  }
  ```

**2.3 Create comprehensive unit tests**
- [ ] Test `lookup_region` with all countries
- [ ] Test `lookup_vat_rate` for UK, IE, SA, ROW
- [ ] Test `calculate_vat_amount` with Decimal precision
- [ ] Test edge cases: missing country, null dates, zero rates
- [ ] Test ROUND_HALF_UP rounding (e.g., 10.125 → 10.13)

**2.4 Create JSONLogic helper for iteration**
- [ ] Implement `for_each_item` helper:
  ```python
  def for_each_item(items, rule_id):
      """Execute rule for each cart item"""
      # Iterate items
      # Build per-item context
      # Execute rule_id
      # Collect results
  ```

**Acceptance Criteria:**
- ✅ All custom functions implemented and registered
- ✅ Decimal calculations use ROUND_HALF_UP
- ✅ All unit tests passing (100% coverage)
- ✅ Functions callable from JSONLogic rules
- ✅ No hardcoded VAT rates in Python code

---

### Phase 3: Master VAT Rule Creation (2-3 days)

**Goal:** Create master VAT calculation rule with regional routing

#### Tasks

**3.1 Create calculate_vat entry point**
- [ ] Add entry point to `RuleEntryPoint` model:
  ```python
  # Name: calculate_vat
  # Description: Entry point for VAT calculation
  # Active: True
  ```

**3.2 Create master VAT rule**
- [ ] Create rule via Django admin:
  ```json
  {
    "rule_id": "calculate_vat",
    "name": "Master VAT Calculation",
    "entry_point": "calculate_vat",
    "priority": 100,
    "active": true,
    "version": 1,
    "condition": {"==": [1, 1]},  // Always true
    "actions": [
      {
        "type": "call_function",
        "function": "lookup_region",
        "args": [{"var": "user.country"}, {"var": "settings.effective_date"}],
        "target": "context.region"
      },
      {
        "type": "call_rule",
        "rule_id": {
          "if": [
            {"==": [{"var": "context.region"}, "UK"]}, "calculate_vat_uk",
            {"==": [{"var": "context.region"}, "EU"]}, "calculate_vat_eu",
            {"==": [{"var": "context.region"}, "SA"]}, "calculate_vat_sa",
            {"==": [{"var": "context.region"}, "IE"]}, "calculate_vat_ie",
            "calculate_vat_row"
          ]
        }
      }
    ],
    "stop_processing": true
  }
  ```

**3.3 Test master rule execution**
- [ ] Create test context with UK user → should route to calculate_vat_uk
- [ ] Create test context with EU user → should route to calculate_vat_eu
- [ ] Create test context with SA user → should route to calculate_vat_sa
- [ ] Verify rule routing via `/api/rules/engine/execute/`

**3.4 Create rule execution tests**
- [ ] Test: POST `/api/rules/engine/execute/` with entry_point="calculate_vat"
- [ ] Verify response includes execution_id, rules_executed
- [ ] Verify audit trail created in VATAudit model

**Acceptance Criteria:**
- ✅ Master rule created and active
- ✅ Region lookup working correctly
- ✅ Rule routing logic functional
- ✅ All routing tests passing
- ✅ API endpoint tests passing

---

### Phase 4: Regional VAT Rules (3-4 days)

**Goal:** Create region-specific VAT rules with product-specific sub-rules

#### Tasks

**4.1 Create UK VAT rules**
- [ ] Create `calculate_vat_uk` rule:
  ```json
  {
    "rule_id": "calculate_vat_uk",
    "name": "UK VAT Calculation",
    "entry_point": "calculate_vat",
    "priority": 90,
    "active": true,
    "condition": {"==": [{"var": "context.region"}, "UK"]},
    "actions": [
      {
        "type": "for_each_item",
        "items": {"var": "cart.items"},
        "rules": [
          "calculate_vat_uk_digital_product",
          "calculate_vat_uk_printed_product",
          "calculate_vat_uk_flash_card",
          "calculate_vat_uk_pbor"
        ]
      }
    ],
    "stop_processing": false
  }
  ```

- [ ] Create `calculate_vat_uk_digital_product`:
  ```json
  {
    "rule_id": "calculate_vat_uk_digital_product",
    "priority": 80,
    "condition": {"==": [{"var": "item.product_type"}, "digital"]},
    "actions": [
      {
        "type": "update",
        "target": "item.vat_amount",
        "value": {"function": "calculate_vat_amount", "args": [{"var": "item.actual_price"}, 0.00]}
      },
      {
        "type": "update",
        "target": "item.vat_rate",
        "value": 0.00
      },
      {
        "type": "update",
        "target": "item.exemption_reason",
        "value": "UK eBook post-2020"
      }
    ],
    "stop_processing": true
  }
  ```

- [ ] Create `calculate_vat_uk_printed_product`:
  ```json
  {
    "rule_id": "calculate_vat_uk_printed_product",
    "priority": 70,
    "condition": {"!=": [{"var": "item.product_type"}, "digital"]},
    "actions": [
      {
        "type": "call_function",
        "function": "lookup_vat_rate",
        "args": ["GB"],
        "target": "item.vat_rate"
      },
      {
        "type": "update",
        "target": "item.vat_amount",
        "value": {
          "function": "calculate_vat_amount",
          "args": [{"var": "item.actual_price"}, {"var": "item.vat_rate"}]
        }
      }
    ],
    "stop_processing": true
  }
  ```

- [ ] Create `calculate_vat_uk_flash_card` and `calculate_vat_uk_pbor` rules

**4.2 Create EU VAT rules**
- [ ] Create `calculate_vat_eu` rule (B2B reverse charge):
  ```json
  {
    "rule_id": "calculate_vat_eu",
    "priority": 90,
    "condition": {"==": [{"var": "context.region"}, "EU"]},
    "actions": [
      {
        "type": "for_each_item",
        "items": {"var": "cart.items"},
        "rules": ["calculate_vat_eu_product"]
      }
    ]
  }
  ```

- [ ] Create `calculate_vat_eu_product` (0% reverse charge)

**4.3 Create SA VAT rules**
- [ ] Create `calculate_vat_sa` rule (15% standard rate)
- [ ] Create `calculate_vat_sa_product` rule

**4.4 Create IE VAT rules**
- [ ] Create `calculate_vat_ie` rule
- [ ] Create `calculate_vat_ie_product` rule

**4.5 Create ROW VAT rules**
- [ ] Create `calculate_vat_row` rule (0% for all)
- [ ] Create `calculate_vat_row_product` rule

**4.6 Create comprehensive rule tests**
- [ ] Test UK digital product → 0% VAT
- [ ] Test UK printed product → 20% VAT
- [ ] Test EU product → 0% VAT (reverse charge)
- [ ] Test SA product → 15% VAT
- [ ] Test ROW product → 0% VAT
- [ ] Test Switzerland/Guernsey → ROW region → 0% VAT

**Acceptance Criteria:**
- ✅ All regional rules created and active
- ✅ All product-specific sub-rules created
- ✅ Rule execution order correct (priority + created_at)
- ✅ stop_processing flags working correctly
- ✅ All rule tests passing (100% coverage)
- ✅ VAT amounts calculated with Decimal precision

---

### Phase 5: Entry Point Integration (2-3 days)

**Goal:** Integrate VAT calculation with checkout entry points

#### Tasks

**5.1 Create entry point handlers**
- [ ] Update `cart/views.py` to trigger VAT calculation at:
  - `add_to_cart` → execute rules, update cart.vat_result
  - `checkout_start` → execute rules, update cart.vat_result
  - `checkout_payment` → execute rules, validate cart.vat_result

**5.2 Create VAT calculation orchestrator**
- [ ] Create `vat/orchestrator.py`:
  ```python
  def execute_vat_calculation(cart, entry_point):
      # Build context from cart
      context = {
          'user': {'country': cart.user.country.code},
          'cart': {
              'items': [
                  {
                      'id': item.id,
                      'product_type': item.product_type,
                      'metadata': item.metadata,
                      'actual_price': item.actual_price,
                      'vat_amount': 0,
                      'vat_rate': 0,
                      'exemption_reason': None
                  }
                  for item in cart.items.all()
              ]
          },
          'settings': {'effective_date': date.today()}
      }

      # Execute rules
      results = rule_engine.execute(entry_point, context)

      # Aggregate VAT totals
      total_vat = sum(item['vat_amount'] for item in results['cart']['items'])

      # Store in cart.vat_result
      cart.vat_result = {
          'status': 'calculated',
          'items': results['cart']['items'],
          'totals': {
              'net': cart.subtotal,
              'vat': total_vat,
              'gross': cart.subtotal + total_vat
          },
          'region': results['context']['region'],
          'rules_executed': results['rules_executed'],
          'execution_id': results['execution_id'],
          'timestamp': datetime.now().isoformat()
      }
      cart.save()

      # Persist audit trail
      VATAudit.objects.create(...)
  ```

**5.3 Update cart serializer**
- [ ] Add `vat_result` to CartSerializer
- [ ] Add `vatCalculations` computed field for frontend
- [ ] Include execution metadata

**5.4 Create API integration tests**
- [ ] Test POST `/api/cart/add/` → VAT calculated
- [ ] Test POST `/api/checkout/start/` → VAT recalculated
- [ ] Test POST `/api/checkout/payment/` → VAT validated
- [ ] Verify cart.vat_result JSONB structure

**5.5 Update discount handling**
- [ ] Implement proportional discount allocation
- [ ] Recalculate VAT on discounted net amounts
- [ ] Update tests for discount scenarios

**Acceptance Criteria:**
- ✅ add_to_cart triggers VAT calculation
- ✅ checkout_start triggers VAT recalculation
- ✅ checkout_payment validates VAT
- ✅ cart.vat_result JSONB populated correctly
- ✅ VATAudit records created
- ✅ Discount allocation working correctly
- ✅ All integration tests passing

---

### Phase 6: Legacy Code Removal (1-2 days)

**Goal:** Remove all hardcoded VAT logic from Python code

#### Tasks

**6.1 Delete vat_rates.py**
- [ ] Remove `backend/django_Admin3/country/vat_rates.py`
- [ ] Remove all imports of `vat_rates` module
- [ ] Run tests to verify no broken imports

**6.2 Delete product_classifier.py (if exists)**
- [ ] Remove `backend/django_Admin3/vat/product_classifier.py`
- [ ] Verify cart context already has product_type and metadata
- [ ] Update any references to use cart context directly

**6.3 Remove hardcoded VAT calculations**
- [ ] Search codebase for hardcoded VAT patterns:
  ```bash
  grep -r "Decimal('0.20')" backend/
  grep -r "vat_rate = " backend/
  grep -r "* 0.2" backend/
  ```
- [ ] Remove all hardcoded VAT calculation logic
- [ ] Replace with Rules Engine calls

**6.4 Update cart services**
- [ ] Remove hardcoded VAT from `cart/services.py`
- [ ] Replace with `execute_vat_calculation` calls
- [ ] Update unit tests

**6.5 Create regression tests**
- [ ] Create `vat/tests/test_vat_removal.py`
- [ ] Verify no hardcoded VAT logic remains
- [ ] Verify all VAT comes from Rules Engine

**Acceptance Criteria:**
- ✅ vat_rates.py deleted
- ✅ product_classifier.py deleted (if exists)
- ✅ No hardcoded VAT calculations in Python code
- ✅ All VAT logic in Rules Engine
- ✅ Regression tests passing
- ✅ No broken imports or references

---

### Phase 7: Django Admin Interface (2 days)

**Goal:** Create admin interfaces for VAT management

#### Tasks

**7.1 Create UtilsCountrys admin interface**
- [ ] Update `utils/admin.py`:
  ```python
  @admin.register(UtilsCountrys)
  class UtilsCountrysAdmin(admin.ModelAdmin):
      list_display = ['code', 'name', 'vat_percent', 'active']
      search_fields = ['code', 'name']
      list_filter = ['active']
      list_editable = ['vat_percent', 'active']
  ```

**7.2 Create UtilsCountryRegion admin interface**
- [ ] Add inline editor for effective dates
- [ ] Add filters for region and effective dates
- [ ] Add validation for overlapping date ranges

**7.3 Create VAT rule testing interface**
- [ ] Create admin action "Test VAT Rules"
- [ ] Allow input of sample cart context
- [ ] Display rule execution results
- [ ] Show which rules were triggered

**7.4 Create VAT audit trail viewer**
- [ ] Create admin interface for VATAudit model
- [ ] Add filters: cart_id, order_id, rule_id, date range
- [ ] Add JSON viewer for input_context and output_data
- [ ] Add export functionality for accounting

**7.5 Create admin documentation**
- [ ] Document how to update VAT rates
- [ ] Document how to modify region mappings
- [ ] Document how to test rules
- [ ] Document how to view audit trail

**Acceptance Criteria:**
- ✅ Admin can update VAT rates without code changes
- ✅ Admin can modify region mappings
- ✅ Admin can test VAT rules with sample data
- ✅ Admin can view execution history
- ✅ All admin interfaces functional
- ✅ Documentation complete

---

### Phase 8: Frontend VAT Display Updates (2-3 days)

**Goal:** Update React frontend to use dynamic VAT from API

**See detailed tasks in:** `tasks/phase-8-frontend-vat-display-tasks.md`

#### Summary Tasks

**8.1 Update cart components**
- [ ] Replace hardcoded "VAT (20%)" labels with dynamic rate from `vatCalculations.totals.effective_vat_rate`
- [ ] Update CartSummaryPanel.js line 95
- [ ] Update CartReviewStep.js line 114

**8.2 Update product card components**
- [ ] Replace hardcoded prices in TutorialProductCard.js with product variation data
- [ ] Replace "Price includes VAT" with dynamic `product.vat_status_display`
- [ ] Search for hardcoded VAT text in all product cards

**8.3 Create VAT utility functions**
- [ ] Create `frontend/react-Admin3/src/utils/vatUtils.js`
- [ ] Implement `formatVatLabel(effectiveVatRate)`
- [ ] Implement `getVatStatusDisplay(vatStatus)`

**8.4 Browser verification with Browser MCP**
- [ ] Verify CartSummaryPanel rendering
- [ ] Verify TutorialProductCard rendering
- [ ] End-to-end checkout flow verification

**Acceptance Criteria:**
- ✅ All frontend components use API VAT data
- ✅ No frontend VAT calculation logic
- ✅ Browser MCP verification passes
- ✅ Visual rendering correct
- ✅ All tests passing (80%+ coverage)

---

### Phase 9: Testing & Documentation (2-3 days)

**Goal:** Comprehensive testing and documentation

#### Tasks

**9.1 Run complete test suite**
- [ ] Backend unit tests: `python manage.py test utils vat --coverage`
- [ ] Rules Engine tests: `python manage.py test rules_engine.tests.test_vat_rules`
- [ ] Integration tests: `python manage.py test cart.tests.test_vat_integration`
- [ ] Frontend tests: `npm test -- --coverage --watchAll=false`

**9.2 Verify test coverage**
- [ ] Backend coverage > 80%
- [ ] Frontend coverage > 80%
- [ ] Generate coverage reports

**9.3 Performance testing**
- [ ] Measure VAT calculation latency
- [ ] Test with carts of varying sizes (1, 10, 50 items)
- [ ] Verify < 50ms performance target
- [ ] Profile and optimize if needed

**9.4 Create user documentation**
- [ ] Admin guide: How to update VAT rates
- [ ] Admin guide: How to modify region mappings
- [ ] Admin guide: How to test VAT rules
- [ ] Finance guide: How to export VAT reports

**9.5 Create technical documentation**
- [ ] Architecture overview
- [ ] Data model documentation
- [ ] Rules Engine integration guide
- [ ] API documentation
- [ ] Troubleshooting guide

**9.6 Run specification compliance verification**
- [ ] Verify all 45 functional requirements met
- [ ] Verify all acceptance scenarios passing
- [ ] Verify edge cases handled
- [ ] Document any deviations

**Acceptance Criteria:**
- ✅ All tests passing (100% success rate)
- ✅ Test coverage > 80%
- ✅ Performance < 50ms per cart
- ✅ All 45 functional requirements met
- ✅ Documentation complete
- ✅ Specification compliance verified

---

## Dependencies & Prerequisites

### External Dependencies
- ✅ Epic 1: Enhanced Rules Engine (COMPLETE - verified functional)
- ✅ VATAudit model (COMPLETE - 36/36 tests passing)
- ✅ Cart.vat_result JSONB field (COMPLETE - verified in Phase 2)
- ✅ Product data with product_type and metadata in cart context

### Technical Prerequisites
- Python 3.11+ with Decimal support
- PostgreSQL 12+ with JSONB support
- Django 5.1+ with JSONField
- React 18+ with hooks
- Material-UI 5+

---

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Rules misconfiguration causes incorrect VAT | **High** | Dry-run testing mode, rule versioning, comprehensive test coverage, rollback capability |
| Performance degradation with complex rules | **Medium** | Caching, pre-compiled expressions, performance testing, < 50ms target monitoring |
| Data migration issues (country_country → utils_countrys) | **Medium** | Test migration on staging first, verify data integrity, have rollback plan |
| Missing country in utils_countrys | **Low** | Default to ROW region with 0% VAT, admin alert system |
| Decimal precision errors | **Medium** | Use Python Decimal throughout, ROUND_HALF_UP, comprehensive rounding tests |
| Rules Engine execution failures | **High** | Comprehensive error handling, fallback to safe defaults, alerting system |

---

## Success Metrics

### Technical Success Criteria
- ✅ 100% test coverage for critical VAT calculation paths
- ✅ All 45 functional requirements implemented and tested
- ✅ Performance < 50ms per cart (99th percentile)
- ✅ Zero hardcoded VAT logic in Python code
- ✅ 100% VAT logic in Rules Engine
- ✅ Data separation: utils_countrys (VAT) vs country_country (users)

### Business Success Criteria
- ✅ Finance team can update VAT rates in < 5 minutes
- ✅ No code deployment required for VAT changes
- ✅ Complete audit trail for all calculations
- ✅ Zero VAT calculation errors
- ✅ All regional rules working correctly

### Compliance Success Criteria
- ✅ UK eBook exemption (post-2020) working
- ✅ EU B2B reverse charge working
- ✅ SA 15% VAT working
- ✅ ROW 0% VAT working
- ✅ Audit trail retention (7 years)

---

## Deployment Plan

### Pre-Deployment Checklist
- [ ] All tests passing on staging
- [ ] Performance benchmarks met
- [ ] Database migrations tested
- [ ] Rollback procedure documented
- [ ] Monitoring configured
- [ ] Admin training complete

### Deployment Steps
1. **Database Migration**
   - Run migrations on production: `python manage.py migrate utils`
   - Verify data migration: utils_countrys populated
   - Verify data separation: country_country unchanged

2. **Rules Deployment**
   - Deploy all VAT rules via Django admin
   - Test master rule routing
   - Verify regional rules execution

3. **Code Deployment**
   - Deploy backend changes
   - Deploy frontend changes
   - Verify API endpoints

4. **Validation**
   - Run smoke tests on production
   - Verify VAT calculations
   - Monitor error logs

5. **Monitoring**
   - Watch VAT calculation latency
   - Monitor rule execution errors
   - Track audit trail creation

### Rollback Procedure
1. Disable VAT rules in Django admin (immediate)
2. Revert code deployment (< 5 minutes)
3. Rollback database migration if needed
4. Re-enable legacy VAT code temporarily
5. Investigate and fix issues

---

## Next Steps

**Immediate Actions:**
1. ✅ **Review this implementation plan** with team
2. 🚀 **Create feature branch:** `git checkout -b 003-vat-calculation-rules-engine`
3. 🧪 **Begin Phase 1:** Database Foundation (TDD approach)
4. 📋 **Track progress:** Use TodoWrite for task tracking

**Commands to Start:**
```bash
# Create feature branch
git checkout -b 003-vat-calculation-rules-engine

# Activate virtual environment
cd backend/django_Admin3
.\.venv\Scripts\activate

# Create utils app
python manage.py startapp utils

# Begin TDD: Write first test (RED phase)
# File: utils/tests/test_models.py
```

---

## Phase Completion Tracking

| Phase | Duration | Status | Completion Date |
|-------|----------|--------|-----------------|
| Phase 1: Database Foundation | 3-4 days | ⏳ Not Started | - |
| Phase 2: Rules Engine Functions | 2 days | ⏳ Not Started | - |
| Phase 3: Master VAT Rule | 2-3 days | ⏳ Not Started | - |
| Phase 4: Regional VAT Rules | 3-4 days | ⏳ Not Started | - |
| Phase 5: Entry Point Integration | 2-3 days | ⏳ Not Started | - |
| Phase 6: Legacy Code Removal | 1-2 days | ⏳ Not Started | - |
| Phase 7: Django Admin Interface | 2 days | ⏳ Not Started | - |
| Phase 8: Frontend VAT Display | 2-3 days | ⏳ Not Started | - |
| Phase 9: Testing & Documentation | 2-3 days | ⏳ Not Started | - |

**Total Estimated Duration:** 19-27 days (4-5 weeks)

---

*Generated by SpecKit for Admin3 project*
*Based on: specs/spec-2025-10-06-121922.md*
*Architecture: Rules Engine-Based VAT Calculation with Database-Driven Rates*