# Railway Postgres Configuration for UAT

## Overview
You've created `ACTEDDBUAT01` database within Railway's managed Postgres service. This guide shows how to configure your backend service to use it.

## Architecture

```
┌─────────────────────┐         ┌──────────────────────┐
│  Postgres Service   │         │  Backend Service     │
│                     │         │                      │
│  Variables:         │────────▶│  References:         │
│  - PGHOST           │         │  ${{Postgres.PGHOST}}│
│  - PGPORT           │         │  ${{Postgres.PGPORT}}│
│  - PGUSER           │         │                      │
│  - PGPASSWORD       │         │  DATABASE_URL:       │
│  - PGDATABASE       │         │  Uses ACTEDDBUAT01   │
│                     │         │                      │
│  Databases:         │         │                      │
│  - postgres (default)│        │                      │
│  - ACTEDDBUAT01 ✓   │         │                      │
└─────────────────────┘         └──────────────────────┘
```

## Step-by-Step Configuration

### Step 1: Identify Your Postgres Service Name

1. Go to https://railway.app/project/0d639b12-bc89-4b72-a8e4-260f92182870
2. Find your Postgres service (usually named "Postgres" or "postgres")
3. Note the exact name - you'll use it in variable references

**Common names:** `Postgres`, `postgres`, `PostgreSQL`, `database`

### Step 2: Configure Backend Service Variables

Go to **admin3-backend** service → **Variables** tab

#### Core Variables (Required)

```bash
# Database Connection - References Postgres service variables
DATABASE_URL = postgresql://${{Postgres.PGUSER}}:${{Postgres.PGPASSWORD}}@${{Postgres.PGHOST}}:${{Postgres.PGPORT}}/ACTEDDBUAT01

# Django Environment
DJANGO_ENV = uat
DJANGO_SETTINGS_MODULE = django_Admin3.settings.uat
DJANGO_SECRET_KEY = <generate-random-secret-key>

# Security Settings
ALLOWED_HOSTS = ${{RAILWAY_PUBLIC_DOMAIN}},healthcheck.railway.app
CORS_ALLOWED_ORIGINS = https://<frontend-domain>.railway.app
CSRF_TRUSTED_ORIGINS = https://<frontend-domain>.railway.app

# Frontend URL
FRONTEND_URL = https://<frontend-domain>.railway.app
```

**Important Notes:**
- Replace `Postgres` with your actual service name if different
- Replace `<frontend-domain>` with your actual frontend Railway domain
- `${{RAILWAY_PUBLIC_DOMAIN}}` is automatically populated by Railway

#### Additional Required Variables

```bash
# Administrate API
ADMINISTRATE_INSTANCE_URL = <your-value>
ADMINISTRATE_API_URL = <your-value>
ADMINISTRATE_API_KEY = <your-value>
ADMINISTRATE_API_SECRET = <your-value>
ADMINISTRATE_REST_API_URL = <your-value>
GETADDRESS_API_KEY = <your-value>

# Email Configuration (Gmail)
EMAIL_HOST_USER = <your-gmail-address>
EMAIL_HOST_PASSWORD = <your-gmail-app-password>
DEFAULT_FROM_EMAIL = noreply@acted.com

# Opayo Payment Gateway (Test Mode)
OPAYO_VENDOR_NAME = <your-vendor-name>
OPAYO_INTEGRATION_KEY = <your-integration-key>
OPAYO_INTEGRATION_PASSWORD = <your-integration-password>

# reCAPTCHA
RECAPTCHA_SITE_KEY = <your-site-key>
RECAPTCHA_SECRET_KEY = <your-secret-key>
RECAPTCHA_MIN_SCORE = 0.5
```

### Step 3: Verify Postgres Service Variables

Go to **Postgres** service → **Variables** tab

You should see these automatically generated variables (DO NOT modify them):
```bash
PGHOST = <auto-generated>
PGPORT = 5432
PGUSER = <auto-generated>
PGPASSWORD = <auto-generated>
PGDATABASE = railway (or postgres)
DATABASE_URL = <auto-generated>
```

### Step 4: Generate Django Secret Key

```powershell
cd backend/django_Admin3
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

Copy the output and use it for `DJANGO_SECRET_KEY`.

### Step 5: Deploy and Test

#### Deploy Backend
```powershell
cd backend/django_Admin3
railway up --service admin3-backend
```

#### Check Health Endpoint
Once deployed, test the health endpoint:
```powershell
# Get your Railway domain
railway domain --service admin3-backend

# Test health endpoint
curl https://<your-domain>/api/health/
```

Expected response:
```json
{
  "status": "healthy",
  "checks": {
    "database": "connected"
  },
  "environment": "uat",
  "debug": false,
  "python_version": "3.11.x"
}
```

#### Run Migrations
```powershell
railway run --service admin3-backend python manage.py migrate --noinput
```

#### Create Superuser
```powershell
railway run --service admin3-backend python manage.py createsuperuser
```

## Railway Service Reference Syntax

### Basic Syntax
```
${{ServiceName.VARIABLE_NAME}}
```

### Examples
```bash
# Reference Postgres host
${{Postgres.PGHOST}}

# Reference Postgres password
${{Postgres.PGPASSWORD}}

# Reference another service's port
${{backend.PORT}}

# Railway built-in variables
${{RAILWAY_PUBLIC_DOMAIN}}
${{RAILWAY_ENVIRONMENT}}
${{RAILWAY_PROJECT_ID}}
```

### Building Complex Variables
```bash
# Custom database URL
DATABASE_URL = postgresql://${{Postgres.PGUSER}}:${{Postgres.PGPASSWORD}}@${{Postgres.PGHOST}}:${{Postgres.PGPORT}}/ACTEDDBUAT01

# Backend URL for frontend
VITE_API_URL = https://${{backend.RAILWAY_PUBLIC_DOMAIN}}/api
```

## Troubleshooting

### Issue: "Database does not exist"

**Solution:** The database might not exist yet. Connect to Railway Postgres and create it:

```powershell
# Connect to Railway Postgres
railway connect Postgres

# In PostgreSQL shell
CREATE DATABASE "ACTEDDBUAT01" OWNER actedadmin;
\l  # List databases to verify
\q  # Quit
```

### Issue: "Variable reference not working"

**Cause:** Service name might be incorrect

**Solution:**
1. Check exact service name in Railway dashboard
2. Service names are case-sensitive
3. Try these variations:
   - `${{Postgres.PGHOST}}`
   - `${{postgres.PGHOST}}`
   - `${{PostgreSQL.PGHOST}}`

### Issue: "Health check fails"

**Cause:** Database connection issue

**Solution:**
1. Check Railway logs: `railway logs --service admin3-backend`
2. Verify DATABASE_URL is correctly formatted
3. Check Postgres service is running
4. Verify database ACTEDDBUAT01 exists

### Issue: "ALLOWED_HOSTS error"

**Solution:** Add all Railway domains:
```bash
ALLOWED_HOSTS = ${{RAILWAY_PUBLIC_DOMAIN}},healthcheck.railway.app,admin3-backend-production.up.railway.app
```

## Security Checklist

- [ ] DJANGO_SECRET_KEY is randomly generated and unique
- [ ] DATABASE_URL references Postgres service (no hardcoded credentials)
- [ ] DEBUG is False (handled by uat.py settings)
- [ ] ALLOWED_HOSTS includes all Railway domains
- [ ] Email uses app-specific password (not main Gmail password)
- [ ] All API keys are from test/production accounts
- [ ] CORS_ALLOWED_ORIGINS matches frontend domain

## Useful Railway Commands

```powershell
# Check service status
railway status --service admin3-backend

# View logs
railway logs --service admin3-backend

# View all variables
railway variables --service admin3-backend

# Connect to Postgres
railway connect Postgres

# Run Django commands
railway run --service admin3-backend python manage.py <command>

# Shell access
railway shell --service admin3-backend
```

## Database Management

### Connect to ACTEDDBUAT01
```powershell
# Connect to Railway Postgres
railway connect Postgres

# Switch to ACTEDDBUAT01
\c ACTEDDBUAT01

# Run SQL commands
\dt  # List tables
\du  # List users
```

### Common SQL Commands
```sql
-- List all databases
\l

-- Connect to ACTEDDBUAT01
\c ACTEDDBUAT01

-- Check current database
SELECT current_database();

-- List all tables
\dt

-- Check Django migrations
SELECT * FROM django_migrations ORDER BY applied DESC LIMIT 10;

-- Quit
\q
```

## Next Steps

1. ✅ Create ACTEDDBUAT01 in Railway Postgres (done)
2. ⬜ Set all environment variables in admin3-backend service
3. ⬜ Deploy backend to Railway
4. ⬜ Run migrations: `railway run python manage.py migrate`
5. ⬜ Create superuser: `railway run python manage.py createsuperuser`
6. ⬜ Test health endpoint
7. ⬜ Configure frontend to use backend URL
8. ⬜ Test end-to-end functionality

## Reference

- Railway Docs: https://docs.railway.app
- Service Variables: https://docs.railway.app/develop/variables
- PostgreSQL: https://docs.railway.app/databases/postgresql
