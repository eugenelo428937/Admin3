# Bug Fixes - October 23, 2025

## Issue 1: Navbar Links Returning No Products ✅ FIXED

### Problem
When clicking navbar links like "Products > Core Reading", the unified search endpoint returned no products. The request showed `"products":[75]` but got zero results.

### Root Cause
**File:** `optimized_search_service.py:187`

The code was treating numeric product filter values as **ESSP IDs** (`Q(id=essp_id)`) instead of **Product IDs** (`Q(product__id=product_id)`).

```python
# BEFORE (WRONG):
product_q |= Q(id=essp_id)  # Filters by ExamSessionSubjectProduct.id

# AFTER (CORRECT):
product_q |= Q(product__id=product_id)  # Filters by Product.id
```

### Why This Matters
- Navbar sends **Product ID 75** (e.g., "Core Reading")
- We need to find ALL ESSPs with that product (CB1 Core Reading, CB2 Core Reading, CS1 Core Reading, etc.)
- Old code: Looked for ESSP with `id=75` → No match
- New code: Looks for ESSPs with `product__id=75` → All Core Reading products across subjects ✅

### Files Changed
- `backend/django_Admin3/exam_sessions_subjects_products/services/optimized_search_service.py` (lines 176-191)

---

## Issue 2: Search Results Not Sorted by Relevance ✅ FIXED

### Problem
When using the searchbox and pressing Enter:
1. Fuzzy search API returned results sorted by **relevance** (correct)
2. Then unified search API was called and returned results sorted by **subject code** (wrong)
3. Frontend displayed the second result, overriding the correct sorting

### Example
**Query:** "SP7 Mock"

**Before Fix:**
1. `/fuzzy-search/?q=SP7+Mock` → Returns SP7 Mock Exam (score 95) first ✅
2. `/search/` with filters → Returns CB1 products first (alphabetical) ❌
3. User sees CB1 products instead of SP7 Mock Exam

**After Fix:**
1. `/fuzzy-search/?q=SP7+Mock` → Returns SP7 Mock Exam first ✅
2. `/search/` with `searchQuery: "SP7 Mock"` → Returns SP7 Mock Exam first ✅
3. User sees correct results

### Solution

Added `searchQuery` parameter to unified search endpoint. When present:
- Uses FuzzySearchService to score all products
- Filters to matched ESSP IDs
- Preserves fuzzy search relevance ordering
- Applies additional filters on top

When absent:
- Uses default subject code + product name sorting

### Files Changed

**1. Request Serializer** - Accept search query
```python
# serializers.py:146
searchQuery = serializers.CharField(
    required=False,
    allow_blank=True,
    help_text="Search query for fuzzy matching"
)
```

**2. Views** - Extract and pass search query
```python
# views.py:749, 778
search_query = validated_data.get('searchQuery', '').strip()
result = optimized_search_service.search_products(
    search_query=search_query,  # ← Added
    filters=filters,
    ...
)
```

**3. Optimized Search Service** - Use fuzzy search when query present
```python
# optimized_search_service.py:62-85
if use_fuzzy_search:
    # Use FuzzySearchService to get relevance-scored results
    fuzzy_service = FuzzySearchService(min_score=60)
    fuzzy_results = fuzzy_service.search_products(search_query, limit=1000)

    # Extract ESSP IDs (already sorted by relevance)
    fuzzy_essp_ids = [product.id for product in fuzzy_results['products']]

    # Preserve fuzzy search ordering using Case/When
    preserved_order = Case(*[When(id=pk, then=pos) for pos, pk in enumerate(fuzzy_essp_ids)])
    queryset = queryset.filter(id__in=fuzzy_essp_ids).order_by(preserved_order)
```

### Sorting Logic Summary

| Scenario | Search Query | Sorting | Example |
|----------|--------------|---------|---------|
| **Filtered browsing** | ❌ No | Subject code + product name | CB1 Core Reading, CB2 Core Reading, CS1 Core Reading |
| **Text search** | ✅ Yes | Relevance score (best match first) | SP7 Mock Exam (95), SP5 Mock Exam (80), CB1 Mock Exam (60) |

---

## Testing After Server Restart

### Test Issue 1: Navbar Links
```bash
# Test "Products > Core Reading" link
curl -X POST "http://localhost:8888/api/exam-sessions-subjects-products/search/" \
  -H "Content-Type: application/json" \
  -d '{"filters": {"products": [75]}, "pagination": {"page": 1, "page_size": 10}}'

# Expected: Returns Core Reading products for ALL subjects (CB1, CB2, CS1, CS2, etc.)
```

### Test Issue 2: Search Sorting
```bash
# Test search query with filters
curl -X POST "http://localhost:8888/api/exam-sessions-subjects-products/search/" \
  -H "Content-Type: application/json" \
  -d '{
    "searchQuery": "SP7 Mock",
    "filters": {},
    "pagination": {"page": 1, "page_size": 10}
  }'

# Expected: Returns SP7 Mock Exam FIRST (best match), not alphabetically
```

### Test No Query: Subject Sorting
```bash
# Test filtering without search query
curl -X POST "http://localhost:8888/api/exam-sessions-subjects-products/search/" \
  -H "Content-Type: application/json" \
  -d '{
    "filters": {"subjects": ["CS1", "CS2"]},
    "pagination": {"page": 1, "page_size": 10}
  }'

# Expected: Returns CS1 products first (alphabetical), then CS2 products
```

---

## Technical Details

### Django ORM: Preserving Order with Case/When

```python
from django.db.models import Case, When, IntegerField

# Fuzzy search returns ordered list of ESSP IDs: [123, 456, 789]
fuzzy_essp_ids = [123, 456, 789]

# Preserve this exact order in the queryset
preserved_order = Case(
    When(id=123, then=0),  # First result
    When(id=456, then=1),  # Second result
    When(id=789, then=2),  # Third result
    output_field=IntegerField()
)

queryset = queryset.filter(id__in=fuzzy_essp_ids).order_by(preserved_order)
```

This ensures the database respects the fuzzy search relevance ranking.

---

## Files Modified

1. `backend/django_Admin3/exam_sessions_subjects_products/services/optimized_search_service.py`
   - Line 27: Added `search_query` parameter
   - Lines 62-85: Added fuzzy search logic
   - Line 136: Updated `_build_optimized_queryset` signature
   - Line 187: Fixed product filter to use `product__id`
   - Line 447: Updated `_build_cache_key` to include search_query

2. `backend/django_Admin3/exam_sessions_subjects_products/serializers.py`
   - Line 146: Added `searchQuery` field to ProductSearchRequestSerializer

3. `backend/django_Admin3/exam_sessions_subjects_products/views.py`
   - Line 749: Extract search_query from request
   - Line 778: Pass search_query to service

---

## Required Action

**⚠️ Restart Django server to load all fixes:**

```bash
# Stop Django server (Ctrl+C)
# Restart:
cd backend/django_Admin3
python manage.py runserver 8888
```

---

## Related Documentation

- `PRODUCT-SORTING-BEHAVIOR.md` - Complete sorting reference
- `FUZZY-SEARCH-UNCAPPED-SCORING.md` - Relevance scoring details
- `FUZZY-SEARCH-FIELD-SPECIFIC-MATCHING.md` - Multi-token detection

---

## Validation

✅ Django check passed with no issues
✅ All 5 fixes completed
✅ Ready for testing after server restart
