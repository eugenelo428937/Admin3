# Story 1.2: Fix Cart Integration for Incremental Updates

## Status
Draft

## Story
**As a** user selecting tutorial preferences,
**I want** to incrementally add tutorial choices to my cart without creating duplicate entries,
**so that** I can add one choice at a time and the system properly merges them into a single cart item per subject

## Acceptance Criteria
1. Investigation complete: Root cause of cart duplication bug documented in story
2. Cart integration properly finds existing cart item by subject code before adding
3. When adding choices to cart, system merges new choices with existing choices in same cart item
4. State transition logic updates `isDraft: false` when choices are added to cart
5. Bidirectional sync: Removing cart item sets `isDraft: true` for associated choices in TutorialChoiceContext
6. No duplicate cart items created for the same subject
7. 100% test coverage for critical cart logic (duplication prevention, merging, state transitions)

## Tasks / Subtasks

### Task 1: Investigate and Document Current Cart Bug (AC: 1)
- [ ] Analyze `TutorialProductCard.handleAddToCart()` implementation
- [ ] Trace cart API call flow in `CartContext.addToCart()`
- [ ] Review backend `cart/views.py` add-to-cart logic
- [ ] Identify root cause of duplicate cart items
- [ ] Document findings in this story under "Bug Investigation Results" section
- [ ] Document expected vs actual behavior
- [ ] Create reproduction steps
- [ ] Test: Manually reproduce the bug and document steps

### Task 2: Implement Cart Item Lookup by Subject (AC: 2, 6)
- [ ] Update `CartContext.addToCart()` to search for existing cart item by subject code
- [ ] Implement `findCartItemBySubject(subjectCode)` helper method
- [ ] Check `item.subject_code === subjectCode && item.type === "Tutorial"`
- [ ] Return existing cart item if found, null otherwise
- [ ] Test: Unit test `findCartItemBySubject()` with various cart states
- [ ] Test: Verify duplicate prevention when adding to existing subject

### Task 3: Implement Choice Merging Logic (AC: 3, 6)
- [ ] If existing cart item found, merge new choices with existing metadata
- [ ] Extract existing `locationChoices` from cart item metadata
- [ ] Merge new choices into existing choices array
- [ ] Deduplicate by `eventId` (prevent same event being added twice)
- [ ] Update `totalChoiceCount` in metadata
- [ ] Call backend update API instead of add API
- [ ] Test: Unit test merging logic with various choice combinations
- [ ] Test: Verify deduplication prevents duplicate events
- [ ] Test: Integration test full merge workflow

### Task 4: Implement State Transition Logic (AC: 4)
- [ ] After successful cart addition, call `markChoicesAsAdded(subjectCode)`
- [ ] Update all choices for subject to `isDraft: false`
- [ ] Persist state change to localStorage
- [ ] Update TutorialChoiceContext state
- [ ] Test: Verify `isDraft` flag updates after cart addition
- [ ] Test: Verify localStorage reflects updated state
- [ ] Test: Verify UI reflects carted state

### Task 5: Implement Bidirectional Sync (AC: 5)
- [ ] Update `CartContext.removeFromCart()` to detect tutorial items
- [ ] On tutorial item removal, extract subject code from metadata
- [ ] Call `TutorialChoiceContext.markChoicesAsDraft(subjectCode)` (new method)
- [ ] Implement `markChoicesAsDraft(subjectCode)` in TutorialChoiceContext:
  - Set `isDraft: true` for all choices of subject
  - Update localStorage
  - Update state
- [ ] Test: Unit test `markChoicesAsDraft()` method
- [ ] Test: Integration test cart removal triggers draft state
- [ ] Test: Verify localStorage updates on cart removal

### Task 6: Update TutorialProductCard Integration (AC: 3, 4)
- [ ] Update `handleAddToCart()` to use new merge-aware cart logic
- [ ] Remove any local duplication prevention (handled by context)
- [ ] Ensure proper error handling for cart operations
- [ ] Display user feedback for successful merge vs new addition
- [ ] Test: Unit test `handleAddToCart()` with mocked contexts
- [ ] Test: Integration test with real contexts
- [ ] Test: Verify UI feedback for merge scenarios

### Task 7: Backend Cart API Updates (AC: 2, 3)
- [ ] Review backend cart serializer for metadata handling
- [ ] Ensure backend supports merging tutorial metadata
- [ ] Add endpoint for updating cart item metadata (if needed)
- [ ] Validate metadata structure on backend
- [ ] Test: Backend unit test for metadata merging
- [ ] Test: Backend integration test for cart update workflow

### Task 8: Comprehensive Testing (AC: 7)
- [ ] Write unit tests for cart item lookup
- [ ] Write unit tests for choice merging logic
- [ ] Write unit tests for state transitions
- [ ] Write unit tests for bidirectional sync
- [ ] Write integration tests for full add-to-cart workflow
- [ ] Write integration tests for cart removal workflow
- [ ] Write end-to-end tests for incremental addition
- [ ] Achieve 100% test coverage for critical cart logic
- [ ] Test: Run full test suite and verify no regressions
- [ ] Test: Measure and verify 100% coverage for critical paths

## Dev Notes

### Bug Investigation Results
_To be populated during Task 1 implementation_

**Current Behavior:**
- Users select tutorial choices and add to cart
- Each "Add to Cart" action creates a NEW cart item
- Result: Multiple cart items for same subject with different choices

**Expected Behavior:**
- First "Add to Cart" creates cart item for subject
- Subsequent "Add to Cart" for same subject MERGES choices into existing item
- Result: Single cart item per subject with all choices

**Root Cause:**
_To be documented during investigation_

### Testing Standards
[Source: C:\Code\Admin3\docs\architecture\coding-standards.md#Testing Standards]

**Test Locations:**
- Frontend context tests: `frontend/react-Admin3/src/contexts/__tests__/CartContext.test.js`
- Frontend component tests: `frontend/react-Admin3/src/components/Product/ProductCard/Tutorial/__tests__/TutorialProductCard.test.js`
- Backend cart tests: `backend/django_Admin3/cart/tests/test_views.py`

**Test Framework:**
- **Frontend:** React Testing Library, Jest
- **Backend:** Django APITestCase, Mock

**Test Requirements:**
- 100% coverage for critical cart logic (duplication prevention, merging, state transitions)
- Test both success and error cases
- Mock API calls appropriately
- Test edge cases (empty cart, partial choices, etc.)

### Previous Story Insights
[Source: Story 1.1 - Implement isDraft State Management]

**Key Learnings:**
- Tutorial choices now have `isDraft: boolean` flag
- Helper methods available: `markChoicesAsAdded()`, `getDraftChoices()`, `getCartedChoices()`, `hasCartedChoices()`
- Migration and rollback support implemented
- Backward compatibility ensured

**Dependencies:**
- This story depends on Story 1.1 completion
- Must use `markChoicesAsAdded()` after cart addition
- Must implement complementary `markChoicesAsDraft()` for cart removal

### Data Models

#### TutorialChoiceContext State
[Source: Story 1.1, C:\Code\Admin3\frontend\react-Admin3\src\contexts\TutorialChoiceContext.js]

```javascript
{
  subjectCode: {
    "1st": {
      eventId: number,
      variationId: number,
      variationName: string,
      eventTitle: string,
      eventCode: string,
      venue: string,
      startDate: string,
      endDate: string,
      choiceLevel: "1st" | "2nd" | "3rd",
      timestamp: ISO8601 string,
      variation: { prices: [...] },
      isDraft: boolean  // true = draft, false = in cart
    },
    "2nd": { ... },
    "3rd": { ... }
  }
}
```

#### Cart Item Structure
[Source: C:\Code\Admin3\frontend\react-Admin3\src\contexts\CartContext.js]

```javascript
{
  id: number,                    // Cart item ID
  product: number,               // Product ID
  subject_code: string,          // e.g., "CS1"
  subject_name: string,          // e.g., "Actuarial Statistics"
  type: "Tutorial",              // Product type
  quantity: number,              // Always 1 for tutorials
  metadata: {
    type: "tutorial",
    title: string,               // e.g., "CS1 Tutorial"
    subjectCode: string,
    totalChoiceCount: number,    // Total number of choices
    locations: [
      {
        location: string,        // e.g., "London"
        choiceCount: number,     // Number of choices for this location
        choices: [
          {
            choice: "1st" | "2nd" | "3rd",
            variationId: number,
            eventId: number,
            variationName: string,
            eventTitle: string,
            eventCode: string,
            venue: string,
            startDate: string,
            endDate: string,
            price: string
          }
        ]
      }
    ]
  },
  priceInfo: {
    priceType: "standard" | "retaker" | "additional",
    actualPrice: number,
    metadata: { ... }  // Same as above
  }
}
```

### API Specifications
[Source: C:\Code\Admin3\frontend\react-Admin3\src\services\cartService.js]

**Current Cart API:**
- `cartService.fetchCart()` - GET /api/cart/ - Fetch current cart
- `cartService.addToCart(product, quantity, priceInfo)` - POST /api/cart/add/ - Add item
- `cartService.removeItem(itemId)` - DELETE /api/cart/items/{id}/ - Remove item
- `cartService.clearCart()` - POST /api/cart/clear/ - Clear all items

**Required Updates:**
- Need update endpoint: PUT /api/cart/items/{id}/ - Update cart item metadata
- OR modify addToCart to handle merging on backend

### File Locations
[Source: C:\Code\Admin3\docs\architecture\source-tree.md]

**Frontend Files:**
- `frontend/react-Admin3/src/contexts/CartContext.js` - Cart state management
- `frontend/react-Admin3/src/contexts/TutorialChoiceContext.js` - Tutorial choice state
- `frontend/react-Admin3/src/components/Product/ProductCard/Tutorial/TutorialProductCard.js` - Tutorial card component
- `frontend/react-Admin3/src/services/cartService.js` - Cart API service

**Backend Files:**
- `backend/django_Admin3/cart/views.py` - Cart API views
- `backend/django_Admin3/cart/serializers.py` - Cart serializers
- `backend/django_Admin3/cart/models.py` - Cart models

**Test Files:**
- `frontend/react-Admin3/src/contexts/__tests__/CartContext.test.js`
- `frontend/react-Admin3/src/components/Product/ProductCard/Tutorial/__tests__/TutorialProductCard.test.js`
- `backend/django_Admin3/cart/tests/test_views.py`

### Component Specifications

#### CartContext New Methods
```javascript
// Find existing cart item by subject code
const findCartItemBySubject = (subjectCode) => {
  return cartItems.find(
    item => item.subject_code === subjectCode && item.type === "Tutorial"
  );
};

// Updated addToCart with merge logic
const addToCart = async (product, priceInfo = {}) => {
  // Find existing item
  const existingItem = findCartItemBySubject(product.subject_code);

  if (existingItem) {
    // MERGE: Update existing item with new choices
    const updatedMetadata = mergeChoices(existingItem.metadata, priceInfo.metadata);
    await cartService.updateCartItem(existingItem.id, updatedMetadata);
  } else {
    // ADD: Create new cart item
    await cartService.addToCart(product, 1, priceInfo);
  }

  // Mark choices as added
  markChoicesAsAdded(product.subject_code);

  // Refresh cart
  await refreshCart();
};
```

#### TutorialChoiceContext New Methods
```javascript
// Mark choices as draft (for cart removal)
const markChoicesAsDraft = (subjectCode) => {
  setTutorialChoices(prev => {
    const newChoices = { ...prev };
    if (newChoices[subjectCode]) {
      Object.keys(newChoices[subjectCode]).forEach(level => {
        newChoices[subjectCode][level].isDraft = true;
      });
    }
    return newChoices;
  });
};
```

### Technical Constraints
[Source: C:\Code\Admin3\docs\architecture\tech-stack.md]

**State Management:**
- React Context API for global state
- Bidirectional sync between TutorialChoiceContext and CartContext

**API Communication:**
- Axios for HTTP requests
- Proper error handling for all API calls
- Optimistic UI updates with rollback on error

**Testing Requirements:**
- 100% test coverage for critical cart logic
- Test both frontend and backend changes
- Integration tests for full workflows
- End-to-end tests for user scenarios

### Performance Considerations
[Source: C:\Code\Admin3\docs\architecture\tech-stack.md#Performance Considerations]

**Frontend Optimization:**
- Use React.memo for TutorialProductCard (already implemented)
- Memoize callbacks in TutorialProductCard (already implemented)
- Avoid unnecessary re-renders during cart updates
- Use useMemo for expensive cart calculations

**Backend Optimization:**
- Use database transactions for cart updates
- Optimize cart queries with select_related/prefetch_related
- Cache cart data where appropriate

### Security Considerations
[Source: C:\Code\Admin3\docs\architecture\coding-standards.md#Security Standards]

**Validation:**
- Validate metadata structure on backend
- Prevent injection attacks in metadata
- Ensure user can only modify their own cart
- Validate subject codes against actual products

**Error Handling:**
- Gracefully handle cart conflicts
- Provide user-friendly error messages
- Log errors for debugging
- Rollback on partial failures

### TDD Workflow Requirements

This story MUST follow strict Test-Driven Development (RED-GREEN-REFACTOR):

**RED Phase:**
1. Write failing test for cart item lookup
2. Write failing test for choice merging
3. Write failing test for state transitions
4. Write failing test for bidirectional sync
5. Verify all tests fail before implementation

**GREEN Phase:**
1. Implement minimal cart lookup logic
2. Implement minimal merging logic
3. Implement minimal state transitions
4. Implement minimal bidirectional sync
5. Verify all tests pass

**REFACTOR Phase:**
1. Refactor for clarity and performance
2. Remove duplication between contexts
3. Improve error handling
4. Optimize re-render behavior
5. Ensure all tests still pass

### Edge Cases to Test

1. **Empty Cart:** Adding first choice to empty cart
2. **Partial Choices:** Adding 1st choice, then 2nd, then 3rd incrementally
3. **Duplicate Event:** Attempting to add same event twice
4. **Multiple Subjects:** Adding choices for different subjects
5. **Cart Removal:** Removing item should restore draft state
6. **Concurrent Updates:** Rapid sequential additions
7. **Network Errors:** Handle API failures gracefully
8. **localStorage Failures:** Handle storage quota exceeded

### Migration Strategy

**Phase 1: Implement Lookup and Merge (Non-Breaking)**
1. Add `findCartItemBySubject()` helper
2. Implement merge logic in `addToCart()`
3. Maintain backward compatibility (new logic only activates for tutorials)

**Phase 2: Add State Transitions**
1. Integrate with Story 1.1's `markChoicesAsAdded()`
2. Call after successful cart operations
3. No breaking changes to existing API

**Phase 3: Add Bidirectional Sync**
1. Implement `markChoicesAsDraft()`
2. Hook into cart removal logic
3. Optional feature (doesn't break if not implemented)

**Phase 4: Testing and Validation**
1. Run full test suite
2. Manual testing of all scenarios
3. Performance testing
4. Security validation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
