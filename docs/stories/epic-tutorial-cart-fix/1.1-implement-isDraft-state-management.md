# Story 1.1: Implement isDraft State Management

## Status
Draft

## Story
**As a** developer maintaining the tutorial cart integration,
**I want** to add `isDraft` flag state management to tutorial choice data structure,
**so that** I can distinguish between draft selections and items actually added to the cart

## Acceptance Criteria
1. Tutorial choice data structure includes `isDraft: boolean` flag for each choice
2. New helper methods implemented:
   - `markChoicesAsAdded(subjectCode)` - Sets `isDraft: false` for all choices of a subject
   - `getDraftChoices(subjectCode)` - Returns only choices where `isDraft: true`
   - `getCartedChoices(subjectCode)` - Returns only choices where `isDraft: false`
   - `hasCartedChoices(subjectCode)` - Returns true if subject has any carted choices
3. localStorage migration logic handles rollback from new to old structure
4. Backward compatibility layer ensures existing localStorage data works
5. All existing functionality continues to work without regression
6. 80%+ test coverage for new state management logic

## Tasks / Subtasks

### Task 1: Add isDraft Flag to Choice Data Structure (AC: 1)
- [ ] Update `addTutorialChoice()` to include `isDraft: true` by default when adding new choices
- [ ] Update choice data type definition to include `isDraft: boolean` field
- [ ] Ensure all existing choice manipulation methods preserve `isDraft` state
- [ ] Test: Verify new choices have `isDraft: true` by default
- [ ] Test: Verify existing choice updates preserve `isDraft` state

### Task 2: Implement Helper Methods for Draft/Cart State (AC: 2)
- [ ] Implement `markChoicesAsAdded(subjectCode)` method:
  - Iterate through all choices for subject
  - Set `isDraft: false` for each choice
  - Update localStorage
  - Return updated choices
- [ ] Implement `getDraftChoices(subjectCode)` method:
  - Filter choices where `isDraft === true`
  - Return filtered array
- [ ] Implement `getCartedChoices(subjectCode)` method:
  - Filter choices where `isDraft === false`
  - Return filtered array
- [ ] Implement `hasCartedChoices(subjectCode)` method:
  - Check if any choices have `isDraft === false`
  - Return boolean
- [ ] Add all methods to TutorialChoiceContext value export
- [ ] Test: Unit test each helper method with various scenarios
- [ ] Test: Integration test helper methods with localStorage

### Task 3: Implement localStorage Migration Logic (AC: 3)
- [ ] Create migration utility function `migrateLocalStorageToIsDraft()`
- [ ] Detect old format (choices without `isDraft` field)
- [ ] Add `isDraft: false` to all existing choices (they were in cart)
- [ ] Store backup of old data with key `tutorialChoices_backup`
- [ ] Log migration success/failure
- [ ] Test: Verify migration from old to new format
- [ ] Test: Verify backup creation
- [ ] Test: Verify rollback capability

### Task 4: Implement Rollback Support (AC: 3)
- [ ] Create rollback utility function `rollbackLocalStorageIsDraft()`
- [ ] Check for existence of `tutorialChoices_backup`
- [ ] Restore backup data to `tutorialChoices`
- [ ] Remove `tutorialChoices_backup` after successful restore
- [ ] Log rollback success/failure
- [ ] Test: Verify rollback restores original data
- [ ] Test: Verify rollback handles missing backup gracefully

### Task 5: Implement Backward Compatibility Layer (AC: 4)
- [ ] Update `getSubjectChoices()` to handle choices without `isDraft` field
- [ ] Add default `isDraft: false` for legacy choices on read
- [ ] Update `getOrderedChoices()` to handle legacy format
- [ ] Update all getter methods to normalize legacy data
- [ ] Test: Verify reading old format data works correctly
- [ ] Test: Verify mixed old/new format data works correctly

### Task 6: Comprehensive Testing (AC: 5, 6)
- [ ] Write unit tests for `addTutorialChoice()` with `isDraft` flag
- [ ] Write unit tests for all new helper methods
- [ ] Write integration tests for localStorage migration
- [ ] Write integration tests for rollback functionality
- [ ] Write regression tests for existing functionality
- [ ] Achieve 80%+ test coverage for TutorialChoiceContext
- [ ] Test: Run full test suite and verify no regressions
- [ ] Test: Measure and verify test coverage meets 80%+ requirement

## Dev Notes

### Testing Standards
[Source: C:\Code\Admin3\docs\architecture\coding-standards.md#Testing Standards]

**Test Location:**
- Frontend tests: `frontend/react-Admin3/src/contexts/__tests__/TutorialChoiceContext.test.js`

**Test Framework:**
- React Testing Library for component/context testing
- Jest for test runner and assertions
- Mock Service Worker for API mocking (if needed)

**Test Requirements:**
- Test component rendering and user interactions
- Mock API calls in component tests
- Test form validation and error handling
- Use React Testing Library patterns

### Previous Story Insights
No previous story exists for this epic. This is the first story.

### Data Models
[Source: C:\Code\Admin3\frontend\react-Admin3\src\contexts\TutorialChoiceContext.js]

**Current Tutorial Choice Structure:**
```javascript
{
  subjectCode: {
    "1st": {
      eventId: number,
      variationId: number,
      variationName: string,
      eventTitle: string,
      eventCode: string,
      venue: string,
      startDate: string,
      endDate: string,
      choiceLevel: "1st" | "2nd" | "3rd",
      timestamp: ISO8601 string,
      variation: { prices: [...] }
    },
    "2nd": { ... },
    "3rd": { ... }
  }
}
```

**New Tutorial Choice Structure with isDraft:**
```javascript
{
  subjectCode: {
    "1st": {
      eventId: number,
      variationId: number,
      variationName: string,
      eventTitle: string,
      eventCode: string,
      venue: string,
      startDate: string,
      endDate: string,
      choiceLevel: "1st" | "2nd" | "3rd",
      timestamp: ISO8601 string,
      variation: { prices: [...] },
      isDraft: boolean  // NEW: true = draft selection, false = added to cart
    },
    "2nd": { ... },
    "3rd": { ... }
  }
}
```

### File Locations
[Source: C:\Code\Admin3\docs\architecture\source-tree.md#State Management]

**Primary File:**
- `frontend/react-Admin3/src/contexts/TutorialChoiceContext.js` - Tutorial selection state management

**Test File:**
- `frontend/react-Admin3/src/contexts/__tests__/TutorialChoiceContext.test.js` - Context tests

**localStorage Keys:**
- `tutorialChoices` - Main storage key
- `tutorialChoices_backup` - Backup for rollback support

### Component Specifications
[Source: C:\Code\Admin3\frontend\react-Admin3\src\contexts\TutorialChoiceContext.js]

**TutorialChoiceContext API (Current):**
- State: `tutorialChoices`, `showChoicePanel`, `activeSubject`
- Methods: `addTutorialChoice`, `removeTutorialChoice`, `removeSubjectChoices`, `updateChoiceLevel`
- Getters: `getSubjectChoices`, `getOrderedChoices`, `isChoiceLevelAvailable`, `getNextAvailableChoiceLevel`, `getTotalSubjectsWithChoices`, `getTotalChoices`, `isEventSelected`, `getEventChoiceLevel`
- Panel: `showChoicePanelForSubject`, `hideChoicePanel`
- Pricing: `getSubjectPrice`, `getTotalPrice`

**New Methods to Add:**
- `markChoicesAsAdded(subjectCode)` - Mark all choices as added to cart
- `getDraftChoices(subjectCode)` - Get only draft choices
- `getCartedChoices(subjectCode)` - Get only carted choices
- `hasCartedChoices(subjectCode)` - Check if subject has carted choices

### Technical Constraints
[Source: C:\Code\Admin3\docs\architecture\tech-stack.md]

**State Management:**
- React Context API for global state
- React Hooks for local state management
- localStorage for persistence

**Code Style:**
- Use functional components with hooks
- Use camelCase for props and state variables
- Implement proper error boundaries

**Testing Requirements:**
- Test coverage: Minimum 80% for new code
- Test both success and error cases
- Mock localStorage operations in tests

### Migration Strategy

**Phase 1: Add isDraft to New Choices**
1. Update `addTutorialChoice()` to add `isDraft: true` by default
2. Existing choices in localStorage remain unchanged (backward compatible)

**Phase 2: Migration on Context Load**
1. On `TutorialChoiceProvider` mount, check if migration is needed
2. If choices exist without `isDraft`, run migration:
   - Backup to `tutorialChoices_backup`
   - Add `isDraft: false` to all existing choices (they were already added)
   - Save migrated data

**Phase 3: Rollback Support**
1. Provide utility to rollback: `rollbackLocalStorageIsDraft()`
2. Restores from `tutorialChoices_backup`
3. Manual trigger only (not automatic)

**Phase 4: Backward Compatibility**
1. All getter methods handle missing `isDraft` field
2. Default to `isDraft: false` for legacy choices
3. No breaking changes to existing API

### TDD Workflow Requirements

This story MUST follow strict Test-Driven Development (RED-GREEN-REFACTOR):

**RED Phase:**
1. Write failing test for `isDraft` flag in new choices
2. Write failing tests for each helper method
3. Write failing tests for migration logic
4. Write failing tests for rollback functionality
5. Verify all tests fail before implementation

**GREEN Phase:**
1. Implement minimal code to make `isDraft` tests pass
2. Implement helper methods to make tests pass
3. Implement migration logic to make tests pass
4. Implement rollback to make tests pass
5. Verify all tests pass

**REFACTOR Phase:**
1. Refactor code for clarity and performance
2. Remove duplication
3. Improve naming and structure
4. Ensure all tests still pass

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story creation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
