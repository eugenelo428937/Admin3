# Tasks: Phase 6 - Legacy Code Removal (VAT Calculation)

**Input**: Implementation plan `plans/spec-2025-10-06-121922-plan.md`
**Phase Goal**: Remove all hardcoded VAT logic from Python code and ensure 100% of VAT calculations come from Rules Engine
**Phase Duration**: 1-2 days
**Branch**: `004-phase-4` (current branch with Phase 5 complete)

---

## Phase 6 Overview

### Objectives
- Delete all legacy hardcoded VAT calculation code
- Remove all hardcoded VAT rates from Python code
- Ensure 100% of VAT logic resides in Rules Engine
- Verify no broken imports or references
- Create regression tests to prevent hardcoded VAT logic

### Success Criteria
- ✅ No hardcoded VAT calculations in Python code (`vat_rate *`, `Decimal('0.20')`, etc.)
- ✅ All VAT logic in Rules Engine (via VAT Orchestrator)
- ✅ Regression tests passing
- ✅ No broken imports or references
- ✅ Test coverage maintained at 80%+

---

## Task List

### TASK-601: Audit Codebase for Hardcoded VAT Logic (TDD RED)
**Priority:** High
**TDD Stage:** RED
**Estimate:** 1 hour
**Status:** Pending
**Dependencies:** Phase 5 complete

**Description:**
Create comprehensive tests that FAIL if any hardcoded VAT logic exists in the codebase. These tests will serve as regression tests to ensure legacy code removal is complete.

**Files:**
- `backend/django_Admin3/vat/tests/test_legacy_vat_removal.py` (NEW)

**Test Cases:**
```python
import pytest
import re
from pathlib import Path

@pytest.mark.django_db
class TestLegacyVATRemoval:
    """Regression tests to ensure no hardcoded VAT logic remains."""

    def test_no_hardcoded_vat_rates_in_python_code(self):
        """RED: Verify no hardcoded VAT rates like Decimal('0.20') exist."""
        # Search for patterns like Decimal('0.20'), Decimal('0.15'), etc.
        backend_path = Path(__file__).parent.parent.parent
        hardcoded_patterns = [
            r"Decimal\(['\"]0\.20['\"]",  # 20% VAT
            r"Decimal\(['\"]0\.15['\"]",  # 15% VAT
            r"Decimal\(['\"]0\.23['\"]",  # 23% VAT (Ireland)
            r"vat_rate\s*=\s*0\.20",
            r"vat_rate\s*=\s*Decimal\(",
            r"\*\s*0\.2[0-9]",  # Multiplication by VAT rates
        ]

        violations = []
        exclude_dirs = ['migrations', 'tests', '__pycache__', '.venv']

        for pattern in hardcoded_patterns:
            for py_file in backend_path.rglob('*.py'):
                if any(excluded in str(py_file) for excluded in exclude_dirs):
                    continue

                content = py_file.read_text()
                if re.search(pattern, content):
                    violations.append(f"{py_file}: matches pattern {pattern}")

        # TEST SHOULD FAIL INITIALLY (RED)
        assert len(violations) == 0, f"Found hardcoded VAT rates:\n" + "\n".join(violations)

    def test_no_vat_rates_module_imports(self):
        """RED: Verify no imports of legacy vat_rates module."""
        backend_path = Path(__file__).parent.parent.parent

        violations = []
        import_patterns = [
            r"from\s+country\.vat_rates\s+import",
            r"import\s+country\.vat_rates",
            r"from\s+\.\.vat_rates\s+import",
        ]

        exclude_dirs = ['migrations', 'tests', '__pycache__', '.venv']

        for pattern in import_patterns:
            for py_file in backend_path.rglob('*.py'):
                if any(excluded in str(py_file) for excluded in exclude_dirs):
                    continue

                content = py_file.read_text()
                if re.search(pattern, content):
                    violations.append(f"{py_file}: imports vat_rates module")

        # TEST SHOULD FAIL INITIALLY (RED)
        assert len(violations) == 0, f"Found vat_rates imports:\n" + "\n".join(violations)

    def test_no_hardcoded_vat_calculation_functions(self):
        """RED: Verify no hardcoded VAT calculation functions remain."""
        # Patterns like: def calculate_vat(...): ... vat_rate * amount
        backend_path = Path(__file__).parent.parent.parent

        violations = []
        calc_patterns = [
            r"def\s+calculate_vat[_a-z]*\s*\([^)]*\):\s*[^}]+vat_rate\s*\*",
            r"vat_amount\s*=\s*.*\s*\*\s*vat_rate",
            r"net_amount\s*\*\s*Decimal\(['\"]0\.\d+['\"]",
        ]

        exclude_dirs = ['migrations', 'tests', '__pycache__', '.venv']
        exclude_files = ['custom_functions.py']  # This file SHOULD have calculate_vat_amount

        for pattern in calc_patterns:
            for py_file in backend_path.rglob('*.py'):
                if any(excluded in str(py_file) for excluded in exclude_dirs):
                    continue
                if py_file.name in exclude_files:
                    continue

                content = py_file.read_text()
                if re.search(pattern, content):
                    violations.append(f"{py_file}: contains hardcoded VAT calculation")

        # TEST SHOULD FAIL INITIALLY (RED)
        assert len(violations) == 0, f"Found hardcoded VAT calculations:\n" + "\n".join(violations)

    def test_all_vat_calculations_use_orchestrator(self):
        """RED: Verify all cart operations use VAT orchestrator."""
        # Check that cart views use vat_orchestrator.execute_vat_calculation
        from cart import views
        import inspect

        source = inspect.getsource(views)

        # Should contain vat_orchestrator calls
        assert 'vat_orchestrator.execute_vat_calculation' in source, \
            "Cart views should use vat_orchestrator.execute_vat_calculation"

        # Should NOT contain direct VAT calculations
        forbidden_patterns = [
            'vat_rate *',
            'calculate_vat_for_cart',
            'get_vat_rate',
        ]

        for pattern in forbidden_patterns:
            assert pattern not in source, \
                f"Cart views should not contain '{pattern}' - use VAT orchestrator"
```

**Acceptance Criteria:**
- ✅ Test file created with 4 comprehensive regression tests
- ✅ Tests FAIL initially (RED phase) - detecting existing legacy code
- ✅ Tests cover hardcoded rates, imports, calculation functions, orchestrator usage
- ✅ Tests exclude appropriate directories (migrations, tests, __pycache__)

---

### TASK-602: Delete Legacy vat_rates.py Module (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 30 minutes
**Status:** Pending
**Dependencies:** TASK-601

**Description:**
Delete the legacy `country/vat_rates.py` module and all imports referencing it.

**Files to Delete:**
- `backend/django_Admin3/country/vat_rates.py`

**Files to Update:**
- Search and remove all imports: `from country.vat_rates import *`
- Update any files importing `map_country_to_region`, `get_vat_rate`, etc.

**Commands:**
```bash
# Search for files importing vat_rates
cd backend/django_Admin3
grep -r "from country.vat_rates import" --include="*.py"
grep -r "import country.vat_rates" --include="*.py"

# Delete the module
rm country/vat_rates.py

# Run tests to find broken imports
python manage.py test --keepdb
```

**Acceptance Criteria:**
- ✅ `country/vat_rates.py` deleted
- ✅ All imports of `vat_rates` module removed
- ✅ `test_no_vat_rates_module_imports` test PASSES (GREEN)
- ✅ No broken imports remain

---

### TASK-603: Remove Hardcoded VAT Calculations from Cart Services (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 1 hour
**Status:** Pending
**Dependencies:** TASK-602

**Description:**
Remove any hardcoded VAT calculation logic from `cart/services.py` and ensure all VAT calculations go through the VAT orchestrator.

**Files to Update:**
- `backend/django_Admin3/cart/services.py`

**Changes:**
```python
# BEFORE (if exists - to be REMOVED):
from country.vat_rates import get_vat_rate
def calculate_cart_total(cart):
    for item in cart.items.all():
        vat_rate = get_vat_rate(item.product.region)
        item.vat_amount = item.actual_price * vat_rate
        item.save()

# AFTER (should already exist from Phase 5):
from cart.services.vat_orchestrator import vat_orchestrator
def calculate_cart_total(cart):
    # VAT calculation handled by orchestrator (Phase 5)
    vat_orchestrator.execute_vat_calculation(cart)
```

**Search Patterns:**
```bash
# Find hardcoded VAT patterns
grep -r "vat_rate =" backend/django_Admin3/cart/ --include="*.py" --exclude-dir=tests
grep -r "Decimal('0.20')" backend/django_Admin3/cart/ --include="*.py" --exclude-dir=tests
grep -r "* 0.2" backend/django_Admin3/cart/ --include="*.py" --exclude-dir=tests
```

**Acceptance Criteria:**
- ✅ No hardcoded VAT calculation logic in `cart/services.py`
- ✅ All VAT calculations use `vat_orchestrator.execute_vat_calculation`
- ✅ `test_no_hardcoded_vat_rates_in_python_code` test PASSES
- ✅ All cart service tests passing

---

### TASK-604: Remove Hardcoded VAT from Order Processing (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 1 hour
**Status:** Pending
**Dependencies:** TASK-603

**Description:**
Remove any hardcoded VAT logic from order processing and ensure orders use VAT calculations from cart.vat_result.

**Files to Update:**
- `backend/django_Admin3/orders/services.py`
- `backend/django_Admin3/orders/models.py` (if has hardcoded VAT)

**Changes:**
```python
# BEFORE (if exists - to be REMOVED):
def create_order_from_cart(cart):
    for item in cart.items.all():
        vat_amount = item.actual_price * Decimal('0.20')
        OrderItem.objects.create(
            order=order,
            price=item.actual_price,
            vat_amount=vat_amount
        )

# AFTER:
def create_order_from_cart(cart):
    # Use VAT from cart.vat_result (calculated by Rules Engine)
    vat_result = cart.vat_result
    if not vat_result or vat_result.get('status') != 'calculated':
        raise ValueError("Cart VAT must be calculated before creating order")

    for item in cart.items.all():
        # Find VAT for this item from vat_result
        item_vat = next(
            (v for v in vat_result['items'] if str(v['id']) == str(item.id)),
            None
        )
        if not item_vat:
            raise ValueError(f"VAT not found for cart item {item.id}")

        OrderItem.objects.create(
            order=order,
            price=item.actual_price,
            vat_amount=Decimal(item_vat['vat_amount']),
            vat_rate=Decimal(item_vat['vat_rate']),
            vat_region=item_vat.get('vat_region', 'ROW')
        )
```

**Search Patterns:**
```bash
# Find hardcoded VAT in orders
grep -r "Decimal('0.20')" backend/django_Admin3/orders/ --include="*.py" --exclude-dir=tests
grep -r "vat_amount = " backend/django_Admin3/orders/ --include="*.py" --exclude-dir=tests
```

**Acceptance Criteria:**
- ✅ No hardcoded VAT in `orders/services.py`
- ✅ Orders use VAT from `cart.vat_result`
- ✅ Order creation validates that cart VAT is calculated
- ✅ All order service tests passing
- ✅ `test_no_hardcoded_vat_calculation_functions` test PASSES

---

### TASK-605: Search and Remove Any Remaining Hardcoded VAT (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 1 hour
**Status:** Pending
**Dependencies:** TASK-604

**Description:**
Perform comprehensive search for any remaining hardcoded VAT logic and remove it.

**Search Commands:**
```bash
cd backend/django_Admin3

# Search for hardcoded VAT rates
grep -r "Decimal('0.20')" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv
grep -r "Decimal('0.15')" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv
grep -r "Decimal('0.23')" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv

# Search for VAT calculation patterns
grep -r "vat_rate\s*=" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv
grep -r "vat_amount\s*=.*\*" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv

# Search for VAT-related function definitions
grep -r "def calculate_vat" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv
grep -r "def get_vat_rate" --include="*.py" --exclude-dir=migrations --exclude-dir=tests --exclude-dir=.venv
```

**Files to Check:**
- `backend/django_Admin3/products/`
- `backend/django_Admin3/tutorials/`
- `backend/django_Admin3/exam_sessions/`
- `backend/django_Admin3/userprofile/`
- Any other apps that might have VAT logic

**Exceptions (ALLOWED to have VAT logic):**
- `rules_engine/custom_functions.py` - Contains `calculate_vat_amount` function (this is correct)
- `cart/services/vat_orchestrator.py` - Orchestrates VAT via Rules Engine (this is correct)
- Test files (`*/tests/*.py`) - Can have hardcoded test data

**Acceptance Criteria:**
- ✅ All hardcoded VAT rates removed (except in tests and custom_functions.py)
- ✅ All hardcoded VAT calculations removed (except orchestrator)
- ✅ Search commands return ZERO results (except allowed exceptions)
- ✅ All regression tests PASSING

---

### TASK-606: Verify Orchestrator Usage in All Entry Points (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 30 minutes
**Status:** Pending
**Dependencies:** TASK-605

**Description:**
Verify that all cart entry points (add_to_cart, update_item, remove_item, checkout) use the VAT orchestrator correctly.

**Files to Verify:**
- `backend/django_Admin3/cart/views.py`
- `backend/django_Admin3/cart/viewsets.py` (if exists)

**Verification Checklist:**
```python
# All entry points should use vat_orchestrator

# ✅ add_to_cart
def add_to_cart(self, request):
    # ... add item to cart
    vat_orchestrator.execute_vat_calculation(cart)
    # ... return response

# ✅ update_item
def update_item(self, request):
    # ... update item
    vat_orchestrator.execute_vat_calculation(cart)
    # ... return response

# ✅ remove_item
def remove_item(self, request):
    # ... remove item
    vat_orchestrator.execute_vat_calculation(cart)
    # ... return response

# ✅ checkout_start / checkout_payment
def checkout_start(self, request):
    # ... validate cart
    vat_orchestrator.execute_vat_calculation(cart)
    # ... proceed to payment
```

**Test Cases:**
```python
def test_all_entry_points_use_orchestrator(self):
    """Verify all cart entry points use VAT orchestrator."""
    from cart import views
    import inspect

    source = inspect.getsource(views)

    # Count occurrences of vat_orchestrator.execute_vat_calculation
    orchestrator_calls = source.count('vat_orchestrator.execute_vat_calculation')

    # Should have calls at: add_to_cart, update_item, remove_item, checkout_start
    assert orchestrator_calls >= 4, \
        f"Expected at least 4 orchestrator calls, found {orchestrator_calls}"
```

**Acceptance Criteria:**
- ✅ All cart entry points use `vat_orchestrator.execute_vat_calculation`
- ✅ No direct VAT calculations in views
- ✅ `test_all_vat_calculations_use_orchestrator` test PASSES
- ✅ All cart API tests passing

---

### TASK-607: Run Full Regression Test Suite (TDD GREEN)
**Priority:** High
**TDD Stage:** GREEN
**Estimate:** 30 minutes
**Status:** Pending
**Dependencies:** TASK-606

**Description:**
Run complete test suite to verify legacy code removal is successful and no functionality broken.

**Test Commands:**
```bash
cd backend/django_Admin3

# Run legacy removal tests
python manage.py test vat.tests.test_legacy_vat_removal --keepdb -v 2

# Run all VAT tests
python manage.py test vat.tests --keepdb -v 2

# Run cart tests
python manage.py test cart.tests --keepdb -v 2

# Run order tests
python manage.py test orders.tests --keepdb -v 2

# Run full test suite
python manage.py test --keepdb
```

**Expected Results:**
- ✅ `test_no_hardcoded_vat_rates_in_python_code` PASSING
- ✅ `test_no_vat_rates_module_imports` PASSING
- ✅ `test_no_hardcoded_vat_calculation_functions` PASSING
- ✅ `test_all_vat_calculations_use_orchestrator` PASSING
- ✅ All Phase 5 VAT orchestrator tests PASSING
- ✅ All cart tests PASSING
- ✅ All order tests PASSING

**Acceptance Criteria:**
- ✅ All regression tests PASSING (100% pass rate)
- ✅ All existing tests PASSING (no regressions)
- ✅ Test coverage maintained at 80%+

---

### TASK-608: Create Phase 6 Completion Documentation (REFACTOR)
**Priority:** Medium
**TDD Stage:** REFACTOR
**Estimate:** 1 hour
**Status:** Pending
**Dependencies:** TASK-607

**Description:**
Create comprehensive Phase 6 completion documentation.

**File:** `backend/django_Admin3/docs/qa/phase-6-legacy-code-removal-completion.md`

**Content Structure:**
```markdown
# Phase 6: Legacy Code Removal - Completion Report

## Executive Summary
- **Phase Goal**: Remove all hardcoded VAT logic from Python code
- **Status**: ✅ COMPLETE
- **Test Results**: All regression tests PASSING

## Deleted Files
- `country/vat_rates.py` - Legacy hardcoded VAT rates

## Updated Files
- `cart/services.py` - Removed hardcoded VAT calculations
- `orders/services.py` - Removed hardcoded VAT from order processing
- [List all updated files]

## Regression Test Results
- `test_no_hardcoded_vat_rates_in_python_code`: ✅ PASS
- `test_no_vat_rates_module_imports`: ✅ PASS
- `test_no_hardcoded_vat_calculation_functions`: ✅ PASS
- `test_all_vat_calculations_use_orchestrator`: ✅ PASS

## Verification Commands
```bash
# Verify no hardcoded VAT rates
grep -r "Decimal('0.20')" backend/django_Admin3/ --include="*.py" --exclude-dir=tests

# Verify no vat_rates imports
grep -r "from country.vat_rates import" backend/django_Admin3/ --include="*.py"

# Run regression tests
python manage.py test vat.tests.test_legacy_vat_removal --keepdb -v 2
```

## Architecture Compliance
- ✅ 100% of VAT logic in Rules Engine
- ✅ Zero hardcoded VAT calculations in Python
- ✅ All VAT calculations via vat_orchestrator
- ✅ All entry points using orchestrator

## Next Phase
Phase 7: Django Admin Interface for VAT management
```

**Acceptance Criteria:**
- ✅ Completion report created
- ✅ All deleted files documented
- ✅ All updated files listed
- ✅ Regression test results included
- ✅ Verification commands provided
- ✅ Architecture compliance verified

---

## Phase 6 Summary

**Total Tasks:** 8 (TASK-601 through TASK-608)
**Estimated Time:** 6-7 hours (less than 1 day)
**TDD Breakdown:**
- RED Phase: 1 task (regression test creation)
- GREEN Phase: 6 tasks (legacy code removal)
- REFACTOR Phase: 1 task (documentation)

**Files to Delete:**
- `country/vat_rates.py`

**Files to Update:**
- `cart/services.py`
- `orders/services.py`
- Any other files with hardcoded VAT logic

**New Files:**
- `vat/tests/test_legacy_vat_removal.py` (regression tests)
- `docs/qa/phase-6-legacy-code-removal-completion.md`

**Success Criteria:**
- ✅ All regression tests PASSING
- ✅ Zero hardcoded VAT logic in Python code
- ✅ 100% of VAT calculations via Rules Engine
- ✅ Test coverage maintained at 80%+
- ✅ No broken functionality

---

## Dependencies

**Prerequisites:**
- Phase 5 (Entry Point Integration) COMPLETE
- VAT Orchestrator functional
- Rules Engine VAT rules active
- cart.vat_result JSONB storage working

**Blocks:**
- Phase 7: Django Admin Interface

---

## Execution Order

1. **TASK-601** (RED): Create regression tests that FAIL initially
2. **TASK-602** (GREEN): Delete vat_rates.py → Make test pass
3. **TASK-603** (GREEN): Remove hardcoded VAT from cart
4. **TASK-604** (GREEN): Remove hardcoded VAT from orders
5. **TASK-605** (GREEN): Search and remove any remaining VAT
6. **TASK-606** (GREEN): Verify orchestrator usage
7. **TASK-607** (GREEN): Run full regression suite
8. **TASK-608** (REFACTOR): Create completion documentation

---

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| Accidentally break VAT functionality | HIGH | Comprehensive regression tests before deletion, run tests after each file deletion |
| Miss hardcoded VAT in obscure files | MEDIUM | Use multiple search patterns, automated regression tests |
| Break order processing | HIGH | Test order creation before/after, verify cart.vat_result usage |
| Incomplete orchestrator integration | MEDIUM | Verify all entry points, test each cart operation |

---

*Generated for Phase 6: Legacy Code Removal*
*Based on: plans/spec-2025-10-06-121922-plan.md*
*TDD Methodology: RED-GREEN-REFACTOR*
