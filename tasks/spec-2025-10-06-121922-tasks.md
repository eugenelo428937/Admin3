# Tasks: Dynamic VAT Calculation System (Rules Engine-Based)

**Epic**: Epic 3 - Dynamic VAT Calculation System
**Input**: `plans/spec-2025-10-06-121922-plan.md`
**Feature Branch**: `003-vat-calculation-rules-engine`
**Duration**: 19-27 days (4-5 weeks)

## Overview

This task breakdown follows strict TDD methodology (RED → GREEN → REFACTOR) to implement a fully Rules Engine-driven VAT calculation system with ZERO hardcoded Python logic.

### Key Principles
- ✅ **Database-Driven**: VAT rates in `utils_countrys.vat_percent` (not code)
- ✅ **Data Separation**: `utils_countrys` (VAT) vs `country_country` (users)
- ✅ **Rules Engine Authority**: 100% VAT logic in Rules Engine
- ✅ **TDD Mandatory**: All tests MUST fail before implementation

---

## Phase 1: Database Foundation (3-4 days)

### Phase 1.1: Setup Utils App

- [ ] **T001** [P] Create utils Django app structure
  - **Stage**: SETUP
  - **Description**: Run `python manage.py startapp utils` and configure INSTALLED_APPS
  - **Commands**:
    ```bash
    cd backend/django_Admin3
    python manage.py startapp utils
    ```
  - **Files to modify**: `backend/django_Admin3/django_Admin3/settings.py` (add 'utils' to INSTALLED_APPS)
  - **Verification**: App created in `backend/django_Admin3/utils/`
  - **Time**: 0.5 hours
  - **Dependencies**: None

### Phase 1.2: UtilsRegion Model (TDD)

- [ ] **T002** [P] Create tests for UtilsRegion model (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT region master data
  - **Test File**: `backend/django_Admin3/utils/tests/test_models.py`
  - **Test Cases**:
    - Test region creation with code, name, description
    - Test unique constraint on code field
    - Test active/inactive status
    - Test string representation
  - **Expected Result**: Tests FAIL (model doesn't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T001

- [ ] **T003** Create UtilsRegion model (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement UtilsRegion model to pass tests
  - **File**: `backend/django_Admin3/utils/models.py`
  - **Code**:
    ```python
    class UtilsRegion(models.Model):
        code = models.CharField(max_length=10, unique=True, primary_key=True)
        name = models.CharField(max_length=100)
        description = models.TextField(blank=True)
        active = models.BooleanField(default=True)
        created_at = models.DateTimeField(auto_now_add=True)
        updated_at = models.DateTimeField(auto_now=True)

        class Meta:
            db_table = 'utils_regions'
            verbose_name = 'VAT Region'
            verbose_name_plural = 'VAT Regions'

        def __str__(self):
            return f"{self.code} - {self.name}"
    ```
  - **Verification**: Run `python manage.py test utils.tests.test_models::UtilsRegionTestCase` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T002

- [ ] **T004** Create migration for UtilsRegion
  - **Stage**: GREEN
  - **Description**: Create and run database migration
  - **Commands**:
    ```bash
    python manage.py makemigrations utils
    python manage.py migrate utils
    ```
  - **Verification**: Check database has `utils_regions` table
  - **Time**: 0.5 hours
  - **Dependencies**: T003

### Phase 1.3: UtilsCountrys Model (TDD)

- [ ] **T005** [P] Create tests for UtilsCountrys model (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT country data with vat_percent
  - **Test File**: `backend/django_Admin3/utils/tests/test_models.py`
  - **Test Cases**:
    - Test country creation with code, name, vat_percent
    - Test Decimal precision (2 decimal places)
    - Test default vat_percent = 0.00
    - Test unique constraint on code
    - Test vat_percent validation (0-100 range)
  - **Expected Result**: Tests FAIL (model doesn't exist yet)
  - **Time**: 1.5 hours
  - **Dependencies**: T001

- [ ] **T006** Create UtilsCountrys model (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement UtilsCountrys model to pass tests
  - **File**: `backend/django_Admin3/utils/models.py`
  - **Code**:
    ```python
    from decimal import Decimal

    class UtilsCountrys(models.Model):
        code = models.CharField(max_length=2, unique=True, primary_key=True)
        name = models.CharField(max_length=100)
        vat_percent = models.DecimalField(
            max_digits=5,
            decimal_places=2,
            default=Decimal('0.00'),
            validators=[MinValueValidator(0), MaxValueValidator(100)],
            help_text="VAT percentage (e.g., 20.00 for 20%)"
        )
        active = models.BooleanField(default=True)
        created_at = models.DateTimeField(auto_now_add=True)
        updated_at = models.DateTimeField(auto_now=True)

        class Meta:
            db_table = 'utils_countrys'
            verbose_name = 'VAT Country'
            verbose_name_plural = 'VAT Countries'
    ```
  - **Verification**: Run `python manage.py test utils.tests.test_models::UtilsCountrysTestCase` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T005

- [ ] **T007** Create migration for UtilsCountrys
  - **Stage**: GREEN
  - **Description**: Create and run database migration
  - **Commands**:
    ```bash
    python manage.py makemigrations utils
    python manage.py migrate utils
    ```
  - **Verification**: Check database has `utils_countrys` table with vat_percent column
  - **Time**: 0.5 hours
  - **Dependencies**: T006

### Phase 1.4: UtilsCountryRegion Mapping Model (TDD)

- [ ] **T008** [P] Create tests for UtilsCountryRegion model (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for country-to-region mapping with effective dates
  - **Test File**: `backend/django_Admin3/utils/tests/test_models.py`
  - **Test Cases**:
    - Test mapping creation with country, region, effective_from
    - Test effective_to optional field
    - Test unique_together constraint (country, effective_from)
    - Test foreign key relationships
    - Test effective date validation (effective_to > effective_from)
  - **Expected Result**: Tests FAIL (model doesn't exist yet)
  - **Time**: 1.5 hours
  - **Dependencies**: T001

- [ ] **T009** Create UtilsCountryRegion model (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement UtilsCountryRegion model to pass tests
  - **File**: `backend/django_Admin3/utils/models.py`
  - **Code**:
    ```python
    class UtilsCountryRegion(models.Model):
        country = models.ForeignKey('UtilsCountrys', on_delete=models.CASCADE)
        region = models.ForeignKey(UtilsRegion, on_delete=models.CASCADE)
        effective_from = models.DateField()
        effective_to = models.DateField(null=True, blank=True)
        created_at = models.DateTimeField(auto_now_add=True)
        updated_at = models.DateTimeField(auto_now=True)

        class Meta:
            db_table = 'utils_country_region'
            unique_together = ['country', 'effective_from']

        def clean(self):
            if self.effective_to and self.effective_to <= self.effective_from:
                raise ValidationError('effective_to must be after effective_from')
    ```
  - **Verification**: Run `python manage.py test utils.tests.test_models::UtilsCountryRegionTestCase` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T008

- [ ] **T010** Create migration for UtilsCountryRegion
  - **Stage**: GREEN
  - **Description**: Create and run database migration
  - **Commands**:
    ```bash
    python manage.py makemigrations utils
    python manage.py migrate utils
    ```
  - **Verification**: Check database has `utils_country_region` table with foreign keys
  - **Time**: 0.5 hours
  - **Dependencies**: T009

### Phase 1.5: Data Migration

- [ ] **T011** Create data migration to populate utils tables (GREEN)
  - **Stage**: GREEN
  - **Description**: Populate utils_regions, utils_countrys, utils_country_region with initial data
  - **File**: `backend/django_Admin3/utils/migrations/0002_populate_vat_data.py`
  - **Data to populate**:
    - utils_regions: UK, IE, EU, SA, ROW
    - utils_countrys: Copy from country_country with VAT rates (UK=20%, IE=23%, SA=15%, ROW=0%)
    - utils_country_region: Map countries to regions (CH/GG → ROW)
  - **Commands**:
    ```bash
    python manage.py makemigrations utils --empty --name populate_vat_data
    # Edit migration file
    python manage.py migrate utils
    ```
  - **Verification**: Query database to verify data populated
  - **Time**: 2 hours
  - **Dependencies**: T004, T007, T010

- [ ] **T012** [P] Create tests for data migration (GREEN)
  - **Stage**: GREEN
  - **Description**: Test data migration populated all required data
  - **Test File**: `backend/django_Admin3/utils/tests/test_migrations.py`
  - **Test Cases**:
    - Test 5 regions created (UK, IE, EU, SA, ROW)
    - Test countries copied from country_country
    - Test VAT rates correct (UK=20, IE=23, SA=15)
    - Test CH and GG mapped to ROW
  - **Verification**: Run `python manage.py test utils.tests.test_migrations` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T011

### Phase 1.6: Django Admin Interfaces

- [ ] **T013** [P] Create Django admin for UtilsRegion
  - **Stage**: GREEN
  - **Description**: Register UtilsRegion in Django admin with search and filters
  - **File**: `backend/django_Admin3/utils/admin.py`
  - **Code**:
    ```python
    @admin.register(UtilsRegion)
    class UtilsRegionAdmin(admin.ModelAdmin):
        list_display = ['code', 'name', 'active', 'created_at']
        search_fields = ['code', 'name']
        list_filter = ['active']
    ```
  - **Verification**: Access `/admin/utils/utilsregion/` and verify display
  - **Time**: 0.5 hours
  - **Dependencies**: T004

- [ ] **T014** [P] Create Django admin for UtilsCountrys
  - **Stage**: GREEN
  - **Description**: Register UtilsCountrys with inline vat_percent editing
  - **File**: `backend/django_Admin3/utils/admin.py`
  - **Code**:
    ```python
    @admin.register(UtilsCountrys)
    class UtilsCountrysAdmin(admin.ModelAdmin):
        list_display = ['code', 'name', 'vat_percent', 'active']
        search_fields = ['code', 'name']
        list_filter = ['active']
        list_editable = ['vat_percent', 'active']
    ```
  - **Verification**: Access `/admin/utils/utilscountrys/` and test inline editing
  - **Time**: 0.5 hours
  - **Dependencies**: T007

- [ ] **T015** [P] Create Django admin for UtilsCountryRegion
  - **Stage**: GREEN
  - **Description**: Register UtilsCountryRegion with date filters
  - **File**: `backend/django_Admin3/utils/admin.py`
  - **Code**:
    ```python
    @admin.register(UtilsCountryRegion)
    class UtilsCountryRegionAdmin(admin.ModelAdmin):
        list_display = ['country', 'region', 'effective_from', 'effective_to']
        list_filter = ['region', 'effective_from']
        search_fields = ['country__name', 'region__name']
    ```
  - **Verification**: Access `/admin/utils/utilscountryregion/` and test filters
  - **Time**: 0.5 hours
  - **Dependencies**: T010

### Phase 1.7: Verification

- [ ] **T016** Run all Phase 1 tests and verify database
  - **Stage**: VERIFICATION
  - **Description**: Comprehensive verification of database foundation
  - **Commands**:
    ```bash
    python manage.py test utils --coverage
    python manage.py dbshell
    \dt utils_*
    SELECT * FROM utils_regions;
    ```
  - **Verification**:
    - All tests passing (100%)
    - All tables created
    - Data populated correctly
    - country_country unchanged (data separation verified)
  - **Time**: 1 hour
  - **Dependencies**: T002-T015

---

## Phase 2: Rules Engine Custom Functions (2 days)

### Phase 2.1: Custom Functions Tests (TDD)

- [ ] **T017** [P] Create tests for lookup_region function (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for region lookup from country code
  - **Test File**: `backend/django_Admin3/rules_engine/tests/test_custom_functions.py`
  - **Test Cases**:
    - Test lookup GB → UK region
    - Test lookup DE → EU region
    - Test lookup ZA → SA region
    - Test lookup CH → ROW region (Switzerland special case)
    - Test lookup with effective_date parameter
    - Test missing country returns None
  - **Expected Result**: Tests FAIL (function doesn't exist yet)
  - **Time**: 1.5 hours
  - **Dependencies**: T016

- [ ] **T018** [P] Create tests for lookup_vat_rate function (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT rate lookup from utils_countrys
  - **Test File**: `backend/django_Admin3/rules_engine/tests/test_custom_functions.py`
  - **Test Cases**:
    - Test lookup GB → Decimal('20.00')
    - Test lookup IE → Decimal('23.00')
    - Test lookup ZA → Decimal('15.00')
    - Test lookup unknown country → Decimal('0.00')
    - Test returns Decimal type (not float)
  - **Expected Result**: Tests FAIL (function doesn't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T016

- [ ] **T019** [P] Create tests for calculate_vat_amount function (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT calculation with ROUND_HALF_UP
  - **Test File**: `backend/django_Admin3/rules_engine/tests/test_custom_functions.py`
  - **Test Cases**:
    - Test Decimal('100.00') * Decimal('0.20') = Decimal('20.00')
    - Test Decimal('10.125') rounds to Decimal('10.13') (ROUND_HALF_UP)
    - Test Decimal('10.124') rounds to Decimal('10.12')
    - Test zero rate returns Decimal('0.00')
    - Test function accepts float and converts to Decimal
  - **Expected Result**: Tests FAIL (function doesn't exist yet)
  - **Time**: 1.5 hours
  - **Dependencies**: T016

### Phase 2.2: Custom Functions Implementation

- [ ] **T020** Implement lookup_region function (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement region lookup to pass T017 tests
  - **File**: `backend/django_Admin3/rules_engine/custom_functions.py`
  - **Code**:
    ```python
    from utils.models import UtilsCountryRegion
    from datetime import date

    def lookup_region(country_code, effective_date=None):
        if effective_date is None:
            effective_date = date.today()

        mapping = UtilsCountryRegion.objects.filter(
            country__code=country_code,
            effective_from__lte=effective_date
        ).filter(
            Q(effective_to__isnull=True) | Q(effective_to__gte=effective_date)
        ).first()

        return mapping.region.code if mapping else None
    ```
  - **Verification**: Run `python manage.py test rules_engine.tests.test_custom_functions::test_lookup_region` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T017

- [ ] **T021** Implement lookup_vat_rate function (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement VAT rate lookup to pass T018 tests
  - **File**: `backend/django_Admin3/rules_engine/custom_functions.py`
  - **Code**:
    ```python
    from utils.models import UtilsCountrys
    from decimal import Decimal

    def lookup_vat_rate(country_code):
        try:
            country = UtilsCountrys.objects.get(code=country_code, active=True)
            return country.vat_percent
        except UtilsCountrys.DoesNotExist:
            return Decimal('0.00')
    ```
  - **Verification**: Run `python manage.py test rules_engine.tests.test_custom_functions::test_lookup_vat_rate` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T018

- [ ] **T022** Implement calculate_vat_amount function (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement VAT calculation with ROUND_HALF_UP to pass T019 tests
  - **File**: `backend/django_Admin3/rules_engine/custom_functions.py`
  - **Code**:
    ```python
    from decimal import Decimal, ROUND_HALF_UP

    def calculate_vat_amount(net_amount, vat_rate):
        # Convert to Decimal if needed
        if not isinstance(net_amount, Decimal):
            net_amount = Decimal(str(net_amount))
        if not isinstance(vat_rate, Decimal):
            vat_rate = Decimal(str(vat_rate))

        # Calculate VAT
        vat_amount = net_amount * vat_rate

        # Round to 2 decimal places using ROUND_HALF_UP
        return vat_amount.quantize(Decimal('0.01'), rounding=ROUND_HALF_UP)
    ```
  - **Verification**: Run `python manage.py test rules_engine.tests.test_custom_functions::test_calculate_vat_amount` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T019

- [ ] **T023** Register functions in FUNCTION_REGISTRY (GREEN)
  - **Stage**: GREEN
  - **Description**: Register all custom functions in Rules Engine registry
  - **File**: `backend/django_Admin3/rules_engine/custom_functions.py`
  - **Code**:
    ```python
    FUNCTION_REGISTRY = {
        'lookup_region': lookup_region,
        'lookup_vat_rate': lookup_vat_rate,
        'calculate_vat_amount': calculate_vat_amount,
        'format_vat_rate_percent': format_vat_rate_percent,
    }
    ```
  - **Verification**: Import FUNCTION_REGISTRY and verify functions callable
  - **Time**: 0.5 hours
  - **Dependencies**: T020, T021, T022

### Phase 2.3: JSONLogic Helper

- [ ] **T024** [P] Create tests for for_each_item helper (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for cart item iteration in rules
  - **Test File**: `backend/django_Admin3/rules_engine/tests/test_jsonlogic_helpers.py`
  - **Test Cases**:
    - Test iteration over cart items
    - Test per-item context building
    - Test rule execution for each item
    - Test result collection
  - **Expected Result**: Tests FAIL (helper doesn't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T016

- [ ] **T025** Implement for_each_item helper (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement item iteration helper to pass T024 tests
  - **File**: `backend/django_Admin3/rules_engine/jsonlogic_helpers.py`
  - **Verification**: Run `python manage.py test rules_engine.tests.test_jsonlogic_helpers` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T024

### Phase 2.4: Verification

- [ ] **T026** Run all Phase 2 tests (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Verify all custom functions working correctly
  - **Commands**:
    ```bash
    python manage.py test rules_engine.tests.test_custom_functions --coverage
    python manage.py test rules_engine.tests.test_jsonlogic_helpers --coverage
    ```
  - **Verification**:
    - All tests passing
    - Functions return correct Decimal types
    - ROUND_HALF_UP rounding working
    - No hardcoded VAT rates in functions
  - **Time**: 1 hour
  - **Dependencies**: T017-T025

---

## Phase 3: Master VAT Rule Creation (2-3 days)

### Phase 3.1: Entry Point Setup

- [ ] **T027** Create calculate_vat entry point
  - **Stage**: SETUP
  - **Description**: Add calculate_vat entry point to RuleEntryPoint model
  - **File**: Django admin or data migration
  - **Data**:
    ```python
    RuleEntryPoint.objects.create(
        name='calculate_vat',
        description='Entry point for VAT calculation',
        active=True
    )
    ```
  - **Verification**: Query RuleEntryPoint table for 'calculate_vat'
  - **Time**: 0.5 hours
  - **Dependencies**: T026

### Phase 3.2: Master Rule Tests (TDD)

- [ ] **T028** [P] Create tests for master VAT rule execution (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for master rule routing logic
  - **Test File**: `backend/django_Admin3/vat/tests/test_master_rule.py`
  - **Test Cases**:
    - Test UK user → routes to calculate_vat_uk
    - Test EU user → routes to calculate_vat_eu
    - Test SA user → routes to calculate_vat_sa
    - Test IE user → routes to calculate_vat_ie
    - Test unknown region → routes to calculate_vat_row
    - Test audit trail created
  - **Expected Result**: Tests FAIL (master rule doesn't exist yet)
  - **Time**: 2 hours
  - **Dependencies**: T027

### Phase 3.3: Master Rule Creation

- [ ] **T029** Create master VAT rule via Django admin (GREEN)
  - **Stage**: GREEN
  - **Description**: Create calculate_vat master rule to pass T028 tests
  - **File**: Django admin ActedRule creation
  - **Rule JSON**:
    ```json
    {
      "rule_id": "calculate_vat",
      "name": "Master VAT Calculation",
      "entry_point": "calculate_vat",
      "priority": 100,
      "active": true,
      "version": 1,
      "condition": {"==": [1, 1]},
      "actions": [
        {
          "type": "call_function",
          "function": "lookup_region",
          "args": [{"var": "user.country"}, {"var": "settings.effective_date"}],
          "target": "context.region"
        },
        {
          "type": "call_rule",
          "rule_id": {
            "if": [
              {"==": [{"var": "context.region"}, "UK"]}, "calculate_vat_uk",
              {"==": [{"var": "context.region"}, "EU"]}, "calculate_vat_eu",
              {"==": [{"var": "context.region"}, "SA"]}, "calculate_vat_sa",
              {"==": [{"var": "context.region"}, "IE"]}, "calculate_vat_ie",
              "calculate_vat_row"
            ]
          }
        }
      ],
      "stop_processing": true
    }
    ```
  - **Verification**: Run `python manage.py test vat.tests.test_master_rule` → PASS
  - **Time**: 2 hours
  - **Dependencies**: T028

### Phase 3.4: API Integration Tests

- [ ] **T030** [P] Create tests for rules engine API execution (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for `/api/rules/engine/execute/` endpoint
  - **Test File**: `backend/django_Admin3/vat/tests/test_api.py`
  - **Test Cases**:
    - Test POST with entry_point="calculate_vat" and UK context
    - Test response includes execution_id
    - Test response includes rules_executed list
    - Test response includes context.region
    - Test audit trail created in VATAudit
  - **Expected Result**: Tests FAIL (API integration not complete)
  - **Time**: 1.5 hours
  - **Dependencies**: T029

- [ ] **T031** Implement API integration (GREEN)
  - **Stage**: GREEN
  - **Description**: Ensure API endpoint works with master rule
  - **File**: `backend/django_Admin3/rules_engine/views.py`
  - **Verification**: Run `python manage.py test vat.tests.test_api` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T030

### Phase 3.5: Verification

- [ ] **T032** Run all Phase 3 tests (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Verify master rule and routing working
  - **Commands**:
    ```bash
    python manage.py test vat.tests.test_master_rule --coverage
    python manage.py test vat.tests.test_api --coverage
    ```
  - **Verification**:
    - Master rule routes correctly
    - API endpoint functional
    - Audit trail created
  - **Time**: 1 hour
  - **Dependencies**: T027-T031

---

## Phase 4: Regional VAT Rules (3-4 days)

### Phase 4.1: UK VAT Rules (TDD)

- [ ] **T033** [P] Create tests for UK VAT rules (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for UK region VAT calculation
  - **Test File**: `backend/django_Admin3/vat/tests/test_uk_rules.py`
  - **Test Cases**:
    - Test UK digital product → 0% VAT
    - Test UK printed product → 20% VAT (from utils_countrys)
    - Test UK flash card → 20% VAT
    - Test UK PBOR → 20% VAT
    - Test exemption reason recorded for digital
  - **Expected Result**: Tests FAIL (UK rules don't exist yet)
  - **Time**: 2 hours
  - **Dependencies**: T032

- [ ] **T034** Create calculate_vat_uk rule (GREEN)
  - **Stage**: GREEN
  - **Description**: Create UK parent rule for item iteration
  - **File**: Django admin ActedRule creation
  - **Rule JSON**: See plan Phase 4.1
  - **Verification**: Partial - awaits sub-rules
  - **Time**: 1 hour
  - **Dependencies**: T033

- [ ] **T035** Create calculate_vat_uk_digital_product rule (GREEN)
  - **Stage**: GREEN
  - **Description**: Create UK digital product rule (0% VAT)
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_uk_rules::test_uk_digital` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T034

- [ ] **T036** Create calculate_vat_uk_printed_product rule (GREEN)
  - **Stage**: GREEN
  - **Description**: Create UK printed product rule (lookup vat_percent from utils_countrys)
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_uk_rules::test_uk_printed` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T034

- [ ] **T037** [P] Create calculate_vat_uk_flash_card and calculate_vat_uk_pbor rules (GREEN)
  - **Stage**: GREEN
  - **Description**: Create UK flash card and PBOR rules
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_uk_rules` → ALL PASS
  - **Time**: 1 hour
  - **Dependencies**: T034

### Phase 4.2: EU VAT Rules (TDD)

- [ ] **T038** [P] Create tests for EU VAT rules (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for EU B2B reverse charge (0% VAT)
  - **Test File**: `backend/django_Admin3/vat/tests/test_eu_rules.py`
  - **Test Cases**:
    - Test EU product → 0% VAT
    - Test exemption reason = "EU B2B reverse charge"
  - **Expected Result**: Tests FAIL (EU rules don't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T032

- [ ] **T039** Create calculate_vat_eu and calculate_vat_eu_product rules (GREEN)
  - **Stage**: GREEN
  - **Description**: Create EU rules for B2B reverse charge
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_eu_rules` → PASS
  - **Time**: 1.5 hours
  - **Dependencies**: T038

### Phase 4.3: SA VAT Rules (TDD)

- [ ] **T040** [P] Create tests for SA VAT rules (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for South Africa 15% VAT
  - **Test File**: `backend/django_Admin3/vat/tests/test_sa_rules.py`
  - **Test Cases**:
    - Test SA product → 15% VAT (from utils_countrys)
  - **Expected Result**: Tests FAIL (SA rules don't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T032

- [ ] **T041** Create calculate_vat_sa and calculate_vat_sa_product rules (GREEN)
  - **Stage**: GREEN
  - **Description**: Create SA rules for 15% standard rate
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_sa_rules` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T040

### Phase 4.4: IE VAT Rules (TDD)

- [ ] **T042** [P] Create tests for IE VAT rules (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for Ireland VAT
  - **Test File**: `backend/django_Admin3/vat/tests/test_ie_rules.py`
  - **Test Cases**:
    - Test IE product → 23% VAT (from utils_countrys)
  - **Expected Result**: Tests FAIL (IE rules don't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T032

- [ ] **T043** Create calculate_vat_ie and calculate_vat_ie_product rules (GREEN)
  - **Stage**: GREEN
  - **Description**: Create IE rules
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_ie_rules` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T042

### Phase 4.5: ROW VAT Rules (TDD)

- [ ] **T044** [P] Create tests for ROW VAT rules (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for Rest of World 0% VAT
  - **Test File**: `backend/django_Admin3/vat/tests/test_row_rules.py`
  - **Test Cases**:
    - Test ROW product → 0% VAT
    - Test CH (Switzerland) → ROW region → 0% VAT
    - Test GG (Guernsey) → ROW region → 0% VAT
  - **Expected Result**: Tests FAIL (ROW rules don't exist yet)
  - **Time**: 1 hour
  - **Dependencies**: T032

- [ ] **T045** Create calculate_vat_row and calculate_vat_row_product rules (GREEN)
  - **Stage**: GREEN
  - **Description**: Create ROW rules for 0% VAT
  - **File**: Django admin ActedRule creation
  - **Verification**: Run `python manage.py test vat.tests.test_row_rules` → PASS
  - **Time**: 1 hour
  - **Dependencies**: T044

### Phase 4.6: Integration Testing

- [ ] **T046** Create comprehensive regional rules integration tests (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Test all regions with mixed cart scenarios
  - **Test File**: `backend/django_Admin3/vat/tests/test_regional_integration.py`
  - **Test Cases**:
    - Test UK cart with mixed digital/physical → correct VAT amounts
    - Test EU cart → all 0% VAT
    - Test SA cart → all 15% VAT
    - Test rule execution order (priority + created_at)
    - Test stop_processing flags
  - **Commands**:
    ```bash
    python manage.py test vat.tests.test_regional_integration --coverage
    ```
  - **Verification**: All integration tests passing
  - **Time**: 2 hours
  - **Dependencies**: T033-T045

---

## Phase 5: Entry Point Integration (2-3 days)

### Phase 5.1: VAT Orchestrator (TDD)

- [ ] **T047** [P] Create tests for VAT calculation orchestrator (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT calculation orchestration
  - **Test File**: `backend/django_Admin3/vat/tests/test_orchestrator.py`
  - **Test Cases**:
    - Test context building from cart
    - Test rules execution
    - Test VAT aggregation
    - Test cart.vat_result JSONB population
    - Test VATAudit record creation
  - **Expected Result**: Tests FAIL (orchestrator doesn't exist yet)
  - **Time**: 2 hours
  - **Dependencies**: T046

- [ ] **T048** Implement VAT calculation orchestrator (GREEN)
  - **Stage**: GREEN
  - **Description**: Create orchestrator to pass T047 tests
  - **File**: `backend/django_Admin3/vat/orchestrator.py`
  - **Code**: See plan Phase 5.2
  - **Verification**: Run `python manage.py test vat.tests.test_orchestrator` → PASS
  - **Time**: 3 hours
  - **Dependencies**: T047

### Phase 5.2: Entry Point Handlers (TDD)

- [ ] **T049** [P] Create tests for add_to_cart VAT calculation (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT calculation when adding to cart
  - **Test File**: `backend/django_Admin3/cart/tests/test_vat_add_to_cart.py`
  - **Test Cases**:
    - Test add item to cart → VAT calculated
    - Test cart.vat_result updated
    - Test VATAudit created
  - **Expected Result**: Tests FAIL (integration not complete)
  - **Time**: 1.5 hours
  - **Dependencies**: T048

- [ ] **T050** Integrate VAT calculation with add_to_cart (GREEN)
  - **Stage**: GREEN
  - **Description**: Update cart views to trigger VAT calculation
  - **File**: `backend/django_Admin3/cart/views.py`
  - **Verification**: Run `python manage.py test cart.tests.test_vat_add_to_cart` → PASS
  - **Time**: 2 hours
  - **Dependencies**: T049

- [ ] **T051** [P] Create tests for checkout_start VAT calculation (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT recalculation at checkout start
  - **Test File**: `backend/django_Admin3/cart/tests/test_vat_checkout_start.py`
  - **Expected Result**: Tests FAIL
  - **Time**: 1.5 hours
  - **Dependencies**: T048

- [ ] **T052** Integrate VAT calculation with checkout_start (GREEN)
  - **Stage**: GREEN
  - **Description**: Update checkout views to recalculate VAT
  - **File**: `backend/django_Admin3/cart/views.py`
  - **Verification**: Run `python manage.py test cart.tests.test_vat_checkout_start` → PASS
  - **Time**: 2 hours
  - **Dependencies**: T051

- [ ] **T053** [P] Create tests for checkout_payment VAT validation (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for VAT validation at payment
  - **Test File**: `backend/django_Admin3/cart/tests/test_vat_checkout_payment.py`
  - **Expected Result**: Tests FAIL
  - **Time**: 1.5 hours
  - **Dependencies**: T048

- [ ] **T054** Integrate VAT validation with checkout_payment (GREEN)
  - **Stage**: GREEN
  - **Description**: Update payment views to validate VAT
  - **File**: `backend/django_Admin3/cart/views.py`
  - **Verification**: Run `python manage.py test cart.tests.test_vat_checkout_payment` → PASS
  - **Time**: 2 hours
  - **Dependencies**: T053

### Phase 5.3: Cart Serializer Update

- [ ] **T055** Update CartSerializer to include vat_result (GREEN)
  - **Stage**: GREEN
  - **Description**: Add vat_result and vatCalculations to cart API response
  - **File**: `backend/django_Admin3/cart/serializers.py`
  - **Code**:
    ```python
    class CartSerializer(serializers.ModelSerializer):
        vat_result = serializers.JSONField(read_only=True)
        vatCalculations = serializers.SerializerMethodField()

        def get_vatCalculations(self, obj):
            return obj.vat_result
    ```
  - **Verification**: GET `/api/cart/` includes vatCalculations field
  - **Time**: 1 hour
  - **Dependencies**: T048

### Phase 5.4: Discount Handling (TDD)

- [ ] **T056** [P] Create tests for discount allocation (RED)
  - **Stage**: RED
  - **Description**: Write failing tests for proportional discount allocation with VAT recalculation
  - **Test File**: `backend/django_Admin3/vat/tests/test_discount_allocation.py`
  - **Test Cases**:
    - Test proportional discount allocation across items
    - Test VAT recalculation on discounted net amounts
    - Test Decimal precision maintained
  - **Expected Result**: Tests FAIL
  - **Time**: 2 hours
  - **Dependencies**: T048

- [ ] **T057** Implement discount allocation algorithm (GREEN)
  - **Stage**: GREEN
  - **Description**: Implement proportional discount allocation with VAT recalc
  - **File**: `backend/django_Admin3/vat/discount_allocator.py`
  - **Verification**: Run `python manage.py test vat.tests.test_discount_allocation` → PASS
  - **Time**: 2.5 hours
  - **Dependencies**: T056

### Phase 5.5: Verification

- [ ] **T058** Run all Phase 5 integration tests (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Comprehensive verification of entry point integration
  - **Commands**:
    ```bash
    python manage.py test vat --coverage
    python manage.py test cart.tests.test_vat_* --coverage
    ```
  - **Verification**:
    - add_to_cart triggers VAT calculation
    - checkout_start recalculates VAT
    - checkout_payment validates VAT
    - cart.vat_result populated
    - VATAudit records created
    - Discount allocation working
  - **Time**: 1.5 hours
  - **Dependencies**: T047-T057

---

## Phase 6: Legacy Code Removal (1-2 days)

### Phase 6.1: Code Cleanup

- [ ] **T059** Delete vat_rates.py module
  - **Stage**: CLEANUP
  - **Description**: Remove hardcoded VAT rates module
  - **File to delete**: `backend/django_Admin3/country/vat_rates.py`
  - **Verification**: No broken imports, all tests still pass
  - **Time**: 0.5 hours
  - **Dependencies**: T058

- [ ] **T060** Delete product_classifier.py (if exists)
  - **Stage**: CLEANUP
  - **Description**: Remove product classifier (cart context has product_type)
  - **File to delete**: `backend/django_Admin3/vat/product_classifier.py`
  - **Verification**: No broken imports
  - **Time**: 0.5 hours
  - **Dependencies**: T058

- [ ] **T061** [P] Search and remove hardcoded VAT calculations
  - **Stage**: CLEANUP
  - **Description**: Find and remove all hardcoded VAT logic
  - **Commands**:
    ```bash
    grep -r "Decimal('0.20')" backend/
    grep -r "vat_rate = " backend/
    grep -r "* 0.2" backend/
    ```
  - **Files to update**: Any with hardcoded VAT
  - **Verification**: No hardcoded VAT patterns found
  - **Time**: 2 hours
  - **Dependencies**: T058

### Phase 6.2: Regression Testing

- [ ] **T062** Create VAT removal regression tests
  - **Stage**: VERIFICATION
  - **Description**: Verify no hardcoded VAT logic remains
  - **Test File**: `backend/django_Admin3/vat/tests/test_vat_removal.py`
  - **Test Cases**:
    - Test no imports of deleted modules
    - Test all VAT comes from Rules Engine
    - Test no hardcoded rates in codebase
  - **Commands**:
    ```bash
    python manage.py test vat.tests.test_vat_removal
    ```
  - **Verification**: All tests pass
  - **Time**: 1.5 hours
  - **Dependencies**: T059-T061

- [ ] **T063** Run full backend test suite (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Ensure no broken functionality after cleanup
  - **Commands**:
    ```bash
    python manage.py test --coverage
    ```
  - **Verification**: All tests passing, coverage > 80%
  - **Time**: 1 hour
  - **Dependencies**: T062

---

## Phase 7: Django Admin Interface (2 days)

### Phase 7.1: VAT Management Interfaces (already done in T013-T015)

- [ ] **T064** Verify admin interfaces functional (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Description**: Manual testing of Django admin VAT management
  - **Tests**:
    - Update VAT rate for Ireland (23% → 24%)
    - Verify immediate effect (no code deployment)
    - Add new country-region mapping
    - Test effective date filtering
  - **Time**: 1 hour
  - **Dependencies**: T063

### Phase 7.2: Rule Testing Interface

- [ ] **T065** Create admin action for testing VAT rules
  - **Stage**: GREEN
  - **Description**: Add "Test VAT Rules" action to ActedRule admin
  - **File**: `backend/django_Admin3/rules_engine/admin.py`
  - **Features**:
    - Input sample cart context
    - Execute rule
    - Display results
    - Show which rules triggered
  - **Verification**: Test rule via admin interface
  - **Time**: 2 hours
  - **Dependencies**: T064

### Phase 7.3: Audit Trail Viewer

- [ ] **T066** Create VATAudit admin interface
  - **Stage**: GREEN
  - **Description**: Create admin interface for viewing VAT audit trail
  - **File**: `backend/django_Admin3/vat/admin.py`
  - **Code**:
    ```python
    @admin.register(VATAudit)
    class VATAuditAdmin(admin.ModelAdmin):
        list_display = ['execution_id', 'cart', 'order', 'rule_id', 'created_at']
        list_filter = ['rule_id', 'created_at']
        search_fields = ['execution_id', 'cart__id', 'order__id']
        readonly_fields = ['input_context', 'output_data']

        def get_queryset(self, request):
            return super().get_queryset(request).select_related('cart', 'order')
    ```
  - **Verification**: Access `/admin/vat/vataudit/` and test filters
  - **Time**: 1.5 hours
  - **Dependencies**: T064

- [ ] **T067** Add export functionality for VAT audit data
  - **Stage**: GREEN
  - **Description**: Allow finance team to export VAT data for accounting
  - **File**: `backend/django_Admin3/vat/admin.py`
  - **Features**: CSV/Excel export of VATAudit records
  - **Verification**: Export audit data and open in Excel
  - **Time**: 1.5 hours
  - **Dependencies**: T066

### Phase 7.4: Documentation

- [ ] **T068** [P] Create admin user documentation
  - **Stage**: DOCUMENTATION
  - **Description**: Document how staff manage VAT via admin
  - **File**: `docs/admin-vat-management.md`
  - **Content**:
    - How to update VAT rates
    - How to modify region mappings
    - How to test VAT rules
    - How to view audit trail
    - How to export VAT reports
  - **Time**: 2 hours
  - **Dependencies**: T067

---

## Phase 8: Frontend VAT Display Updates (2-3 days)

**Note:** Detailed tasks already exist in `tasks/phase-8-frontend-vat-display-tasks.md`

### Summary Tasks

- [ ] **T069** [P] Create tests for CartSummaryPanel VAT label (RED)
  - **Stage**: RED
  - **Test File**: `frontend/react-Admin3/src/components/Ordering/CheckoutSteps/__tests__/CartSummaryPanel.test.js`
  - **Time**: 1 hour
  - **Dependencies**: T068

- [ ] **T070** Update CartSummaryPanel VAT label (GREEN)
  - **Stage**: GREEN
  - **File**: `frontend/react-Admin3/src/components/Ordering/CheckoutSteps/CartSummaryPanel.js`
  - **Time**: 0.5 hours
  - **Dependencies**: T069

- [ ] **T071** [P] Create tests for CartReviewStep VAT label (RED)
  - **Stage**: RED
  - **Test File**: `frontend/react-Admin3/src/components/Ordering/CheckoutSteps/__tests__/CartReviewStep.test.js`
  - **Time**: 1 hour
  - **Dependencies**: T068

- [ ] **T072** Update CartReviewStep VAT label (GREEN)
  - **Stage**: GREEN
  - **File**: `frontend/react-Admin3/src/components/Ordering/CheckoutSteps/CartReviewStep.js`
  - **Time**: 0.5 hours
  - **Dependencies**: T071

- [ ] **T073** [P] Create tests for TutorialProductCard pricing (RED)
  - **Stage**: RED
  - **Test File**: `frontend/react-Admin3/src/components/Product/ProductCard/Tutorial/__tests__/TutorialProductCard.test.js`
  - **Time**: 1.5 hours
  - **Dependencies**: T068

- [ ] **T074** Update TutorialProductCard pricing (GREEN)
  - **Stage**: GREEN
  - **File**: `frontend/react-Admin3/src/components/Product/ProductCard/Tutorial/TutorialProductCard.js`
  - **Time**: 2 hours
  - **Dependencies**: T073

- [ ] **T075** [P] Create VAT utility functions (REFACTOR)
  - **Stage**: REFACTOR
  - **File**: `frontend/react-Admin3/src/utils/vatUtils.js`
  - **Time**: 1 hour
  - **Dependencies**: T070, T072, T074

- [ ] **T076** Refactor components to use VAT utils (REFACTOR)
  - **Stage**: REFACTOR
  - **Files**: CartSummaryPanel.js, CartReviewStep.js, TutorialProductCard.js
  - **Time**: 1 hour
  - **Dependencies**: T075

- [ ] **T077** [P] Browser verification with Browser MCP (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Tool**: Browser MCP (mcp__browsermcp__)
  - **Tests**: Visual rendering of VAT labels and prices
  - **Time**: 3 hours
  - **Dependencies**: T076

- [ ] **T078** Run frontend test suite (VERIFICATION)
  - **Stage**: VERIFICATION
  - **Commands**:
    ```bash
    cd frontend/react-Admin3
    npm test -- --coverage --watchAll=false
    ```
  - **Verification**: All tests passing, coverage > 80%
  - **Time**: 1 hour
  - **Dependencies**: T077

---

## Phase 9: Testing & Documentation (2-3 days)

### Phase 9.1: Comprehensive Testing

- [ ] **T079** Run complete backend test suite
  - **Stage**: VERIFICATION
  - **Commands**:
    ```bash
    cd backend/django_Admin3
    python manage.py test utils vat rules_engine cart --coverage
    ```
  - **Verification**: All tests passing, coverage > 80%
  - **Time**: 1 hour
  - **Dependencies**: T078

- [ ] **T080** Run complete frontend test suite
  - **Stage**: VERIFICATION
  - **Commands**:
    ```bash
    cd frontend/react-Admin3
    npm test -- --coverage --watchAll=false
    ```
  - **Verification**: All tests passing, coverage > 80%
  - **Time**: 1 hour
  - **Dependencies**: T078

### Phase 9.2: Performance Testing

- [ ] **T081** [P] Create performance tests for VAT calculation
  - **Stage**: VERIFICATION
  - **Test File**: `backend/django_Admin3/vat/tests/test_performance.py`
  - **Test Cases**:
    - Test 1-item cart < 50ms
    - Test 10-item cart < 50ms
    - Test 50-item cart < 50ms
    - Profile and identify bottlenecks
  - **Verification**: All performance targets met
  - **Time**: 2 hours
  - **Dependencies**: T079

- [ ] **T082** Optimize if performance targets not met (REFACTOR)
  - **Stage**: REFACTOR
  - **Description**: Optimize VAT calculation if needed
  - **Options**: Caching, query optimization, rule pre-compilation
  - **Verification**: Performance tests pass
  - **Time**: 2-4 hours (conditional)
  - **Dependencies**: T081

### Phase 9.3: Specification Compliance

- [ ] **T083** Verify all 45 functional requirements met
  - **Stage**: VERIFICATION
  - **Description**: Check each FR from spec against implementation
  - **File**: Checklist in `docs/spec-compliance-checklist.md`
  - **Verification**: All 45 FRs checked off
  - **Time**: 2 hours
  - **Dependencies**: T079, T080

- [ ] **T084** Verify all acceptance scenarios passing
  - **Stage**: VERIFICATION
  - **Description**: Test all 5 primary scenarios + 4 edge cases from spec
  - **Test File**: `backend/django_Admin3/vat/tests/test_acceptance_scenarios.py`
  - **Scenarios**:
    - UK customer purchases digital eBook → 0% VAT
    - EU customer purchases physical material → 0% VAT
    - SA customer purchases any product → 15% VAT
    - Admin updates VAT rate → immediate effect
    - Finance manager reviews audit trail
    - Edge cases: unknown country, mixed cart, rate changes, discounts
  - **Verification**: All scenarios passing
  - **Time**: 2 hours
  - **Dependencies**: T083

### Phase 9.4: Documentation

- [ ] **T085** [P] Create technical architecture documentation
  - **Stage**: DOCUMENTATION
  - **File**: `docs/technical/vat-architecture.md`
  - **Content**:
    - Architecture overview
    - Data models diagram
    - Rules Engine integration
    - VAT calculation flow
    - API documentation
  - **Time**: 2 hours
  - **Dependencies**: T084

- [ ] **T086** [P] Create troubleshooting guide
  - **Stage**: DOCUMENTATION
  - **File**: `docs/technical/vat-troubleshooting.md`
  - **Content**:
    - Common issues and solutions
    - Debugging VAT calculations
    - Audit trail analysis
    - Performance troubleshooting
  - **Time**: 1.5 hours
  - **Dependencies**: T084

- [ ] **T087** [P] Update API documentation
  - **Stage**: DOCUMENTATION
  - **File**: `docs/api/vat-endpoints.md`
  - **Content**:
    - `/api/rules/engine/execute/` with calculate_vat
    - Request/response schemas
    - Error codes
    - Examples
  - **Time**: 1.5 hours
  - **Dependencies**: T084

### Phase 9.5: Final Verification

- [ ] **T088** Run complete test suite (all modules)
  - **Stage**: VERIFICATION
  - **Commands**:
    ```bash
    # Backend
    cd backend/django_Admin3
    python manage.py test --coverage

    # Frontend
    cd frontend/react-Admin3
    npm test -- --coverage --watchAll=false
    ```
  - **Verification**:
    - ✅ All tests passing (100%)
    - ✅ Backend coverage > 80%
    - ✅ Frontend coverage > 80%
    - ✅ No console errors or warnings
  - **Time**: 1 hour
  - **Dependencies**: T079-T087

- [ ] **T089** Create deployment checklist
  - **Stage**: DOCUMENTATION
  - **File**: `docs/deployment/vat-deployment-checklist.md`
  - **Content**:
    - Pre-deployment steps
    - Migration steps
    - Verification steps
    - Rollback procedure
    - Monitoring setup
  - **Time**: 1 hour
  - **Dependencies**: T088

---

## Dependencies Graph

```
Setup:
  T001 (utils app) → [T002, T005, T008]

Phase 1 (Database):
  T002 (region tests) → T003 (region model) → T004 (migration)
  T005 (country tests) → T006 (country model) → T007 (migration)
  T008 (mapping tests) → T009 (mapping model) → T010 (migration)
  [T004, T007, T010] → T011 (data migration) → T012 (migration tests)
  [T004, T007, T010] → [T013, T014, T015] (admin)
  T012, T013, T014, T015 → T016 (verification)

Phase 2 (Functions):
  T016 → [T017, T018, T019, T024] (tests - parallel)
  T017 → T020, T018 → T021, T019 → T022, T024 → T025
  [T020, T021, T022] → T023 (registry)
  T023, T025 → T026 (verification)

Phase 3 (Master Rule):
  T026 → T027 (entry point) → T028 (tests) → T029 (master rule)
  T029 → T030 (API tests) → T031 (API integration) → T032 (verification)

Phase 4 (Regional Rules):
  T032 → [T033, T038, T040, T042, T044] (tests - parallel)
  T033 → T034 → [T035, T036, T037]
  T038 → T039, T040 → T041, T042 → T043, T044 → T045
  [T035, T036, T037, T039, T041, T043, T045] → T046 (integration)

Phase 5 (Entry Points):
  T046 → T047 (orchestrator tests) → T048 (orchestrator)
  T048 → [T049, T051, T053, T056] (tests - parallel)
  T049 → T050, T051 → T052, T053 → T054, T056 → T057
  T048 → T055 (serializer)
  [T050, T052, T054, T055, T057] → T058 (verification)

Phase 6 (Cleanup):
  T058 → [T059, T060, T061] → T062 → T063

Phase 7 (Admin):
  T063 → T064 → T065 → T066 → T067 → T068

Phase 8 (Frontend):
  T068 → [T069, T071, T073] (tests - parallel)
  T069 → T070, T071 → T072, T073 → T074
  [T070, T072, T074] → T075 → T076 → T077 → T078

Phase 9 (Testing & Docs):
  T078 → T079, T080 → T081 → T082 (conditional)
  [T079, T080] → T083 → T084
  T084 → [T085, T086, T087] (parallel docs) → T088 → T089
```

---

## Parallel Execution Examples

### Phase 1.2 Tests (All Parallel):
```bash
# T002, T005, T008 can run in parallel (different test files)
python manage.py test utils.tests.test_models::UtilsRegionTestCase &
python manage.py test utils.tests.test_models::UtilsCountrysTestCase &
python manage.py test utils.tests.test_models::UtilsCountryRegionTestCase &
wait
```

### Phase 2.1 Tests (All Parallel):
```bash
# T017, T018, T019, T024 can run in parallel (different test methods)
python manage.py test rules_engine.tests.test_custom_functions::test_lookup_region &
python manage.py test rules_engine.tests.test_custom_functions::test_lookup_vat_rate &
python manage.py test rules_engine.tests.test_custom_functions::test_calculate_vat_amount &
python manage.py test rules_engine.tests.test_jsonlogic_helpers &
wait
```

### Phase 4 Regional Tests (All Parallel):
```bash
# T033, T038, T040, T042, T044 can run in parallel (different regions)
python manage.py test vat.tests.test_uk_rules &
python manage.py test vat.tests.test_eu_rules &
python manage.py test vat.tests.test_sa_rules &
python manage.py test vat.tests.test_ie_rules &
python manage.py test vat.tests.test_row_rules &
wait
```

### Phase 9 Documentation (All Parallel):
```bash
# T085, T086, T087 can be written simultaneously (different files)
# Developer 1: T085 (architecture)
# Developer 2: T086 (troubleshooting)
# Developer 3: T087 (API docs)
```

---

## Validation Checklist

- [x] All tests come before implementation (RED → GREEN)
- [x] Parallel tasks [P] modify different files
- [x] Each task specifies exact file path
- [x] TDD workflow maintained throughout (RED-GREEN-REFACTOR)
- [x] All 45 functional requirements covered
- [x] All database models have tests
- [x] All Rules Engine functions have tests
- [x] All regional rules have tests
- [x] No hardcoded VAT logic in tasks
- [x] Browser MCP verification included (T077)
- [x] Performance testing included (T081-T082)
- [x] Specification compliance verification (T083-T084)

---

## Estimated Time Summary

| Phase | Tasks | Duration |
|-------|-------|----------|
| Phase 1: Database Foundation | T001-T016 | 3-4 days (15 tasks, ~14 hours) |
| Phase 2: Rules Engine Functions | T017-T026 | 2 days (10 tasks, ~13 hours) |
| Phase 3: Master VAT Rule | T027-T032 | 2-3 days (6 tasks, ~9.5 hours) |
| Phase 4: Regional VAT Rules | T033-T046 | 3-4 days (14 tasks, ~20 hours) |
| Phase 5: Entry Point Integration | T047-T058 | 2-3 days (12 tasks, ~20.5 hours) |
| Phase 6: Legacy Code Removal | T059-T063 | 1-2 days (5 tasks, ~5.5 hours) |
| Phase 7: Django Admin Interface | T064-T068 | 2 days (5 tasks, ~8 hours) |
| Phase 8: Frontend VAT Display | T069-T078 | 2-3 days (10 tasks, ~13 hours) |
| Phase 9: Testing & Documentation | T079-T089 | 2-3 days (11 tasks, ~18 hours) |

**Total Tasks**: 89
**Total Duration**: 19-27 days (4-5 weeks)
**Total Estimated Hours**: ~121.5 hours

---

## Getting Started

1. **Create feature branch**:
   ```bash
   git checkout -b 003-vat-calculation-rules-engine
   ```

2. **Use TodoWrite to track progress**:
   ```
   TodoWrite: Track all 89 tasks with TDD stages (RED/GREEN/REFACTOR)
   ```

3. **Begin Phase 1**:
   ```bash
   cd backend/django_Admin3
   .\.venv\Scripts\activate
   # Start with T001: Create utils app
   ```

4. **Follow TDD strictly**:
   - ❌ Do NOT write implementation before tests
   - ✅ Write test first (RED)
   - ✅ Implement minimal solution (GREEN)
   - ✅ Refactor while keeping tests green (REFACTOR)

---

## Success Criteria

- ✅ All 89 tasks completed
- ✅ All tests passing (100%)
- ✅ Backend coverage > 80%
- ✅ Frontend coverage > 80%
- ✅ All 45 functional requirements met
- ✅ Performance < 50ms per cart
- ✅ Zero hardcoded VAT logic
- ✅ 100% VAT logic in Rules Engine
- ✅ Data separation verified (utils_countrys vs country_country)
- ✅ Admin can update VAT rates without code deployment
- ✅ Complete audit trail for all calculations

---

*Generated by /tasks command for Epic 3 - Dynamic VAT Calculation System*
*Based on: plans/spec-2025-10-06-121922-plan.md*
*TDD Methodology: RED → GREEN → REFACTOR*