# Tasks: Migrate SearchBox to Redux State Management

**Input**: Design documents from `plans/spec-2025-10-20-000000/`
**Prerequisites**: plan.md ✓, research.md ✓, data-model.md ✓, contracts/ ✓

## Execution Flow (main)
```
1. Load plan.md from feature directory ✓
   → Tech stack: React 18, Redux Toolkit, Material-UI, Jest
   → Structure: Web application (frontend/backend)
2. Load optional design documents ✓
   → data-model.md: No new entities (use existing Redux state)
   → contracts/: SearchBox.contract.md, SearchModal.contract.md
   → research.md: Variations → product_types mapping
3. Generate tasks by category ✓
   → Setup: None needed (infrastructure exists)
   → Tests: 11 SearchBox tests, 9 SearchModal tests, 5 performance tests
   → Core: SearchBox, SearchModal, SearchResults modifications
   → Integration: URL sync verification
   → Polish: Refactoring, manual testing
4. Apply task rules ✓
   → Different components = mark [P] for parallel
   → Same file = sequential
   → Tests before implementation (TDD)
5. Number tasks sequentially (T001, T002...) ✓
6. Generate dependency graph ✓
7. Validate task completeness ✓
   → All contracts have tests ✓
   → All components have implementation tasks ✓
   → All tests before implementation ✓
8. Return: SUCCESS (28 tasks ready for execution)
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in descriptions

## Path Conventions
- **Web app**: `frontend/react-Admin3/src/`, `frontend/react-Admin3/src/__tests__/`
- **Backend**: No backend changes required

---

## Phase 3.1: Setup (SKIPPED - Infrastructure Already Exists)

No setup tasks required. All infrastructure is already in place:
- ✅ Redux Toolkit configured
- ✅ Redux store setup complete
- ✅ filtersSlice.js exists with comprehensive actions
- ✅ URL sync middleware operational
- ✅ Jest and React Testing Library configured

---

## Phase 3.2: Tests First (TDD RED) ⚠️ MUST COMPLETE BEFORE 3.3

**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**

### SearchBox Contract Tests (RED)

- [ ] **T001** [P] Write contract test: SearchBox displays filters from Redux state
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test that SearchBox reads `filters.subjects`, `filters.product_types`, and `filters.searchQuery` from Redux using `useSelector`. Pre-populate Redux store with test data and verify component displays it.
  **Acceptance**: Test fails with "SearchBox uses local state, not Redux"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T002** [P] Write contract test: SearchBox dispatches toggleSubjectFilter on checkbox click
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test that clicking a subject checkbox dispatches `toggleSubjectFilter` action with correct payload. Mock Redux store and verify action dispatch.
  **Acceptance**: Test fails with "SearchBox does not dispatch Redux actions"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T003** [P] Write contract test: SearchBox dispatches setSearchQuery on input change
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test that typing in search input dispatches `setSearchQuery` action (debounced). Account for 300ms debounce delay.
  **Acceptance**: Test fails with "SearchBox updates local state, not Redux"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T004** [P] Write contract test: Filter selections persist across unmount/remount
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test that Redux state persists when SearchBox unmounts and remounts. Verify filters still selected after remount.
  **Acceptance**: Test passes (Redux persists by design) - validates SearchBox doesn't clear state
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T005** [P] Write contract test: Handles rapid filter changes without race conditions
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test rapid checkbox clicks (5+ clicks in quick succession). Verify final Redux state matches expected state with no inconsistencies.
  **Acceptance**: Test fails initially, passes after implementation
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T006** [P] Write contract test: Removes filter from Redux on chip delete
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test clicking "X" on filter chip dispatches `removeSubjectFilter` action. Verify Redux state updated.
  **Acceptance**: Test fails with "Chip delete updates local state, not Redux"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T007** [P] Write contract test: Clears all filters via Redux action
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchBox.test.js`
  **TDD Stage**: RED
  **Description**: Test "Clear All" button dispatches `clearAllFilters` action. Verify all filter arrays emptied in Redux.
  **Acceptance**: Test fails with "Clear All uses local state, not Redux"
  **Time**: 0.5 hours
  **Dependencies**: None

### SearchModal Contract Tests (RED)

- [ ] **T008** [P] Write contract test: SearchModal does not maintain local filter state
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchModal.test.js`
  **TDD Stage**: RED
  **Description**: Test that SearchModal reads filters from Redux, not local `useState`. Verify no duplicate filter state in component.
  **Acceptance**: Test fails with "SearchModal maintains duplicate local state"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T009** [P] Write contract test: SearchModal reads filters from Redux on mount
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchModal.test.js`
  **TDD Stage**: RED
  **Description**: Test that opening modal with pre-existing Redux filters displays those filters. Verify Redux is source of truth.
  **Acceptance**: Test fails with "SearchModal passes local state to SearchBox"
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T010** [P] Write contract test: Does not clear Redux filters on modal close
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchModal.test.js`
  **TDD Stage**: RED
  **Description**: Test closing modal doesn't clear Redux filter state. Verify Redux state unchanged after modal close.
  **Acceptance**: Test fails if filters cleared on close
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T011** [P] Write contract test: Displays persisted filters when modal reopened
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchModal.test.js`
  **TDD Stage**: RED
  **Description**: Test close → reopen flow. Verify filters persist across modal lifecycle.
  **Acceptance**: Test fails if filters cleared
  **Time**: 0.5 hours
  **Dependencies**: None

- [ ] **T012** [P] Write contract test: Simplified navigation (no redundant dispatches)
  **File**: `frontend/react-Admin3/src/components/__tests__/SearchModal.test.js`
  **TDD Stage**: RED
  **Description**: Test "Show Matching Products" navigation. Verify filters already in Redux, no redundant dispatching needed.
  **Acceptance**: Test verifies navigation without extra dispatches
  **Time**: 0.5 hours
  **Dependencies**: None

### Performance Contract Tests (RED)

- [ ] **T013** [P] Write performance test: Filter state update completes in < 50ms
  **File**: `frontend/react-Admin3/src/components/__tests__/searchBoxPerformance.test.js`
  **TDD Stage**: RED
  **Description**: Benchmark filter checkbox click → Redux state update. Measure with `performance.now()`. Assert < 50ms (95th percentile).
  **Acceptance**: Test fails if performance degrades
  **Time**: 1 hour
  **Dependencies**: None

- [ ] **T014** [P] Write performance test: SearchBox render time increase < 5ms
  **File**: `frontend/react-Admin3/src/components/__tests__/searchBoxPerformance.test.js`
  **TDD Stage**: RED
  **Description**: Compare baseline (local state) vs Redux implementation render times. Assert increase < 5ms.
  **Acceptance**: Test fails if render time degrades significantly
  **Time**: 1 hour
  **Dependencies**: None

- [ ] **T015** [P] Write performance test: Handles 10+ filter changes per second
  **File**: `frontend/react-Admin3/src/components/__tests__/searchBoxPerformance.test.js`
  **TDD Stage**: RED
  **Description**: Rapid-fire 10+ checkbox clicks per second. Verify no dropped updates, no UI lag.
  **Acceptance**: Test fails if state inconsistencies occur
  **Time**: 1 hour
  **Dependencies**: None

---

## Phase 3.3: Core Implementation (GREEN) - ONLY after tests are failing

### SearchBox Component Implementation (GREEN)

- [ ] **T016** Remove local state from SearchBox.js
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Delete `useState` for `selectedFilters` and `searchQuery` (lines 13-14). Keep only UI state (`loading`, `error`, `searchResults`).
  **Acceptance**: T001-T003 tests start passing
  **Time**: 0.5 hours
  **Dependencies**: T001, T002, T003 (tests written)

- [ ] **T017** Add Redux imports to SearchBox.js
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Import `useSelector`, `useDispatch` from 'react-redux'. Import actions: `setSearchQuery`, `toggleSubjectFilter`, `toggleProductTypeFilter`, `toggleProductFilter`. Import selectors: `selectFilters`, `selectSearchQuery`.
  **Acceptance**: No import errors
  **Time**: 0.25 hours
  **Dependencies**: T016

- [ ] **T018** Replace useState with useSelector in SearchBox.js
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Replace `useState(selectedFilters)` with `const filters = useSelector(selectFilters)`. Replace `useState(searchQuery)` with `const searchQuery = useSelector(selectSearchQuery)`.
  **Acceptance**: T001 test passes (displays Redux state)
  **Time**: 0.5 hours
  **Dependencies**: T017

- [ ] **T019** Update handleFilterSelect to dispatch Redux actions
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Replace `setSelectedFilters` calls with Redux dispatches. Map filter types: `subjects` → `toggleSubjectFilter`, `product_groups`/`variations` → `toggleProductTypeFilter`, `products` → `toggleProductFilter`.
  **Acceptance**: T002, T005, T006 tests pass (filter actions dispatched)
  **Time**: 1 hour
  **Dependencies**: T018

- [ ] **T020** Update search query input to dispatch setSearchQuery
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Replace `setSearchQuery(e.target.value)` with `dispatch(setSearchQuery(e.target.value))` in `handleSearchChange`.
  **Acceptance**: T003 test passes (Redux searchQuery updated)
  **Time**: 0.25 hours
  **Dependencies**: T018

- [ ] **T021** Update clearAllFilters to dispatch Redux action
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Replace local state clearing with `dispatch(clearAllFilters())`.
  **Acceptance**: T007 test passes (all filters cleared in Redux)
  **Time**: 0.25 hours
  **Dependencies**: T019

- [ ] **T022** Update removeFilter to dispatch Redux actions
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: GREEN
  **Description**: Replace local filter removal with appropriate Redux remove actions (`removeSubjectFilter`, `removeProductTypeFilter`, `removeProductFilter`).
  **Acceptance**: T006 test passes (chip delete works)
  **Time**: 0.5 hours
  **Dependencies**: T019

### SearchModal Component Implementation (GREEN)

- [ ] **T023** Remove local filter state from SearchModal.js
  **File**: `frontend/react-Admin3/src/components/Navigation/SearchModal.js`
  **TDD Stage**: GREEN
  **Description**: Delete `useState` for `selectedFilters` and `searchQuery` (lines 31-37). Keep only UI state (`searchResults`, `searchLoading`, `searchError`).
  **Acceptance**: T008, T009 tests pass (no duplicate state)
  **Time**: 0.5 hours
  **Dependencies**: T008, T009 (tests written)

- [ ] **T024** Add Redux selectors to SearchModal.js
  **File**: `frontend/react-Admin3/src/components/Navigation/SearchModal.js`
  **TDD Stage**: GREEN
  **Description**: Import and use `useSelector(selectFilters)` and `useSelector(selectSearchQuery)` to read Redux state instead of local state.
  **Acceptance**: T009 test passes (reads from Redux on mount)
  **Time**: 0.5 hours
  **Dependencies**: T023

- [ ] **T025** Remove filter management logic from SearchModal.js
  **File**: `frontend/react-Admin3/src/components/Navigation/SearchModal.js`
  **TDD Stage**: GREEN
  **Description**: Delete `handleFilterSelect`, `handleFilterRemove`, `isFilterSelected` functions (lines 96-126). SearchBox manages these via Redux now.
  **Acceptance**: T012 test passes (simplified component)
  **Time**: 0.5 hours
  **Dependencies**: T024

- [ ] **T026** Simplify handleShowMatchingProducts in SearchModal.js
  **File**: `frontend/react-Admin3/src/components/Navigation/SearchModal.js`
  **TDD Stage**: GREEN
  **Description**: Remove filter dispatching logic (lines 136-151). Filters already in Redux. Just call `handleCloseSearchModal()` and `navigate('/products')`. URL sync middleware handles URL updates.
  **Acceptance**: T010, T011, T012 tests pass (no redundant dispatches, filters persist)
  **Time**: 0.5 hours
  **Dependencies**: T025

### SearchResults Component Implementation (GREEN)

- [ ] **T027** Update SearchResults.js to use Redux selectors
  **File**: `frontend/react-Admin3/src/components/SearchResults.js`
  **TDD Stage**: GREEN
  **Description**: Import `useSelector`, `selectFilters`, `selectSearchQuery`. Replace props (`searchQuery`, `selectedFilters`) with Redux selectors. Remove these props from component signature.
  **Acceptance**: Component reads from Redux, no prop drilling
  **Time**: 0.5 hours
  **Dependencies**: None (independent change)

---

## Phase 3.4: Integration Verification

- [ ] **T028** Verify URL sync middleware works with SearchBox dispatches
  **File**: Manual testing + integration test
  **TDD Stage**: Integration
  **Description**: Test that SearchBox filter changes trigger URL updates via middleware. Open search modal, select filters, verify URL parameters updated: `?subject_code=CB1&group=8`. Test bidirectional sync (URL → Redux and Redux → URL).
  **Acceptance**: URL parameters match Redux state, filters restored from URL on page load
  **Time**: 1 hour
  **Dependencies**: T016-T027 (all implementations complete)

---

## Phase 3.5: Polish & Validation

- [ ] **T029** Run all contract tests and verify they pass
  **Command**: `npm test -- SearchBox.test.js SearchModal.test.js searchBoxPerformance.test.js`
  **TDD Stage**: Validation
  **Description**: Execute all 15 contract tests. Verify 100% pass rate. Fix any regressions.
  **Acceptance**: All tests GREEN
  **Time**: 0.5 hours
  **Dependencies**: T016-T027

- [ ] **T030** Execute quickstart.md manual testing checklist
  **File**: `plans/spec-2025-10-20-000000/quickstart.md`
  **TDD Stage**: Validation
  **Description**: Execute all 13 steps in quickstart guide. Verify filter persistence, Redux DevTools visibility, navigation flow, performance targets.
  **Acceptance**: All quickstart steps ✅ PASS
  **Time**: 1 hour
  **Dependencies**: T028

- [ ] **T031** Performance validation: Benchmark < 50ms response time
  **Tool**: React DevTools Profiler + Redux DevTools
  **TDD Stage**: Validation
  **Description**: Profile SearchBox in development mode. Measure filter checkbox click → UI update time. Verify 95th percentile < 50ms. Document results.
  **Acceptance**: Performance targets met (< 50ms, < 5ms increase)
  **Time**: 1 hour
  **Dependencies**: T029

- [ ] **T032** REFACTOR: Remove unnecessary prop drilling
  **Files**: `SearchModal.js`, `SearchResults.js`
  **TDD Stage**: REFACTOR
  **Description**: Remove `selectedFilters` and `searchQuery` props from SearchBox/SearchResults component signatures. Components now read directly from Redux.
  **Acceptance**: Tests still pass, props removed
  **Time**: 0.5 hours
  **Dependencies**: T027

- [ ] **T033** REFACTOR: Add React.memo if performance degradation detected
  **File**: `frontend/react-Admin3/src/components/SearchBox.js`
  **TDD Stage**: REFACTOR
  **Description**: If profiling (T031) shows unnecessary re-renders, wrap SearchBox in `React.memo`. Add custom comparison function if needed.
  **Acceptance**: No unnecessary re-renders, tests still pass
  **Time**: 0.5 hours
  **Dependencies**: T031

- [ ] **T034** Code review and documentation update
  **Files**: Code review, inline comments
  **TDD Stage**: Polish
  **Description**: Peer code review. Update inline comments to reflect Redux integration. Remove outdated comments about local state.
  **Acceptance**: Code review approved, comments accurate
  **Time**: 1 hour
  **Dependencies**: T033

---

## Dependencies

### Critical Path
```
T001-T015 (Tests RED) → Must fail before implementation
  ↓
T016-T022 (SearchBox GREEN) → Sequential within SearchBox
  ↓
T023-T026 (SearchModal GREEN) → Sequential within SearchModal
  ↓ (Parallel)
T027 (SearchResults GREEN)
  ↓
T028 (Integration verification)
  ↓
T029-T034 (Validation & Polish)
```

### Parallel Execution Opportunities
```
Phase 3.2 (Tests RED):
- T001-T015 can ALL run in parallel (different test cases, independent)

Phase 3.3 (Implementation GREEN):
- T016-T022 must be sequential (same file: SearchBox.js)
- T023-T026 must be sequential (same file: SearchModal.js)
- T027 can run in parallel with T023-T026 (different file: SearchResults.js)

Phase 3.5 (Polish):
- T032-T033 can run in parallel (different aspects of refactoring)
```

---

## Parallel Execution Example

### Parallel Test Writing (Phase 3.2)
```bash
# Launch T001-T015 together (all independent test cases):
Task: "Write contract test: SearchBox displays filters from Redux state"
Task: "Write contract test: SearchBox dispatches toggleSubjectFilter"
Task: "Write contract test: SearchBox dispatches setSearchQuery"
Task: "Write contract test: Filter selections persist across unmount"
Task: "Write contract test: Handles rapid filter changes"
# ... (all 15 tests can be written in parallel)
```

### Parallel Implementation (Phase 3.3)
```bash
# After SearchBox/SearchModal implementations complete:
Task: "Update SearchResults.js to use Redux selectors" (T027)
# Can run while T023-T026 are in progress (different files)
```

---

## Task Summary

**Total Tasks**: 34
**Estimated Total Time**: 18.5 hours (~2.5 days)

**Breakdown by Phase**:
- Phase 3.1 (Setup): 0 tasks (infrastructure exists)
- Phase 3.2 (Tests RED): 15 tasks, 9 hours
- Phase 3.3 (Implementation GREEN): 12 tasks, 5.75 hours
- Phase 3.4 (Integration): 1 task, 1 hour
- Phase 3.5 (Polish): 6 tasks, 4.5 hours

**Breakdown by TDD Stage**:
- RED (failing tests): 15 tasks
- GREEN (implementation): 12 tasks
- REFACTOR/Polish: 7 tasks

---

## Validation Checklist
*Automated checks completed during task generation*

- [x] All contracts have corresponding tests (SearchBox: 11 tests, SearchModal: 9 tests)
- [x] All entities have model tasks (N/A - no new models, using existing Redux state)
- [x] All tests come before implementation (T001-T015 before T016-T027)
- [x] Parallel tasks truly independent (different files, no shared state)
- [x] Each task specifies exact file path
- [x] No task modifies same file as another [P] task (SearchBox tasks sequential, SearchModal tasks sequential)

---

## Notes

- **TDD Enforcement**: tdd-guard.config.js enforces RED-GREEN-REFACTOR cycle
- **Commit Strategy**: Commit after each logical group (e.g., after T015, after T022, after T027)
- **Performance Monitoring**: Use React DevTools Profiler throughout (especially T031)
- **Redux DevTools**: Keep open during all manual testing for state visibility
- **Rollback Plan**: If tests fail after implementation, use git revert per plan.md

---

**Next Step**: Use `TodoWrite` tool to track these tasks during implementation. Execute tasks in order T001 → T034.

**Success Criteria**: All 34 tasks complete, all tests GREEN, quickstart passes, performance targets met.
