# Phase 8: Frontend VAT Display Updates - TDD Task Breakdown

**Created:** 2025-10-16
**Phase:** Phase 8 - Frontend VAT Display Updates
**Duration:** 2-3 days
**Branch:** `004-phase-4` (current)
**Status:** Ready to Execute

## Overview

**Goal:** Update React frontend to use dynamic VAT from API instead of hardcoded VAT logic.

**Context:**
- Phase 5 (Entry Point Integration) implemented VAT Orchestrator that populates `cart.vat_result` JSONB
- Phase 6 (Legacy Code Removal) removed all backend hardcoded VAT logic
- Frontend still has hardcoded "VAT (20%)" labels and hardcoded price displays
- Need to update frontend components to consume dynamic VAT data from API

**Key Files to Update:**
1. `frontend/react-Admin3/src/components/Cart/CartSummaryPanel.js` - Line 95 (hardcoded VAT label)
2. `frontend/react-Admin3/src/components/Checkout/CartReviewStep.js` - Line 114 (hardcoded VAT label)
3. `frontend/react-Admin3/src/components/Products/TutorialProductCard.js` - Hardcoded price displays
4. Create: `frontend/react-Admin3/src/utils/vatUtils.js` - Utility functions for VAT formatting

---

## Test Commands

### Frontend Tests
```bash
# Navigate to frontend directory
cd frontend/react-Admin3

# Run all tests (watch mode)
npm test

# Run tests with coverage
npm test -- --coverage --watchAll=false

# Run specific component tests
npm test -- --testPathPattern=CartSummaryPanel
npm test -- --testPathPattern=CartReviewStep
npm test -- --testPathPattern=TutorialProductCard
npm test -- --testPathPattern=vatUtils
```

### Browser Verification (Using Browser MCP)
```javascript
// Navigate to cart page
await browser.navigate('http://localhost:3000/cart')

// Take screenshot
await browser.screenshot()

// Verify VAT label rendering
await browser.snapshot()
```

---

## Phase 8 Tasks

### TASK-801: Audit Frontend for Hardcoded VAT Logic (TDD RED)

**Goal:** Identify all hardcoded VAT logic in React components

**TDD Stage:** RED - Create failing tests that verify dynamic VAT usage

**Steps:**

1. **Search for Hardcoded VAT Patterns:**
   ```bash
   cd frontend/react-Admin3/src

   # Search for hardcoded "VAT (20%)" labels
   grep -r "VAT (20%)" components/
   grep -r "VAT (0%)" components/
   grep -r "20%" components/ | grep -i vat

   # Search for hardcoded price calculations
   grep -r "* 1.2" components/
   grep -r "* 0.2" components/

   # Search for hardcoded "Price includes VAT"
   grep -r "Price includes VAT" components/
   ```

2. **Document Findings:**
   Create file: `frontend/react-Admin3/HARDCODED_VAT_AUDIT.md`
   ```markdown
   # Hardcoded VAT Audit - Phase 8

   ## Files with Hardcoded VAT Logic

   ### Cart Components
   - [ ] CartSummaryPanel.js:95 - "VAT (20%)"
   - [ ] CartReviewStep.js:114 - "VAT (20%)"

   ### Product Components
   - [ ] TutorialProductCard.js - Hardcoded prices
   - [ ] ProductCard.js - "Price includes VAT" text

   ### Other Components
   - [ ] (TBD - Search results)
   ```

3. **Create Regression Tests (RED Phase):**

   **File:** `frontend/react-Admin3/src/utils/__tests__/vatUtils.test.js`
   ```javascript
   describe('VAT Utility Functions', () => {
     describe('formatVatLabel', () => {
       test('formats effective VAT rate as percentage label', () => {
         expect(formatVatLabel(0.20)).toBe('VAT (20%)');
         expect(formatVatLabel(0.15)).toBe('VAT (15%)');
         expect(formatVatLabel(0.23)).toBe('VAT (23%)');
         expect(formatVatLabel(0.00)).toBe('VAT (0%)');
       });

       test('handles null/undefined rates', () => {
         expect(formatVatLabel(null)).toBe('VAT');
         expect(formatVatLabel(undefined)).toBe('VAT');
       });
     });

     describe('getVatStatusDisplay', () => {
       test('returns correct status messages', () => {
         expect(getVatStatusDisplay('included')).toBe('Price includes VAT');
         expect(getVatStatusDisplay('exempt')).toBe('VAT exempt');
         expect(getVatStatusDisplay('reverse_charge')).toBe('VAT reverse charge applies');
         expect(getVatStatusDisplay('zero_rated')).toBe('Zero-rated for VAT');
       });

       test('handles unknown status', () => {
         expect(getVatStatusDisplay('unknown')).toBe('');
       });
     });
   });
   ```

   **File:** `frontend/react-Admin3/src/components/Cart/__tests__/CartSummaryPanel.test.js`
   ```javascript
   import { render, screen } from '@testing-library/react';
   import CartSummaryPanel from '../CartSummaryPanel';

   describe('CartSummaryPanel - Phase 8 VAT Display', () => {
     test('displays dynamic VAT rate from vatCalculations', () => {
       const mockCart = {
         subtotal: 100.00,
         total: 120.00,
         vatCalculations: {
           totals: {
             net: 100.00,
             vat: 20.00,
             gross: 120.00,
             effective_vat_rate: 0.20
           },
           region: 'UK'
         }
       };

       render(<CartSummaryPanel cart={mockCart} />);

       // Should display "VAT (20%)" dynamically, not hardcoded
       expect(screen.getByText('VAT (20%)')).toBeInTheDocument();
       expect(screen.getByText('£20.00')).toBeInTheDocument();
     });

     test('displays 0% VAT for exempt items', () => {
       const mockCart = {
         subtotal: 100.00,
         total: 100.00,
         vatCalculations: {
           totals: {
             net: 100.00,
             vat: 0.00,
             gross: 100.00,
             effective_vat_rate: 0.00
           },
           region: 'EU'
         }
       };

       render(<CartSummaryPanel cart={mockCart} />);

       expect(screen.getByText('VAT (0%)')).toBeInTheDocument();
       expect(screen.getByText('£0.00')).toBeInTheDocument();
     });

     test('handles missing vatCalculations gracefully', () => {
       const mockCart = {
         subtotal: 100.00,
         total: 100.00
       };

       render(<CartSummaryPanel cart={mockCart} />);

       // Should display generic "VAT" label if vatCalculations missing
       expect(screen.getByText('VAT')).toBeInTheDocument();
     });
   });
   ```

4. **Run Tests (Verify RED):**
   ```bash
   npm test -- --testPathPattern=vatUtils --watchAll=false
   npm test -- --testPathPattern=CartSummaryPanel --watchAll=false
   ```

   **Expected Result:** Tests FAIL (vatUtils.js doesn't exist yet)

**Acceptance Criteria (RED Phase):**
- ✅ All hardcoded VAT patterns documented
- ✅ Regression tests created for vatUtils functions
- ✅ Regression tests created for CartSummaryPanel
- ✅ Regression tests created for CartReviewStep
- ✅ Regression tests created for TutorialProductCard
- ✅ Tests FAIL (confirming need for implementation)

---

### TASK-802: Create VAT Utility Functions (TDD GREEN)

**Goal:** Implement vatUtils.js with VAT formatting functions

**TDD Stage:** GREEN - Implement functions to make tests pass

**Steps:**

1. **Create vatUtils.js (GREEN Phase):**

   **File:** `frontend/react-Admin3/src/utils/vatUtils.js`
   ```javascript
   /**
    * VAT Utility Functions - Phase 8
    *
    * Frontend utilities for formatting and displaying dynamic VAT data.
    */

   /**
    * Format effective VAT rate as percentage label.
    *
    * @param {number|null} effectiveVatRate - VAT rate as decimal (e.g., 0.20 for 20%)
    * @returns {string} Formatted label (e.g., "VAT (20%)")
    *
    * @example
    * formatVatLabel(0.20)  // "VAT (20%)"
    * formatVatLabel(0.00)  // "VAT (0%)"
    * formatVatLabel(null)  // "VAT"
    */
   export const formatVatLabel = (effectiveVatRate) => {
     if (effectiveVatRate === null || effectiveVatRate === undefined) {
       return 'VAT';
     }

     const percentage = (effectiveVatRate * 100).toFixed(0);
     return `VAT (${percentage}%)`;
   };

   /**
    * Get VAT status display message.
    *
    * @param {string} vatStatus - Status code from API
    * @returns {string} Display message
    *
    * @example
    * getVatStatusDisplay('included')       // "Price includes VAT"
    * getVatStatusDisplay('exempt')         // "VAT exempt"
    * getVatStatusDisplay('reverse_charge') // "VAT reverse charge applies"
    */
   export const getVatStatusDisplay = (vatStatus) => {
     const statusMessages = {
       included: 'Price includes VAT',
       exempt: 'VAT exempt',
       reverse_charge: 'VAT reverse charge applies',
       zero_rated: 'Zero-rated for VAT',
       not_applicable: ''
     };

     return statusMessages[vatStatus] || '';
   };

   /**
    * Format VAT amount as currency.
    *
    * @param {number} vatAmount - VAT amount
    * @param {string} currency - Currency code (default: 'GBP')
    * @returns {string} Formatted currency string
    *
    * @example
    * formatVatAmount(20.00)      // "£20.00"
    * formatVatAmount(0.00)       // "£0.00"
    * formatVatAmount(20.00, 'EUR') // "€20.00"
    */
   export const formatVatAmount = (vatAmount, currency = 'GBP') => {
     const formatter = new Intl.NumberFormat('en-GB', {
       style: 'currency',
       currency: currency,
       minimumFractionDigits: 2,
       maximumFractionDigits: 2
     });

     return formatter.format(vatAmount);
   };

   /**
    * Get VAT breakdown for display.
    *
    * @param {object} vatCalculations - VAT calculations from API
    * @returns {object} VAT breakdown with formatted values
    *
    * @example
    * getVatBreakdown(cart.vatCalculations)
    * // {
    * //   netAmount: "£100.00",
    * //   vatAmount: "£20.00",
    * //   grossAmount: "£120.00",
    * //   vatLabel: "VAT (20%)",
    * //   region: "UK"
    * // }
    */
   export const getVatBreakdown = (vatCalculations) => {
     if (!vatCalculations || !vatCalculations.totals) {
       return {
         netAmount: '£0.00',
         vatAmount: '£0.00',
         grossAmount: '£0.00',
         vatLabel: 'VAT',
         region: 'Unknown'
       };
     }

     const { totals, region } = vatCalculations;

     return {
       netAmount: formatVatAmount(totals.net),
       vatAmount: formatVatAmount(totals.vat),
       grossAmount: formatVatAmount(totals.gross),
       vatLabel: formatVatLabel(totals.effective_vat_rate),
       region: region || 'Unknown'
     };
   };
   ```

2. **Run Tests (Verify GREEN):**
   ```bash
   npm test -- --testPathPattern=vatUtils --watchAll=false
   ```

   **Expected Result:** All vatUtils tests PASS

**Acceptance Criteria (GREEN Phase):**
- ✅ formatVatLabel() implemented and tested
- ✅ getVatStatusDisplay() implemented and tested
- ✅ formatVatAmount() implemented and tested
- ✅ getVatBreakdown() implemented and tested
- ✅ All vatUtils tests passing (100% coverage)

---

### TASK-803: Update CartSummaryPanel Component (TDD GREEN)

**Goal:** Replace hardcoded "VAT (20%)" with dynamic VAT from API

**TDD Stage:** GREEN - Update component to make tests pass

**Steps:**

1. **Read Current Implementation:**
   ```bash
   # Read CartSummaryPanel.js to understand current structure
   ```

2. **Update CartSummaryPanel.js (GREEN Phase):**

   **File:** `frontend/react-Admin3/src/components/Cart/CartSummaryPanel.js`

   **BEFORE (Line 95):**
   ```javascript
   <Typography variant="body2">
     VAT (20%): £{cart.vatAmount.toFixed(2)}
   </Typography>
   ```

   **AFTER:**
   ```javascript
   import { formatVatLabel, getVatBreakdown } from '../../utils/vatUtils';

   const CartSummaryPanel = ({ cart }) => {
     // Get dynamic VAT breakdown
     const vatBreakdown = getVatBreakdown(cart.vatCalculations);

     return (
       <Box>
         {/* Subtotal */}
         <Typography variant="body2">
           Subtotal: £{cart.subtotal.toFixed(2)}
         </Typography>

         {/* Dynamic VAT Display - Phase 8 */}
         <Typography variant="body2">
           {vatBreakdown.vatLabel}: {vatBreakdown.vatAmount}
         </Typography>

         {/* Total */}
         <Typography variant="h6">
           Total: {vatBreakdown.grossAmount}
         </Typography>

         {/* Optional: Display region */}
         {vatBreakdown.region && (
           <Typography variant="caption" color="textSecondary">
             VAT calculated for {vatBreakdown.region} region
           </Typography>
         )}
       </Box>
     );
   };
   ```

3. **Run Tests (Verify GREEN):**
   ```bash
   npm test -- --testPathPattern=CartSummaryPanel --watchAll=false
   ```

   **Expected Result:** All CartSummaryPanel tests PASS

4. **Browser Verification (Manual):**
   - Start frontend: `npm start`
   - Navigate to cart page
   - Verify VAT label displays correctly
   - Verify VAT amount displays correctly

**Acceptance Criteria (GREEN Phase):**
- ✅ Hardcoded "VAT (20%)" removed
- ✅ Dynamic VAT label from `vatCalculations.totals.effective_vat_rate`
- ✅ Dynamic VAT amount from `vatCalculations.totals.vat`
- ✅ All CartSummaryPanel tests passing
- ✅ Browser rendering correct (verified manually)

---

### TASK-804: Update CartReviewStep Component (TDD GREEN)

**Goal:** Replace hardcoded "VAT (20%)" in checkout review step

**TDD Stage:** GREEN - Update component to make tests pass

**Steps:**

1. **Create Component Tests (RED Phase):**

   **File:** `frontend/react-Admin3/src/components/Checkout/__tests__/CartReviewStep.test.js`
   ```javascript
   import { render, screen } from '@testing-library/react';
   import CartReviewStep from '../CartReviewStep';

   describe('CartReviewStep - Phase 8 VAT Display', () => {
     test('displays dynamic VAT rate from vatCalculations', () => {
       const mockCart = {
         items: [],
         subtotal: 100.00,
         total: 115.00,
         vatCalculations: {
           totals: {
             net: 100.00,
             vat: 15.00,
             gross: 115.00,
             effective_vat_rate: 0.15
           },
           region: 'SA'
         }
       };

       render(<CartReviewStep cart={mockCart} />);

       // Should display "VAT (15%)" for South Africa
       expect(screen.getByText('VAT (15%)')).toBeInTheDocument();
       expect(screen.getByText(/15\.00/)).toBeInTheDocument();
     });

     test('displays 0% VAT for EU reverse charge', () => {
       const mockCart = {
         items: [],
         subtotal: 100.00,
         total: 100.00,
         vatCalculations: {
           totals: {
             net: 100.00,
             vat: 0.00,
             gross: 100.00,
             effective_vat_rate: 0.00
           },
           region: 'EU',
           exemption_reason: 'B2B reverse charge'
         }
       };

       render(<CartReviewStep cart={mockCart} />);

       expect(screen.getByText('VAT (0%)')).toBeInTheDocument();
     });
   });
   ```

2. **Run Tests (Verify RED):**
   ```bash
   npm test -- --testPathPattern=CartReviewStep --watchAll=false
   ```

   **Expected Result:** Tests FAIL (hardcoded VAT still in component)

3. **Update CartReviewStep.js (GREEN Phase):**

   **File:** `frontend/react-Admin3/src/components/Checkout/CartReviewStep.js`

   **BEFORE (Line 114):**
   ```javascript
   <TableRow>
     <TableCell>VAT (20%)</TableCell>
     <TableCell align="right">£{cart.vatAmount.toFixed(2)}</TableCell>
   </TableRow>
   ```

   **AFTER:**
   ```javascript
   import { formatVatLabel, getVatBreakdown } from '../../utils/vatUtils';

   const CartReviewStep = ({ cart }) => {
     const vatBreakdown = getVatBreakdown(cart.vatCalculations);

     return (
       <Table>
         <TableBody>
           {/* Cart Items */}
           {cart.items.map(item => (
             <TableRow key={item.id}>
               <TableCell>{item.name}</TableCell>
               <TableCell align="right">£{item.price.toFixed(2)}</TableCell>
             </TableRow>
           ))}

           {/* Subtotal */}
           <TableRow>
             <TableCell>Subtotal</TableCell>
             <TableCell align="right">£{cart.subtotal.toFixed(2)}</TableCell>
           </TableRow>

           {/* Dynamic VAT Display - Phase 8 */}
           <TableRow>
             <TableCell>{vatBreakdown.vatLabel}</TableCell>
             <TableCell align="right">{vatBreakdown.vatAmount}</TableCell>
           </TableRow>

           {/* Total */}
           <TableRow>
             <TableCell><strong>Total</strong></TableCell>
             <TableCell align="right"><strong>{vatBreakdown.grossAmount}</strong></TableCell>
           </TableRow>

           {/* Optional: VAT exemption reason */}
           {cart.vatCalculations?.exemption_reason && (
             <TableRow>
               <TableCell colSpan={2}>
                 <Typography variant="caption" color="textSecondary">
                   {cart.vatCalculations.exemption_reason}
                 </Typography>
               </TableCell>
             </TableRow>
           )}
         </TableBody>
       </Table>
     );
   };
   ```

4. **Run Tests (Verify GREEN):**
   ```bash
   npm test -- --testPathPattern=CartReviewStep --watchAll=false
   ```

   **Expected Result:** All CartReviewStep tests PASS

**Acceptance Criteria (GREEN Phase):**
- ✅ Hardcoded "VAT (20%)" removed from CartReviewStep
- ✅ Dynamic VAT label from API
- ✅ Dynamic VAT amount from API
- ✅ All CartReviewStep tests passing
- ✅ Handles exemption reasons gracefully

---

### TASK-805: Update TutorialProductCard Component (TDD GREEN)

**Goal:** Replace hardcoded prices with dynamic product variation data

**TDD Stage:** GREEN - Update component to make tests pass

**Steps:**

1. **Create Component Tests (RED Phase):**

   **File:** `frontend/react-Admin3/src/components/Products/__tests__/TutorialProductCard.test.js`
   ```javascript
   import { render, screen } from '@testing-library/react';
   import TutorialProductCard from '../TutorialProductCard';

   describe('TutorialProductCard - Phase 8 VAT Display', () => {
     test('displays dynamic VAT status from product data', () => {
       const mockProduct = {
         id: 1,
         name: 'Online Tutorial',
         price: 120.00,
         vat_status: 'included',
         vat_status_display: 'Price includes VAT (20%)'
       };

       render(<TutorialProductCard product={mockProduct} />);

       // Should display dynamic VAT status from API
       expect(screen.getByText('Price includes VAT (20%)')).toBeInTheDocument();
     });

     test('displays exempt status for digital products', () => {
       const mockProduct = {
         id: 2,
         name: 'eBook Material',
         price: 50.00,
         vat_status: 'exempt',
         vat_status_display: 'VAT exempt (UK eBook)'
       };

       render(<TutorialProductCard product={mockProduct} />);

       expect(screen.getByText('VAT exempt (UK eBook)')).toBeInTheDocument();
     });

     test('handles missing VAT status gracefully', () => {
       const mockProduct = {
         id: 3,
         name: 'Legacy Product',
         price: 100.00
       };

       render(<TutorialProductCard product={mockProduct} />);

       // Should render without VAT status if missing
       expect(screen.getByText('£100.00')).toBeInTheDocument();
     });
   });
   ```

2. **Run Tests (Verify RED):**
   ```bash
   npm test -- --testPathPattern=TutorialProductCard --watchAll=false
   ```

   **Expected Result:** Tests FAIL (hardcoded VAT still in component)

3. **Update TutorialProductCard.js (GREEN Phase):**

   **File:** `frontend/react-Admin3/src/components/Products/TutorialProductCard.js`

   **BEFORE:**
   ```javascript
   <Card>
     <CardContent>
       <Typography variant="h6">{product.name}</Typography>
       <Typography variant="body2">£{product.price.toFixed(2)}</Typography>
       <Typography variant="caption">Price includes VAT</Typography>
     </CardContent>
   </Card>
   ```

   **AFTER:**
   ```javascript
   import { getVatStatusDisplay } from '../../utils/vatUtils';

   const TutorialProductCard = ({ product }) => {
     // Use dynamic VAT status from API (Phase 8)
     const vatStatusText = product.vat_status_display ||
                          getVatStatusDisplay(product.vat_status) ||
                          '';

     return (
       <Card>
         <CardContent>
           <Typography variant="h6">{product.name}</Typography>

           <Typography variant="body2">
             £{product.price.toFixed(2)}
           </Typography>

           {/* Dynamic VAT Status - Phase 8 */}
           {vatStatusText && (
             <Typography variant="caption" color="textSecondary">
               {vatStatusText}
             </Typography>
           )}
         </CardContent>
       </Card>
     );
   };
   ```

4. **Run Tests (Verify GREEN):**
   ```bash
   npm test -- --testPathPattern=TutorialProductCard --watchAll=false
   ```

   **Expected Result:** All TutorialProductCard tests PASS

**Acceptance Criteria (GREEN Phase):**
- ✅ Hardcoded "Price includes VAT" removed
- ✅ Dynamic VAT status from `product.vat_status_display`
- ✅ Fallback to `getVatStatusDisplay(product.vat_status)`
- ✅ All TutorialProductCard tests passing
- ✅ Handles missing VAT data gracefully

---

### TASK-806: Browser Verification with Browser MCP (TDD Verification)

**Goal:** Verify all frontend changes render correctly in browser

**TDD Stage:** Verification - Confirm visual rendering matches expectations

**Steps:**

1. **Start Frontend Development Server:**
   ```bash
   cd frontend/react-Admin3
   npm start
   ```

2. **Verify CartSummaryPanel Rendering:**
   ```javascript
   // Using Browser MCP
   await browser.navigate('http://localhost:3000/cart');
   await browser.snapshot();

   // Take screenshot
   await browser.screenshot();

   // Verify VAT label rendering
   const snapshot = await browser.snapshot();
   // Look for dynamic "VAT (20%)" or "VAT (15%)" etc.
   ```

3. **Verify Checkout Flow:**
   ```javascript
   // Navigate to checkout
   await browser.navigate('http://localhost:3000/checkout/review');
   await browser.snapshot();

   // Verify CartReviewStep rendering
   const snapshot = await browser.snapshot();
   // Confirm dynamic VAT display
   ```

4. **Verify Product Cards:**
   ```javascript
   // Navigate to products page
   await browser.navigate('http://localhost:3000/products');
   await browser.snapshot();

   // Verify TutorialProductCard rendering
   const snapshot = await browser.snapshot();
   // Confirm dynamic VAT status text
   ```

5. **Test Different VAT Scenarios:**
   - UK user → Should see "VAT (20%)"
   - SA user → Should see "VAT (15%)"
   - EU user → Should see "VAT (0%)" with reverse charge message
   - Digital product → Should see "VAT exempt" message

6. **Document Results:**
   Create file: `frontend/react-Admin3/PHASE8_BROWSER_VERIFICATION.md`
   ```markdown
   # Phase 8 Browser Verification Results

   ## CartSummaryPanel
   - ✅ Dynamic VAT label displays correctly
   - ✅ VAT amount matches API data
   - ✅ Total calculation correct

   ## CartReviewStep
   - ✅ Dynamic VAT label in checkout review
   - ✅ Exemption reasons display when present

   ## TutorialProductCard
   - ✅ Dynamic VAT status from product data
   - ✅ Gracefully handles missing VAT data

   ## Screenshots
   - cart_summary_uk.png
   - cart_summary_sa.png
   - checkout_review_eu.png
   - product_card_digital.png
   ```

**Acceptance Criteria (Verification Phase):**
- ✅ CartSummaryPanel renders correctly in browser
- ✅ CartReviewStep renders correctly in browser
- ✅ TutorialProductCard renders correctly in browser
- ✅ All VAT scenarios verified (UK, SA, EU, ROW)
- ✅ Screenshots captured for documentation
- ✅ No console errors or warnings

---

### TASK-807: Create End-to-End Frontend VAT Tests (TDD Comprehensive)

**Goal:** Create comprehensive end-to-end tests for VAT display

**TDD Stage:** Comprehensive Testing - Full user flow verification

**Steps:**

1. **Create E2E Test Suite:**

   **File:** `frontend/react-Admin3/src/__tests__/e2e/vatDisplay.e2e.test.js`
   ```javascript
   import { render, screen, waitFor } from '@testing-library/react';
   import { BrowserRouter } from 'react-router-dom';
   import userEvent from '@testing-library/user-event';
   import App from '../../App';

   describe('Phase 8 VAT Display - End-to-End', () => {
     beforeEach(() => {
       // Mock API responses
       global.fetch = jest.fn();
     });

     afterEach(() => {
       jest.restoreAllMocks();
     });

     test('UK user sees 20% VAT throughout checkout flow', async () => {
       // Mock cart API response for UK user
       global.fetch.mockResolvedValueOnce({
         ok: true,
         json: async () => ({
           id: 1,
           items: [
             { id: 1, name: 'Printed Material', price: 100.00, quantity: 1 }
           ],
           subtotal: 100.00,
           total: 120.00,
           vatCalculations: {
             totals: {
               net: 100.00,
               vat: 20.00,
               gross: 120.00,
               effective_vat_rate: 0.20
             },
             region: 'UK'
           }
         })
       });

       render(
         <BrowserRouter>
           <App />
         </BrowserRouter>
       );

       // Navigate to cart
       userEvent.click(screen.getByText('Cart'));

       await waitFor(() => {
         expect(screen.getByText('VAT (20%)')).toBeInTheDocument();
         expect(screen.getByText(/20\.00/)).toBeInTheDocument();
       });

       // Proceed to checkout
       userEvent.click(screen.getByText('Checkout'));

       await waitFor(() => {
         // Should still display VAT (20%) in checkout
         expect(screen.getByText('VAT (20%)')).toBeInTheDocument();
       });
     });

     test('EU user sees 0% VAT with reverse charge message', async () => {
       // Mock cart API response for EU user
       global.fetch.mockResolvedValueOnce({
         ok: true,
         json: async () => ({
           id: 2,
           items: [
             { id: 1, name: 'Product', price: 100.00, quantity: 1 }
           ],
           subtotal: 100.00,
           total: 100.00,
           vatCalculations: {
             totals: {
               net: 100.00,
               vat: 0.00,
               gross: 100.00,
               effective_vat_rate: 0.00
             },
             region: 'EU',
             exemption_reason: 'B2B reverse charge applies'
           }
         })
       });

       render(
         <BrowserRouter>
           <App />
         </BrowserRouter>
       );

       userEvent.click(screen.getByText('Cart'));

       await waitFor(() => {
         expect(screen.getByText('VAT (0%)')).toBeInTheDocument();
         expect(screen.getByText(/B2B reverse charge/)).toBeInTheDocument();
       });
     });

     test('SA user sees 15% VAT', async () => {
       // Mock cart API response for SA user
       global.fetch.mockResolvedValueOnce({
         ok: true,
         json: async () => ({
           id: 3,
           items: [
             { id: 1, name: 'Product', price: 100.00, quantity: 1 }
           ],
           subtotal: 100.00,
           total: 115.00,
           vatCalculations: {
             totals: {
               net: 100.00,
               vat: 15.00,
               gross: 115.00,
               effective_vat_rate: 0.15
             },
             region: 'SA'
           }
         })
       });

       render(
         <BrowserRouter>
           <App />
         </BrowserRouter>
       );

       userEvent.click(screen.getByText('Cart'));

       await waitFor(() => {
         expect(screen.getByText('VAT (15%)')).toBeInTheDocument();
         expect(screen.getByText(/15\.00/)).toBeInTheDocument();
       });
     });

     test('handles API errors gracefully', async () => {
       // Mock failed API response
       global.fetch.mockRejectedValueOnce(new Error('API Error'));

       render(
         <BrowserRouter>
           <App />
         </BrowserRouter>
       );

       userEvent.click(screen.getByText('Cart'));

       await waitFor(() => {
         // Should display generic "VAT" label on error
         expect(screen.getByText('VAT')).toBeInTheDocument();
       });
     });
   });
   ```

2. **Run E2E Tests:**
   ```bash
   npm test -- --testPathPattern=vatDisplay.e2e --watchAll=false
   ```

   **Expected Result:** All E2E tests PASS

**Acceptance Criteria (Comprehensive Testing):**
- ✅ UK user flow tested (20% VAT)
- ✅ EU user flow tested (0% VAT, reverse charge)
- ✅ SA user flow tested (15% VAT)
- ✅ ROW user flow tested (0% VAT)
- ✅ API error handling tested
- ✅ All E2E tests passing (100% coverage of user flows)

---

### TASK-808: Remove All Hardcoded VAT Logic (TDD REFACTOR)

**Goal:** Final cleanup - Remove any remaining hardcoded VAT logic

**TDD Stage:** REFACTOR - Clean up codebase while keeping tests green

**Steps:**

1. **Search for Remaining Hardcoded Patterns:**
   ```bash
   cd frontend/react-Admin3/src

   # Search for hardcoded VAT patterns
   grep -r "20%" components/ | grep -i vat
   grep -r "* 1.2" components/
   grep -r "Price includes VAT" components/
   ```

2. **Remove Any Remaining Hardcoded Logic:**
   - Update any components found in search
   - Replace with dynamic VAT utility functions
   - Ensure all components use `vatCalculations` from API

3. **Create Regression Test:**

   **File:** `frontend/react-Admin3/src/__tests__/regression/noHardcodedVat.test.js`
   ```javascript
   import fs from 'fs';
   import path from 'path';

   describe('Phase 8 Regression - No Hardcoded VAT Logic', () => {
     const componentsDir = path.join(__dirname, '../../components');

     test('no component files contain hardcoded "VAT (20%)"', () => {
       const files = getAllComponentFiles(componentsDir);

       files.forEach(file => {
         const content = fs.readFileSync(file, 'utf8');

         // Should NOT contain hardcoded "VAT (20%)"
         expect(content).not.toMatch(/VAT \(20%\)/);

         // Should NOT contain hardcoded "VAT (0%)"
         expect(content).not.toMatch(/VAT \(0%\)/);
       });
     });

     test('no component files contain hardcoded "Price includes VAT"', () => {
       const files = getAllComponentFiles(componentsDir);

       files.forEach(file => {
         const content = fs.readFileSync(file, 'utf8');

         // Allow in tests, but not in component source
         if (!file.includes('__tests__')) {
           expect(content).not.toMatch(/Price includes VAT(?!\s*\{)/);
         }
       });
     });

     test('all components import vatUtils for VAT formatting', () => {
       const files = getAllComponentFiles(componentsDir);
       const filesWithVatDisplay = files.filter(file => {
         const content = fs.readFileSync(file, 'utf8');
         return content.includes('vatCalculations') ||
                content.includes('vat_status');
       });

       filesWithVatDisplay.forEach(file => {
         const content = fs.readFileSync(file, 'utf8');

         // Should import from vatUtils
         expect(content).toMatch(/from ['"].*vatUtils['"]/);
       });
     });

     function getAllComponentFiles(dir) {
       let files = [];
       const items = fs.readdirSync(dir);

       items.forEach(item => {
         const fullPath = path.join(dir, item);
         const stat = fs.statSync(fullPath);

         if (stat.isDirectory() && !item.startsWith('.')) {
           files = files.concat(getAllComponentFiles(fullPath));
         } else if (item.endsWith('.js') || item.endsWith('.jsx')) {
           files.push(fullPath);
         }
       });

       return files;
     }
   });
   ```

4. **Run Regression Tests:**
   ```bash
   npm test -- --testPathPattern=noHardcodedVat --watchAll=false
   ```

   **Expected Result:** All regression tests PASS

5. **Run Full Test Suite:**
   ```bash
   npm test -- --coverage --watchAll=false
   ```

   **Expected Result:** All tests PASS, coverage > 80%

**Acceptance Criteria (REFACTOR Phase):**
- ✅ No hardcoded "VAT (20%)" in component files
- ✅ No hardcoded "Price includes VAT" in component files
- ✅ All components use vatUtils for VAT formatting
- ✅ Regression tests passing
- ✅ Full test suite passing (100% success rate)
- ✅ Test coverage > 80%

---

## Phase 8 Summary

### Tasks Completed
1. ✅ TASK-801: Audit Frontend for Hardcoded VAT Logic (RED)
2. ✅ TASK-802: Create VAT Utility Functions (GREEN)
3. ✅ TASK-803: Update CartSummaryPanel Component (GREEN)
4. ✅ TASK-804: Update CartReviewStep Component (GREEN)
5. ✅ TASK-805: Update TutorialProductCard Component (GREEN)
6. ✅ TASK-806: Browser Verification with Browser MCP (Verification)
7. ✅ TASK-807: Create End-to-End Frontend VAT Tests (Comprehensive)
8. ✅ TASK-808: Remove All Hardcoded VAT Logic (REFACTOR)

### Acceptance Criteria
- ✅ All frontend components use API VAT data
- ✅ No frontend VAT calculation logic
- ✅ Browser MCP verification passes
- ✅ Visual rendering correct
- ✅ All tests passing (80%+ coverage)
- ✅ vatUtils.js created with comprehensive utility functions
- ✅ CartSummaryPanel uses dynamic VAT
- ✅ CartReviewStep uses dynamic VAT
- ✅ TutorialProductCard uses dynamic VAT status
- ✅ E2E tests cover all VAT scenarios
- ✅ Regression tests prevent reintroduction of hardcoded VAT

### Files Created
- `frontend/react-Admin3/src/utils/vatUtils.js` - VAT utility functions
- `frontend/react-Admin3/src/utils/__tests__/vatUtils.test.js` - Unit tests
- `frontend/react-Admin3/src/__tests__/e2e/vatDisplay.e2e.test.js` - E2E tests
- `frontend/react-Admin3/src/__tests__/regression/noHardcodedVat.test.js` - Regression tests
- `frontend/react-Admin3/HARDCODED_VAT_AUDIT.md` - Audit documentation
- `frontend/react-Admin3/PHASE8_BROWSER_VERIFICATION.md` - Browser verification results

### Files Modified
- `frontend/react-Admin3/src/components/Cart/CartSummaryPanel.js` - Dynamic VAT display
- `frontend/react-Admin3/src/components/Checkout/CartReviewStep.js` - Dynamic VAT display
- `frontend/react-Admin3/src/components/Products/TutorialProductCard.js` - Dynamic VAT status

---

## Next Steps

After Phase 8 completion, proceed to:
- **Phase 7: Django Admin Interface** (Create admin interfaces for VAT management)
- **Phase 9: Testing & Documentation** (Comprehensive testing and documentation)

---

*Generated for Admin3 project - VAT Calculation System Phase 8*
*TDD Methodology: RED-GREEN-REFACTOR*
*Estimated Duration: 2-3 days*
