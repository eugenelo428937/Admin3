<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete JSON Content System Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { 
            color: #28a745; 
            background-color: #d4edda;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #c3e6cb;
            margin: 10px 0;
        }
        .error { 
            color: #dc3545; 
            background-color: #f8d7da;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #f5c6cb;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background-color: #fff3cd;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
            margin: 10px 0;
        }
        .test-section { 
            margin: 30px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        .content-preview {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            background: white;
            min-height: 300px;
        }
        button { 
            margin: 8px 5px; 
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        button.warning:hover {
            background-color: #e0a800;
        }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
            max-height: 400px;
        }
        h1, h2, h3 {
            color: #343a40;
        }
        h1 { border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        h2 { border-bottom: 2px solid #6c757d; padding-bottom: 8px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        .json-structure {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.3;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Complete JSON Content System Test</h1>
        <p>Testing both Terms & Conditions and Summer Holiday JSON content rendering systems.</p>
        
        <div class="stats">
            <div class="stat-card">
                <span class="stat-number" id="tests-run">0</span>
                <span>Tests Run</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="json-templates">2</span>
                <span>JSON Templates</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="components-mapped">7</span>
                <span>UI Components</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="features-active">12</span>
                <span>Active Features</span>
            </div>
        </div>

        <div class="test-section">
            <h2>1. Terms & Conditions JSON Test</h2>
            <p>Test the checkout T&C system with JSON content rendering:</p>
            
            <button onclick="testTermsAndConditions()">Test T&C JSON Content</button>
            <button onclick="showTCStructure()">Show JSON Structure</button>
            <div id="tc-test-result"></div>
        </div>

        <div class="test-section">
            <h2>2. Summer Holiday JSON Test</h2>
            <p>Test the summer holiday notice with JSON content rendering:</p>
            
            <button onclick="testSummerHoliday()" class="warning">Test Summer Holiday JSON</button>
            <button onclick="showHolidayStructure()">Show JSON Structure</button>
            <div id="holiday-test-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Comparative Analysis</h2>
            <div class="test-grid">
                <div class="content-preview">
                    <h3>üìã Terms & Conditions</h3>
                    <div id="tc-analysis">
                        <p><em>Click "Test T&C JSON Content" to analyze...</em></p>
                    </div>
                </div>
                <div class="content-preview">
                    <h3>üèñÔ∏è Summer Holiday Notice</h3>
                    <div id="holiday-analysis">
                        <p><em>Click "Test Summer Holiday JSON" to analyze...</em></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>4. JSON Content System Features</h2>
            <div class="feature-list">
                <div class="feature-card">
                    <h4>üèóÔ∏è Structured Content</h4>
                    <ul>
                        <li>Container/Box elements</li>
                        <li>Nested content support</li>
                        <li>Sequential ordering</li>
                        <li>CSS class mapping</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>üé® Material UI Integration</h4>
                    <ul>
                        <li>Typography components</li>
                        <li>Box layout system</li>
                        <li>List components</li>
                        <li>Alert styling</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>üìù Markdown Support</h4>
                    <ul>
                        <li><strong>Bold text</strong> rendering</li>
                        <li>Link parsing</li>
                        <li>Variable substitution</li>
                        <li>Recursive processing</li>
                    </ul>
                </div>
                <div class="feature-card">
                    <h4>üîß Developer Benefits</h4>
                    <ul>
                        <li>Type safety</li>
                        <li>Easy maintenance</li>
                        <li>Backward compatibility</li>
                        <li>Django admin interface</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>5. Implementation Summary</h2>
            <div class="warning">
                <strong>‚úÖ Successfully Converted Templates:</strong>
                <ul>
                    <li><code>general_terms_conditions</code> ‚Üí JSON format with 4 content elements</li>
                    <li><code>summer_holiday_2025</code> ‚Üí JSON format with 2 main sections</li>
                </ul>
            </div>
            
            <div class="success">
                <strong>üéØ Key Achievements:</strong>
                <ul>
                    <li>Structured data instead of HTML strings</li>
                    <li>Material UI component mapping</li>
                    <li>Variable processing in JSON structures</li>
                    <li>Enhanced styling and layout control</li>
                    <li>Backward compatibility maintained</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8888';
        let testsRun = 0;
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(API_BASE + endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                const data = await response.json();
                return { success: response.ok, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        function updateTestCounter() {
            testsRun++;
            document.getElementById('tests-run').textContent = testsRun;
        }
        
        function createLoadingIndicator() {
            return '<div class="loading"></div> Loading...';
        }
        
        async function testTermsAndConditions() {
            const element = document.getElementById('tc-test-result');
            const analysisElement = document.getElementById('tc-analysis');
            
            element.innerHTML = createLoadingIndicator();
            updateTestCounter();
            
            const result = await apiCall('/api/rules/engine/evaluate/', {
                method: 'POST',
                body: JSON.stringify({
                    entry_point_code: 'checkout_terms'
                })
            });
            
            if (result.success && result.data.messages && result.data.messages.length > 0) {
                const message = result.data.messages[0];
                
                element.innerHTML = `
                    <div class="success">‚úÖ T&C JSON Content Retrieved Successfully</div>
                    <div class="content-preview">
                        <h4>${message.title}</h4>
                        <p><strong>Format:</strong> ${message.content_format}</p>
                        <p><strong>Message Type:</strong> ${message.message_type}</p>
                        <p><strong>Requires Acknowledgment:</strong> ${message.requires_acknowledgment ? 'Yes' : 'No'}</p>
                        ${message.json_content ? 
                            `<details>
                                <summary>JSON Structure (click to expand)</summary>
                                <pre class="json-structure">${JSON.stringify(message.json_content, null, 2)}</pre>
                            </details>` :
                            '<p>No JSON content available</p>'
                        }
                    </div>
                `;
                
                // Update analysis
                if (message.json_content) {
                    const content = message.json_content;
                    analysisElement.innerHTML = `
                        <p><strong>Structure Analysis:</strong></p>
                        <ul>
                            <li>Content elements: ${content.content ? content.content.length : 0}</li>
                            <li>Container: ${content.message_container ? content.message_container.element : 'None'}</li>
                            <li>Element types: ${content.content ? [...new Set(content.content.map(c => c.element))].join(', ') : 'None'}</li>
                            <li>CSS classes: ${content.message_container ? content.message_container.class : 'None'}</li>
                        </ul>
                        <p><strong>Features:</strong> Variables, Markdown, Lists, Structured layout</p>
                    `;
                }
            } else {
                element.innerHTML = `<div class="error">‚ùå Error: ${result.error || 'No messages returned'}</div>`;
            }
        }
        
        async function testSummerHoliday() {
            const element = document.getElementById('holiday-test-result');
            const analysisElement = document.getElementById('holiday-analysis');
            
            element.innerHTML = createLoadingIndicator();
            updateTestCounter();
            
            const result = await apiCall('/api/rules/engine/evaluate/', {
                method: 'POST',
                body: JSON.stringify({
                    entry_point_code: 'home_page_mount'
                })
            });
            
            if (result.success && result.data.messages && result.data.messages.length > 0) {
                const message = result.data.messages[0];
                
                element.innerHTML = `
                    <div class="success">‚úÖ Summer Holiday JSON Content Retrieved Successfully</div>
                    <div class="content-preview">
                        <h4>${message.title}</h4>
                        <p><strong>Format:</strong> ${message.content_format}</p>
                        <p><strong>Message Type:</strong> ${message.message_type}</p>
                        <p><strong>Variables Processed:</strong> staff_name ‚Üí "Customer Services Team"</p>
                        ${message.json_content ? 
                            `<details>
                                <summary>JSON Structure (click to expand)</summary>
                                <pre class="json-structure">${JSON.stringify(message.json_content, null, 2)}</pre>
                            </details>` :
                            '<p>No JSON content available</p>'
                        }
                    </div>
                `;
                
                // Update analysis
                if (message.json_content) {
                    const content = message.json_content;
                    const allElements = [];
                    function collectElements(items) {
                        if (Array.isArray(items)) {
                            items.forEach(item => {
                                if (item.element) allElements.push(item.element);
                                if (item.content) collectElements(item.content);
                            });
                        }
                    }
                    collectElements(content.content);
                    
                    analysisElement.innerHTML = `
                        <p><strong>Structure Analysis:</strong></p>
                        <ul>
                            <li>Main sections: ${content.content ? content.content.length : 0}</li>
                            <li>Total elements: ${allElements.length}</li>
                            <li>Element types: ${[...new Set(allElements)].join(', ')}</li>
                            <li>Alert styling: Warning theme with custom colors</li>
                        </ul>
                        <p><strong>Features:</strong> Nested boxes, Alert styling, Variable substitution, Multi-section layout</p>
                    `;
                }
            } else {
                element.innerHTML = `<div class="error">‚ùå Error: ${result.error || 'No messages returned'}</div>`;
            }
        }
        
        function showTCStructure() {
            const structure = {
                "message_container": {
                    "element": "container",
                    "text_align": "left",
                    "class": "terms-conditions-content",
                    "title": "h4",
                    "text": "Terms & Conditions"
                },
                "content": [
                    {
                        "seq": 1,
                        "element": "p",
                        "text": "By completing this purchase..."
                    },
                    {
                        "seq": 2,
                        "element": "ul", 
                        "text": ["Item 1", "Item 2", "Item 3", "Item 4"]
                    },
                    {
                        "seq": 3,
                        "element": "p",
                        "text": "Links: [/terms](Terms) and [/privacy](Privacy)"
                    },
                    {
                        "seq": 4,
                        "element": "p",
                        "text": "**This acceptance is required...**"
                    }
                ]
            };
            
            document.getElementById('tc-test-result').innerHTML = `
                <div class="warning">üìã Terms & Conditions JSON Structure</div>
                <pre class="json-structure">${JSON.stringify(structure, null, 2)}</pre>
            `;
        }
        
        function showHolidayStructure() {
            const structure = {
                "message_container": {
                    "element": "container",
                    "class": "summer-holiday-notice"
                },
                "content": [
                    {
                        "seq": 1,
                        "element": "box",
                        "class": "alert alert-warning holiday-alert",
                        "content": [
                            {"element": "h5", "text": "**Summer Holiday 09/08/2025 - 21/08/2025**"},
                            {"element": "p", "text": "The office will be closed..."},
                            {"element": "p", "text": "Contact **{staff_name}** for urgent..."}
                        ]
                    },
                    {
                        "seq": 2,
                        "element": "box", 
                        "class": "holiday-tips",
                        "content": [
                            {"element": "h6", "text": "Important Information:"},
                            {"element": "ul", "text": ["Tip 1", "Tip 2", "Tip 3", "Tip 4"]}
                        ]
                    }
                ]
            };
            
            document.getElementById('holiday-test-result').innerHTML = `
                <div class="warning">üèñÔ∏è Summer Holiday JSON Structure</div>
                <pre class="json-structure">${JSON.stringify(structure, null, 2)}</pre>
            `;
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            console.log('Testing complete JSON content system...');
            setTimeout(testTermsAndConditions, 500);
            setTimeout(testSummerHoliday, 1500);
        };
    </script>
</body>
</html>