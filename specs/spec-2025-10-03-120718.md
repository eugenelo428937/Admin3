# Feature Specification: Tutorial Cart Integration Fix

**Feature Branch**: `epic-1-tutorial-cart-fix`
**Created**: 2025-10-03
**Status**: Ready for Planning
**Input**: User description: "@docs\stories\epic-tutorial-cart-fix - Fix tutorial cart duplication bug and implement draft state tracking"

## Execution Flow (main)
```
1. Parse user description from Input ‚Üí ‚úÖ Parsed from Epic 1 documentation
2. Extract key concepts from description ‚Üí ‚úÖ Identified: cart duplication bug, isDraft state, localStorage migration
3. For each unclear aspect ‚Üí ‚úÖ All aspects clearly defined in epic documentation
4. Fill User Scenarios & Testing section ‚Üí ‚úÖ Completed
5. Generate Functional Requirements ‚Üí ‚úÖ All requirements testable
6. Identify Key Entities (if data involved) ‚Üí ‚úÖ TutorialChoice entity identified
7. Run Review Checklist ‚Üí ‚úÖ No [NEEDS CLARIFICATION] markers
8. Return: SUCCESS (spec ready for planning) ‚Üí ‚úÖ READY
```

---

## ‚ö° Quick Guidelines
- ‚úÖ Focus on WHAT users need and WHY
- ‚ùå Avoid HOW to implement (no tech stack, APIs, code structure)
- üë• Written for business stakeholders, not developers

---

## User Scenarios & Testing

### Primary User Story
**Problem:** When students select tutorial courses for the same subject (e.g., CS2 - Computer Science 2), they can choose up to 3 preferences (1st choice, 2nd choice, 3rd choice). Currently, when a student adds a tutorial choice to their cart and then adds another choice for the same subject, the system creates duplicate cart items instead of updating the existing cart item with the additional choices. This creates confusion and potential checkout errors.

**Solution:** The system must maintain a single cart item per subject that contains all tutorial choices (up to 3). Additionally, the system must track which tutorial selections are "draft" (being considered) versus which have been added to the cart.

**User Journey:**
1. Student browses tutorial courses for CS2
2. Student selects Bristol location as their 1st choice
3. Student adds this choice to cart ‚Üí Cart shows 1 item: "CS2 Tutorial (1st choice: Bristol)"
4. Student continues browsing and selects London location as their 2nd choice
5. Student adds this choice ‚Üí Cart **updates** to show 1 item: "CS2 Tutorial (1st choice: Bristol, 2nd choice: London)"
6. Student can continue adding up to 3rd choice, all within the same cart item

### Acceptance Scenarios

**Scenario 1: Adding first tutorial choice for a subject**
- **Given** the cart is empty
- **When** student selects CS2 Tutorial in Bristol as 1st choice and adds to cart
- **Then** cart contains exactly 1 item for CS2 with Bristol as 1st choice

**Scenario 2: Adding second tutorial choice for same subject**
- **Given** cart contains CS2 Tutorial with Bristol as 1st choice
- **When** student selects CS2 Tutorial in London as 2nd choice and adds to cart
- **Then** cart still contains exactly 1 item for CS2, now showing both Bristol (1st) and London (2nd) choices

**Scenario 3: Adding third tutorial choice for same subject**
- **Given** cart contains CS2 Tutorial with Bristol (1st) and London (2nd) choices
- **When** student selects CS2 Tutorial in Manchester as 3rd choice and adds to cart
- **Then** cart still contains exactly 1 item for CS2, now showing all three choices

**Scenario 4: Removing cart item restores draft state**
- **Given** cart contains CS2 Tutorial with 2 choices
- **When** student removes the CS2 Tutorial item from cart
- **Then** the tutorial selections return to "draft" state and can be modified before re-adding

**Scenario 5: Multiple subjects in cart**
- **Given** cart contains CS2 Tutorial with 2 choices
- **When** student adds CP1 Tutorial with 1 choice to cart
- **Then** cart contains exactly 2 items (one for CS2, one for CP1)

**Scenario 6: Existing data compatibility**
- **Given** a returning student has tutorial choices saved from previous session (without draft state tracking)
- **When** student logs back in and views their saved choices
- **Then** system treats existing saved choices as "in cart" and student can continue shopping without data loss

### Edge Cases

**Edge Case 1: Cart item deleted externally**
- What happens when a cart item is removed by system timeout or external process?
- **Expected:** Tutorial choices associated with that cart item return to "draft" state

**Edge Case 2: Browser storage limit**
- How does system handle reaching browser storage capacity?
- **Expected:** System provides clear error message and prevents adding more choices until storage freed

**Edge Case 3: Corrupted storage data**
- What happens when saved tutorial choice data is malformed or corrupted?
- **Expected:** System gracefully handles corruption, logs error, and allows student to start fresh without crashing

**Edge Case 4: Same tutorial event at different choice levels**
- What happens when student selects the same tutorial event (e.g., Bristol TUT-CS2-001) for both 1st and 2nd choice?
- **Expected:** System either prevents duplicate selection or treats it as valid if business rules allow

**Edge Case 5: Choice level constraint**
- What happens when student tries to add a 3rd choice when 1st and 2nd are not yet selected?
- **Expected:** System allows students to select any choice level in any order (1st, 2nd, 3rd are independent selections)

**Edge Case 6: Data migration from old to new format**
- What happens to choices saved in old format when system upgrades to new format?
- **Expected:** System automatically migrates old data, preserves backup for rollback, and logs migration status

---

## Requirements

### Functional Requirements

**Cart Management:**
- **FR-001**: System MUST maintain exactly one cart item per subject containing all tutorial choices (up to 3)
- **FR-002**: System MUST update existing cart item when student adds additional choices for the same subject (not create duplicate)
- **FR-003**: System MUST allow students to add up to 3 tutorial choices per subject
- **FR-004**: System MUST preserve all existing choices when adding new choices to the same subject cart item

**Draft State Tracking:**
- **FR-005**: System MUST distinguish between "draft" tutorial selections (being considered) and "added to cart" selections
- **FR-006**: System MUST mark new tutorial selections as "draft" by default
- **FR-007**: System MUST change tutorial selection status from "draft" to "in cart" when student adds to cart
- **FR-008**: System MUST change tutorial selection status from "in cart" back to "draft" when student removes cart item

**State Filtering & Query:**
- **FR-009**: System MUST provide ability to retrieve only draft tutorial selections for a subject
- **FR-010**: System MUST provide ability to retrieve only in-cart tutorial selections for a subject
- **FR-011**: System MUST provide ability to check if a subject has any tutorial selections in cart

**Data Persistence:**
- **FR-012**: System MUST persist tutorial choice state (including draft status) across browser sessions
- **FR-013**: System MUST preserve tutorial choice data when browser is closed and reopened
- **FR-014**: System MUST maintain data integrity when student navigates between pages

**Data Migration & Compatibility:**
- **FR-015**: System MUST automatically migrate existing tutorial choice data to new format with draft state
- **FR-016**: System MUST preserve existing tutorial choices during migration (no data loss)
- **FR-017**: System MUST create backup of original data before migration
- **FR-018**: System MUST support rollback from new format to old format if needed
- **FR-019**: System MUST handle mixed data (old format + new format) gracefully during transition period

**Error Handling:**
- **FR-020**: System MUST handle corrupted tutorial choice data without crashing
- **FR-021**: System MUST log all data migration successes and failures
- **FR-022**: System MUST provide clear error messages when storage operations fail

**Backward Compatibility:**
- **FR-023**: System MUST continue to work with existing tutorial choice data (old format)
- **FR-024**: System MUST not break existing cart functionality for other product types (Materials, Bundles, etc.)
- **FR-025**: System MUST maintain all existing tutorial selection capabilities without regression

### Key Entities

**TutorialChoice**
- Represents a student's tutorial selection for a specific subject
- **Key Attributes:**
  - Subject identifier (e.g., "CS2", "CP1")
  - Choice level (1st, 2nd, or 3rd)
  - Tutorial event details (location, event code, date)
  - Draft status (boolean: true = draft, false = in cart)
  - Selection timestamp
  - Product variation details (tutorial format, pricing)
- **Relationships:**
  - Belongs to a specific Subject
  - Associated with a CartItem (when in cart status)
  - Multiple TutorialChoices can exist for same Subject (up to 3)

**CartItem (for Tutorials)**
- Represents a single cart entry for tutorial selections
- **Key Attributes:**
  - Subject identifier
  - Collection of TutorialChoices (1-3 choices)
  - Total price (only 1st choice is charged)
  - Product type = "Tutorial"
- **Relationships:**
  - Contains 1-3 TutorialChoices for same Subject
  - One CartItem per Subject maximum
  - Belongs to user's shopping Cart

**Subject**
- Represents an academic subject/course
- **Key Attributes:**
  - Subject code (e.g., "CS2", "CP1")
  - Subject name (e.g., "Computer Science 2")
- **Relationships:**
  - Can have multiple TutorialChoices
  - Can have maximum of 1 CartItem

---

## Review & Acceptance Checklist

### Content Quality
- [x] No implementation details (languages, frameworks, APIs)
- [x] Focused on user value and business needs
- [x] Written for non-technical stakeholders
- [x] All mandatory sections completed

### Requirement Completeness
- [x] No [NEEDS CLARIFICATION] markers remain ‚Üí **All clarifications resolved**
- [x] Requirements are testable and unambiguous
- [x] Success criteria are measurable
- [x] Scope is clearly bounded
- [x] Dependencies and assumptions identified

**Clarifications Resolved:**
- **Edge Case 5**: Tutorial choice levels (1st, 2nd, 3rd) are independent - students can select any level in any order

---

## Execution Status

- [x] User description parsed
- [x] Key concepts extracted (cart duplication, draft state, migration)
- [x] Ambiguities marked (1 edge case needs clarification)
- [x] User scenarios defined (6 acceptance scenarios + 6 edge cases)
- [x] Requirements generated (25 functional requirements)
- [x] Entities identified (TutorialChoice, CartItem, Subject)
- [x] Review checklist passed (all clarifications resolved)

---

## Success Metrics

**Bug Resolution:**
- Zero duplicate cart items for same subject after implementation
- 100% of multi-choice tutorial additions result in single updated cart item

**Data Integrity:**
- 100% successful migration of existing tutorial choice data
- Zero data loss during migration
- 100% rollback success rate if needed

**User Experience:**
- Students can add 3 tutorial choices for a subject with single cart item
- Clear distinction between draft selections and cart selections
- No regression in existing tutorial selection functionality

**System Stability:**
- No crashes from corrupted data
- Graceful handling of storage limits and errors
- Backward compatibility maintained with old data format

---

## Out of Scope

**Explicitly NOT included in this feature:**
- Changes to tutorial pricing logic (only 1st choice is charged - existing behavior)
- UI/UX redesign of tutorial selection interface (covered in Epic 2)
- Changes to CartContext API for other product types
- Database schema changes (frontend-only feature)
- Backend API modifications
- Tutorial event management or creation
- Subject catalog management
- Tutorial product variation management
- Changes to checkout process beyond cart state

---

## Dependencies & Assumptions

**Dependencies:**
- Existing TutorialChoiceContext implementation
- Existing CartContext implementation
- Browser localStorage availability

**Assumptions:**
- Students use modern browsers with localStorage support
- Tutorial choice limit is 3 per subject (business rule)
- Only 1st choice tutorial is charged (business rule)
- Choice levels (1st, 2nd, 3rd) can be selected in any order - they are independent
- Cart is stored in browser session (no server-side cart persistence)
- Migration will occur automatically on first load after deployment

---

## Next Steps

1. **Clarify Edge Case 5**: Confirm with product owner whether choice levels are sequential or independent
2. **Run `/plan`** to generate technical implementation plan from this spec
3. **Run `/tasks`** to create actionable task breakdown
4. **Assign to development team** for Story 1.1 and Story 1.2 implementation

---

**Spec Status**: ‚úÖ **READY FOR PLANNING** (all clarifications complete)
