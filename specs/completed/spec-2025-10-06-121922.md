# Feature Specification: Dynamic VAT Calculation System

**Feature Branch**: `003-vat-calculation-rules-engine`
**Created**: 2025-10-06
**Status**: Ready for Implementation
**Input**: Epic 3 PRD - Dynamic VAT Calculation System (docs/prd/epic-3-dynamic-vat-calculation-system.md)

## Execution Flow (main)
```
1. Parse PRD from Epic 3
   ‚úÖ Successfully extracted: VAT calculation requirements
2. Extract key concepts
   ‚úÖ Identified: admin users, customers, VAT regions, product types, tax calculations
3. Unclear aspects
   ‚úÖ All requirements clearly defined in PRD
4. Fill User Scenarios & Testing section
   ‚úÖ User flows defined from 6 stories
5. Generate Functional Requirements
   ‚úÖ All requirements testable and unambiguous
6. Identify Key Entities
   ‚úÖ Identified: utils_regions, utils_countrys, utils_country_region, VATAudit
7. Run Review Checklist
   ‚úÖ No implementation details in requirements
   ‚úÖ All business needs clearly stated
8. Return: SUCCESS (spec ready for planning)
```

---

## ‚ö° Quick Guidelines
- ‚úÖ Focus on WHAT users need and WHY
- ‚ùå Avoid HOW to implement (no tech stack, APIs, code structure)
- üë• Written for business stakeholders, not developers

---

## User Scenarios & Testing *(mandatory)*

### Primary User Story
As a **finance administrator**, I want VAT to be calculated automatically based on configurable business rules, so that I can respond to tax regulation changes immediately without requiring software developers or code deployments.

As a **customer**, I want to see accurate VAT charges based on my location and the products I'm purchasing, so that I am charged correctly according to tax regulations.

### Acceptance Scenarios

**Scenario 1: UK Customer Purchases Digital eBook**
- **Given** a customer with UK address purchasing a digital eBook
- **When** the checkout process calculates VAT
- **Then** the system applies 0% VAT (UK eBook exemption rule)
- **And** records the exemption reason as "UK eBook post-2020"

**Scenario 2: EU Customer Purchases Physical Material**
- **Given** a customer with German address purchasing printed study materials
- **When** the checkout process calculates VAT
- **Then** the system applies 0% VAT (B2B reverse charge for EU)
- **And** records the VAT treatment as "EU B2B reverse charge"

**Scenario 3: South Africa Customer Purchases Any Product**
- **Given** a customer with South African address
- **When** adding any product to cart
- **Then** the system applies 15% VAT (SA standard rate)
- **And** displays the VAT amount clearly

**Scenario 4: Admin Updates VAT Rate for Country**
- **Given** an admin user in the VAT administration interface
- **When** they update Ireland's VAT rate from 23% to 24%
- **Then** all future calculations immediately use 24%
- **And** no code deployment is required

**Scenario 5: Finance Manager Reviews VAT Audit Trail**
- **Given** a finance manager needs to audit a specific order
- **When** they view the VAT calculation history
- **Then** they see which rules were applied, input values, and calculated results
- **And** can trace the exact calculation logic used

### Edge Cases
- What happens when a customer's country is not in the VAT country database?
  - System defaults to ROW (Rest of World) region with 0% VAT
- How does the system handle products with mixed digital/physical components?
  - Each line item is evaluated separately based on its product type classification
- What if VAT rate changes during an active shopping session?
  - VAT is recalculated at checkout_start and checkout_payment entry points with current rates
- How are discounts handled with VAT?
  - Discounts are allocated proportionally across items, then VAT is recalculated on discounted amounts

---

## Requirements *(mandatory)*

### Functional Requirements

**Region & Country Management**
- **FR-001**: System MUST maintain a master list of VAT regions (UK, Ireland, EU, South Africa, Rest of World)
- **FR-002**: System MUST store VAT rates for each country independently of user account data
- **FR-003**: System MUST map each country to a VAT region with effective date tracking
- **FR-004**: System MUST allow admin users to update country VAT rates without code changes
- **FR-005**: System MUST allow admin users to modify country-to-region mappings

**VAT Calculation Rules**
- **FR-006**: System MUST execute VAT calculation rules when items are added to cart
- **FR-007**: System MUST execute VAT calculation rules at checkout start
- **FR-008**: System MUST execute VAT calculation rules at checkout payment
- **FR-009**: System MUST calculate VAT per cart item (not as bulk cart operation)
- **FR-010**: System MUST determine customer's VAT region from their country
- **FR-011**: System MUST apply region-specific VAT rules (UK, IE, EU, SA, ROW)
- **FR-012**: System MUST apply product-specific VAT rules based on product type (digital, physical, flash cards, PBOR)
- **FR-013**: System MUST use product type and metadata from cart context (not separate classification)
- **FR-014**: System MUST apply zero VAT for UK digital eBooks effective from May 1, 2020
- **FR-015**: System MUST apply zero VAT for ROW region digital products
- **FR-016**: System MUST apply 15% VAT for all South African purchases
- **FR-017**: System MUST treat Switzerland and Guernsey as ROW for VAT purposes

**VAT Calculation Results**
- **FR-018**: System MUST calculate VAT amount with 2 decimal precision using proper rounding
- **FR-019**: System MUST aggregate individual item VAT amounts to cart total VAT
- **FR-020**: System MUST store complete VAT calculation results with cart
- **FR-021**: System MUST record which specific VAT rule was applied to each item
- **FR-022**: System MUST record exemption reasons for zero-rated items
- **FR-023**: System MUST include region information in VAT calculation results

**Audit & Compliance**
- **FR-024**: System MUST create audit trail record for every VAT calculation
- **FR-025**: System MUST store rule ID and version used in each calculation
- **FR-026**: System MUST store complete input context for each calculation
- **FR-027**: System MUST store complete output results for each calculation
- **FR-028**: System MUST record calculation execution time
- **FR-029**: System MUST allow finance managers to view VAT audit trail by order
- **FR-030**: System MUST allow finance managers to export VAT data for external accounting

**Administration**
- **FR-031**: System MUST provide admin interface for managing VAT regions
- **FR-032**: System MUST provide admin interface for managing country VAT rates
- **FR-033**: System MUST provide admin interface for managing country-region mappings
- **FR-034**: System MUST provide admin interface for testing VAT rules with sample data
- **FR-035**: System MUST provide admin interface for viewing VAT rule execution history
- **FR-036**: System MUST allow admin users to enable/disable specific VAT rules

**Reporting**
- **FR-037**: System MUST generate VAT summary reports by region
- **FR-038**: System MUST generate VAT summary reports by time period
- **FR-039**: System MUST track and report zero VAT exemption reasons
- **FR-040**: System MUST provide order-level VAT breakdowns showing applied rules

**Performance**
- **FR-041**: System MUST complete VAT calculation in under 50ms per cart
- **FR-042**: System MUST maintain 99.9% uptime for VAT calculation service

**Data Separation**
- **FR-043**: System MUST keep VAT country data separate from user account country data
- **FR-044**: System MUST allow VAT rates to be modified without affecting user accounts
- **FR-045**: System MUST preserve user account data when VAT data is updated

### Key Entities *(include if feature involves data)*

- **VAT Region**: Represents a tax jurisdiction group (UK, IE, EU, SA, ROW). Contains region code, name, description, and active status.

- **VAT Country**: Represents VAT-specific country data separate from user accounts. Contains country code, name, VAT percentage, and active status. This is a copy of user country data used exclusively for VAT purposes.

- **Country-Region Mapping**: Links VAT countries to VAT regions with effective date tracking. Contains country reference, region reference, effective from date, and optional effective to date.

- **VAT Audit Record**: Complete audit trail of VAT calculation execution. Contains execution ID, cart/order references, rule ID and version, input context (JSON), output data (JSON), execution duration, and timestamp.

- **VAT Calculation Result**: Structured result stored with cart. Contains calculation status, items array (each with net amount, VAT amount, VAT rate, rule applied, exemption reason), totals (net, VAT, gross), region info, rules executed list, execution time, and timestamp.

- **VAT Rule**: Business rule for calculating VAT. Contains rule ID, name, entry points (add_to_cart, checkout_start, checkout_payment), priority, active status, conditions (JSON logic), actions (updates to item VAT), and stop processing flag.

---

## Review & Acceptance Checklist

### Content Quality
- [x] No implementation details (languages, frameworks, APIs)
- [x] Focused on user value and business needs
- [x] Written for non-technical stakeholders
- [x] All mandatory sections completed

### Requirement Completeness
- [x] No [NEEDS CLARIFICATION] markers remain
- [x] Requirements are testable and unambiguous
- [x] Success criteria are measurable (< 50ms performance, 99.9% uptime, 100% accuracy)
- [x] Scope is clearly bounded (VAT calculation only, not payment processing)
- [x] Dependencies identified (Rules Engine from Epic 1)

---

## Execution Status

- [x] User description parsed (from Epic 3 PRD)
- [x] Key concepts extracted (6 user stories, 3 database models, 45 requirements)
- [x] Ambiguities marked (none - all requirements clear)
- [x] User scenarios defined (5 primary scenarios + 4 edge cases)
- [x] Requirements generated (45 functional requirements)
- [x] Entities identified (6 key entities)
- [x] Review checklist passed (all criteria met)

---

## Success Criteria

**Technical Success:**
- 100% accuracy: All VAT calculations match expected results for all region √ó product type combinations
- Performance: VAT calculation completes in < 50ms per cart under production load
- Reliability: 99.9% uptime for VAT calculation service
- Coverage: All product types and pricing scenarios supported
- Data integrity: VAT country data completely independent of user account data

**Business Success:**
- Tax compliance: Zero VAT calculation errors in external audit
- Admin efficiency: Finance team can update VAT rates in < 5 minutes without developer assistance
- Change response: VAT regulation changes deployed in < 24 hours
- User satisfaction: No customer complaints about VAT accuracy or display

**Operational Success:**
- Complete audit trail for all VAT calculations
- Finance team can generate VAT reports without IT support
- All VAT rule changes tracked and reversible
- System supports future expansion to additional tax jurisdictions

---

## Out of Scope

**Explicitly NOT included in this feature:**
- Payment processing or payment gateway integration
- Currency conversion or multi-currency support
- Tax calculations other than VAT (sales tax, GST, etc.)
- Historical VAT rate changes for past orders (uses current rates only at calculation time)
- Customer-specific VAT exemptions or special tax status
- Product-level VAT override capabilities (all VAT from rules)
- VAT registration number validation
- Real-time integration with government VAT rate databases
- Automated VAT filing or submission to tax authorities

---

## Dependencies & Assumptions

**Dependencies:**
- Epic 1: Enhanced Rules Engine must be complete and functional
- VATAudit database model must exist (from previous Phase 2 work)
- Cart model must have vat_result JSONB field (from previous Phase 2 work)
- Product data must include product_type and metadata fields in cart context

**Assumptions:**
- VAT rates are relatively stable (not changing multiple times per day)
- Admin users have appropriate training to manage VAT rules
- All products have accurate product_type classification
- Customer country is reliably determined from user profile address
- Business operates in jurisdictions covered by the 5 defined regions

---

## Constraints

**Business Constraints:**
- VAT rates must be updateable by finance team without code deployment
- All VAT calculations must have complete audit trail for compliance
- System must support effective date tracking for regulation changes
- VAT calculation logic must be transparent and traceable

**Technical Constraints:**
- VAT calculation must complete in < 50ms per cart
- System must maintain data separation between VAT and user account data
- All VAT logic must reside in Rules Engine (zero hardcoded calculation)
- Decimal precision required for all monetary calculations (2 decimal places, ROUND_HALF_UP)

**Compliance Constraints:**
- Must comply with UK eBook VAT exemption (effective May 1, 2020)
- Must support EU B2B reverse charge mechanism
- Must maintain audit trail for minimum 7 years (standard tax audit period)
- Must accurately reflect current tax regulations for all supported regions

---

## Next Steps

‚úÖ **Specification Complete** - Ready for implementation planning

**Recommended Actions:**
1. Review this specification with finance team for business validation
2. Review with compliance team for tax regulation accuracy
3. Generate implementation plan with task breakdown
4. Create test scenarios covering all 45 functional requirements
5. Begin Phase 1: Database Foundation (utils_regions, utils_countrys, utils_country_region)

**Command to generate implementation plan:**
```
/plan specs/spec-2025-10-06-121922.md
```